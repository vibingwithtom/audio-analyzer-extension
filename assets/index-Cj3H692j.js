(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();class v{constructor(){this.audioContext=null,this.audioBuffer=null}async analyzeFile(e){const t=await e.arrayBuffer();if(e.name.toLowerCase().endsWith(".wav")){const s=new DataView(t),n=this.parseWavHeaders(s);let i=this.getFileType(e.name);return i==="WAV"&&(n.audioFormat===1?i="WAV (PCM)":typeof n.audioFormat=="number"?i=`WAV (Compressed - Format ${n.audioFormat})`:i="WAV (Unknown Format)"),{fileType:i,sampleRate:n.sampleRate,channels:n.channels,bitDepth:n.bitDepth,duration:n.duration,fileSize:e.size}}this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext));try{return this.audioBuffer=await this.audioContext.decodeAudioData(t),{fileType:this.getFileType(e.name),sampleRate:this.audioBuffer.sampleRate,channels:this.audioBuffer.numberOfChannels,duration:this.audioBuffer.duration,fileSize:e.size,bitDepth:this.estimateBitDepth(t,e.name)}}catch{return await this.analyzeFileHeaders(t,e.name,e.size)}}async analyzeFileHeaders(e,t,s){const n=new DataView(e),i={fileType:this.getFileType(t),fileSize:s};if(t.toLowerCase().endsWith(".wav")){const a=this.parseWavHeaders(n);Object.assign(i,a)}else i.sampleRate="Unknown",i.bitDepth="Unknown",i.channels="Unknown",i.duration="Unknown";return i}parseWavHeaders(e){try{if(String.fromCharCode(e.getUint8(0),e.getUint8(1),e.getUint8(2),e.getUint8(3))!=="RIFF")throw new Error("Not a valid WAV file");if(String.fromCharCode(e.getUint8(8),e.getUint8(9),e.getUint8(10),e.getUint8(11))!=="WAVE")throw new Error("Not a valid WAV file");let n=12;for(;n<e.byteLength-8;){const i=String.fromCharCode(e.getUint8(n),e.getUint8(n+1),e.getUint8(n+2),e.getUint8(n+3)),a=e.getUint32(n+4,!0);if(i==="fmt "){const o=e.getUint16(n+8,!0),r=e.getUint16(n+10,!0),l=e.getUint32(n+12,!0),u=e.getUint16(n+22,!0),d=this.calculateWavDuration(e,l,r,u);return{sampleRate:l,channels:r,bitDepth:u,duration:d,audioFormat:o}}n+=8+a}throw new Error("fmt chunk not found")}catch(t){return console.error("Error parsing WAV headers:",t),{sampleRate:"Unknown",channels:"Unknown",bitDepth:"Unknown",duration:"Unknown",audioFormat:"Unknown"}}}calculateWavDuration(e,t,s,n){try{let i=12;for(;i<e.byteLength-8;){const a=String.fromCharCode(e.getUint8(i),e.getUint8(i+1),e.getUint8(i+2),e.getUint8(i+3)),o=e.getUint32(i+4,!0);if(a==="data"){const r=n/8;return o/(s*r)/t}i+=8+o}return"Unknown"}catch{return"Unknown"}}getFileType(e){const t=e.split(".").pop().toLowerCase();return{wav:"WAV",mp3:"MP3",flac:"FLAC",aac:"AAC",m4a:"M4A",ogg:"OGG",webm:"WebM"}[t]||t.toUpperCase()}estimateBitDepth(e,t){if(t.toLowerCase().endsWith(".wav"))return"See WAV analysis";const s=t.split(".").pop().toLowerCase();return["mp3","aac","m4a"].includes(s)?"Compressed (variable)":"Unknown"}}class w{static matchesFileType(e,t){const s={matches:!1,status:"fail"};if(e===t)return s.matches=!0,s.status="pass",s;if(t==="wav"||t==="WAV")return e==="WAV (PCM)"?(s.matches=!0,s.status="pass",s):(e.startsWith("WAV")&&(s.matches=!0,s.status="warning"),s);const n=e.replace(/\s*\(.*\)/,"").trim(),i=t.toUpperCase();return n===i&&(s.matches=!0,s.status="pass"),s}static validateResults(e,t){const s={};if(t.sampleRate){const o=parseInt(t.sampleRate),r=e.sampleRate;let l="fail";r===o?l="pass":r>o&&(l="warning"),s.sampleRate={matches:r>=o,target:o,actual:r,status:l}}if(t.bitDepth){const o=parseInt(t.bitDepth),r=e.bitDepth;let l="fail";r===o?l="pass":r>o&&(l="warning"),s.bitDepth={matches:r>=o,target:o,actual:r,status:l}}if(t.channels){const o=parseInt(t.channels),r=e.channels===o;s.channels={matches:r,target:o,actual:e.channels,status:r?"pass":"fail"}}if(t.fileType){const o=this.matchesFileType(e.fileType,t.fileType);s.fileType={matches:o.matches,target:t.fileType,actual:e.fileType,status:o.status}}const n=e.duration;let i="fail",a=!1;return n>=120?(i="pass",a=!0):n>=60&&(i="warning",a=!1),s.duration={matches:a,target:"2+ minutes",actual:n,status:i},s}static formatDuration(e){const t=Math.floor(e/3600),s=Math.floor(e%3600/60),n=Math.floor(e%60);return t>0?`${t}h:${s.toString().padStart(2,"0")}m:${n.toString().padStart(2,"0")}s`:`${s}m:${n.toString().padStart(2,"0")}s`}static formatDisplayText(e){const t={};return t.fileType=e.fileType,t.sampleRate=typeof e.sampleRate=="number"?`${(e.sampleRate/1e3).toFixed(1)} kHz`:e.sampleRate,t.bitDepth=typeof e.bitDepth=="number"?`${e.bitDepth}-bit`:e.bitDepth,t.channels=typeof e.channels=="number"?`${e.channels} channel${e.channels!==1?"s":""}${e.channels===1?" (Mono)":e.channels===2?" (Stereo)":""}`:e.channels,t.duration=typeof e.duration=="number"?this.formatDuration(e.duration):e.duration,t.fileSize=`${(e.fileSize/1024/1024).toFixed(2)} MB`,t}static formatAdvancedResults(e){const t={};return t.peakLevel=e.peakDb===-1/0?"Silent":`${e.peakDb.toFixed(1)} dB`,t.peakStatus=e.peakDb<=-6?"pass":e.peakDb<=-3?"warning":"fail",t.noiseFloor=e.noiseFloorDb===-1/0?"Silent":`${e.noiseFloorDb.toFixed(1)} dB`,t.noiseStatus=e.noiseFloorDb<=-60?"pass":"fail",t.normalization=e.normalizationStatus.message,t.normalizationStatus=e.normalizationStatus.status==="normalized"?"pass":"fail",t}}class S{constructor(){this.analysisInProgress=!1}async analyzeAudioBuffer(e,t=null){e.sampleRate;const s=e.numberOfChannels,n=e.length,i=[];for(let a=0;a<s;a++)i.push(e.getChannelData(a));this.analysisInProgress=!0;try{t&&t("Analyzing peak levels...",0);let a=0;for(let u=0;u<s;u++){const d=i[u];for(let c=0;c<n;c++){if(!this.analysisInProgress)throw new Error("Analysis cancelled");const g=Math.abs(d[c]);if(g>a&&(a=g),c%1e4===0){const y=(u*n+c)/(s*n)*.5;t&&t("Analyzing peak levels...",y),c%1e5===0&&await new Promise(f=>setTimeout(f,1))}}}const o=a>0?20*Math.log10(a):-1/0;t&&t("Analyzing noise floor...",.5);const r=await this.analyzeNoiseFloor(i,s,n,t);t&&t("Checking normalization...",.9);const l=this.checkNormalization(o);return t&&t("Analysis complete!",1),{peakDb:o,noiseFloorDb:r,normalizationStatus:l}}finally{this.analysisInProgress=!1}}async analyzeNoiseFloor(e,t,s,n){const i=Math.floor(s/100),a=[];for(let d=0;d<t;d++){const c=e[d];for(let g=0;g<s-i;g+=i){let y=0;for(let p=g;p<g+i&&p<s;p++)y+=c[p]*c[p];const f=Math.sqrt(y/i);a.push(f)}}a.sort((d,c)=>d-c);const o=Math.floor(a.length*.2),r=a.slice(0,o),l=r.reduce((d,c)=>d+c,0)/r.length;return l>0?20*Math.log10(l):-1/0}checkNormalization(e){return Math.abs(e- -6)<=.1?{status:"normalized",message:"Properly normalized to -6dB"}:e>-6?{status:"too_loud",message:`Too loud: ${e.toFixed(1)}dB (target: -6dB)`}:{status:"too_quiet",message:`Too quiet: ${e.toFixed(1)}dB (target: -6dB)`}}cancelAnalysis(){this.analysisInProgress=!1}}const I=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",A=I?"http://localhost:3000":"https://audio-analyzer.tinytech.site",m={CLIENT_ID:"708688597317-bmmrje6hqg8vo52nctned54m32q8uhsr.apps.googleusercontent.com",REDIRECT_URI:A,SCOPE:"https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email",DISCOVERY_DOCS:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]};class E{constructor(){this.isInitialized=!1,this.accessToken=null,this.codeClient=null,this.userInfo=null}async init(){if(!this.isInitialized)return new Promise((e,t)=>{this.loadGoogleAPI().then(()=>{this.initializeGIS().then(e).catch(t)}).catch(t)})}async loadGoogleAPI(){return new Promise((e,t)=>{if(window.gapi){e();return}const s=document.createElement("script");s.src="https://apis.google.com/js/api.js",s.onload=()=>e(),s.onerror=()=>t(new Error("Failed to load Google API script")),document.head.appendChild(s)})}async initializeGIS(){return new Promise((e,t)=>{const s=document.createElement("script");s.src="https://accounts.google.com/gsi/client",s.onload=()=>{this.setupGIS().then(e).catch(t)},s.onerror=()=>t(new Error("Failed to load Google Identity Services")),document.head.appendChild(s)})}async setupGIS(){return new Promise((e,t)=>{const s=setTimeout(()=>{t(new Error("Google API setup timeout"))},1e4);window.gapi.load("client",async()=>{try{clearTimeout(s),await window.gapi.client.init({discoveryDocs:m.DISCOVERY_DOCS}),this.codeClient=window.google.accounts.oauth2.initCodeClient({client_id:m.CLIENT_ID,scope:m.SCOPE,ux_mode:"popup",callback:n=>{if(n.error){console.error("Auth code response error:",n),t(new Error(`Google sign-in failed: ${n.error}`));return}this.exchangeCodeForToken(n.code).then(e).catch(t)}}),this.isInitialized=!0,e()}catch(n){clearTimeout(s),console.error("Google API setup error:",n);let i="Unknown setup error";n&&typeof n=="object"?i=n.message||n.error||n.details||JSON.stringify(n):n&&(i=n.toString()),t(new Error(`Failed to setup Google API: ${i}`))}})})}async exchangeCodeForToken(e){const t="https://oauth2.googleapis.com/token",s={code:e,client_id:m.CLIENT_ID,redirect_uri:m.REDIRECT_URI,grant_type:"authorization_code"};try{const n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(s)});if(!n.ok){const o=await n.json();throw new Error(`Token exchange failed: ${o.error_description||n.status}`)}const i=await n.json();this.accessToken=i.access_token;const a={access_token:i.access_token,expires_at:Date.now()+i.expires_in*1e3,scope:i.scope};return localStorage.setItem("google_token",JSON.stringify(a)),a}catch(n){throw console.error("Token exchange error:",n),new Error(`Token exchange failed: ${n.message}`)}}async signIn(){return this.isInitialized||await this.init(),new Promise((e,t)=>{try{this.codeClient.callback=s=>{if(s.error){console.error("Auth code response error:",s),t(new Error(`Google sign-in failed: ${s.error}`));return}this.exchangeCodeForToken(s.code).then(e).catch(t)},this.codeClient.requestCode()}catch(s){console.error("Google sign-in error:",s);let n="Unknown sign-in error";s&&typeof s=="object"?n=s.error||s.message||s.details||JSON.stringify(s):s&&(n=s.toString()),t(new Error(`Google sign-in failed: ${n}`))}})}async getValidToken(){const e=localStorage.getItem("google_token");if(e)try{const t=JSON.parse(e);if(t.expires_at>Date.now()+3e5)return this.accessToken=t.access_token,t}catch(t){console.warn("Invalid stored token:",t),localStorage.removeItem("google_token")}return await this.signIn()}async downloadFile(e){const t=await this.getValidToken();try{const s=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?fields=name,mimeType,size`,{headers:{Authorization:`Bearer ${t.access_token}`}});if(!s.ok)throw new Error(`Failed to get file metadata: ${s.status}`);const n=await s.json(),i=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:{Authorization:`Bearer ${t.access_token}`}});if(!i.ok)throw new Error(`Failed to download file: ${i.status}`);const a=await i.blob();return new File([a],n.name,{type:n.mimeType||"audio/mpeg"})}catch(s){throw new Error(`Google Drive download failed: ${s.message}`)}}signOut(){this.accessToken&&window.google&&window.google.accounts.oauth2.revoke(this.accessToken),this.accessToken=null,localStorage.removeItem("google_token")}isSignedIn(){const e=localStorage.getItem("google_token");if(!e)return!1;try{return JSON.parse(e).expires_at>Date.now()}catch{return!1}}}class F{constructor(){this.audioAnalyzer=new v,this.levelAnalyzer=new S}async analyzeFile(e){return await this.audioAnalyzer.analyzeFile(e)}async analyzeAdvanced(e,t){return await this.levelAnalyzer.analyzeAudioBuffer(e,t)}validateCriteria(e,t){return w.validateResults(e,t)}formatResults(e){return w.formatDisplayText(e)}formatAdvancedResults(e){return w.formatAdvancedResults(e)}cancelAdvancedAnalysis(){this.levelAnalyzer.cancelAnalysis()}}class b{constructor(){this.engine=new F,this.googleAuth=new E,this.currentFile=null,this.audioBuffer=null,this.isAnalyzing=!1,this.currentResults=null,this.processingFile=!1,this.initializeElements(),this.attachEventListeners(),this.loadSettings()}initializeElements(){this.tabButtons=document.querySelectorAll(".tab-button"),this.tabContents=document.querySelectorAll(".tab-content"),this.dropZone=document.getElementById("dropZone"),this.browseBtn=document.getElementById("browseBtn"),this.fileInput=document.getElementById("fileInput"),this.driveUrl=document.getElementById("driveUrl"),this.analyzeUrl=document.getElementById("analyzeUrl"),this.authText=document.getElementById("authText"),this.signInBtn=document.getElementById("signInBtn"),this.signOutBtn=document.getElementById("signOutBtn"),this.presetSelector=document.getElementById("presetSelector"),this.targetFileType=document.getElementById("targetFileType"),this.targetSampleRate=document.getElementById("targetSampleRate"),this.targetBitDepth=document.getElementById("targetBitDepth"),this.targetChannels=document.getElementById("targetChannels"),this.playerSection=document.getElementById("playerSection"),this.resultsSection=document.getElementById("resultsSection"),this.advancedResultsSection=document.getElementById("advancedResultsSection"),this.audioPlayer=document.getElementById("audioPlayer"),this.playPause=document.getElementById("playPause"),this.advancedAnalysisBtn=document.getElementById("advancedAnalysisBtn"),this.advancedProgress=document.getElementById("advancedProgress"),this.progressFill=document.getElementById("progressFill"),this.progressText=document.getElementById("progressText"),this.cancelAnalysis=document.getElementById("cancelAnalysis"),this.loading=document.getElementById("loading"),this.error=document.getElementById("error"),this.errorMessage=document.getElementById("errorMessage")}attachEventListeners(){this.tabButtons.forEach(e=>{e.addEventListener("click",()=>this.switchTab(e.dataset.tab))}),this.browseBtn.addEventListener("click",e=>{e.stopPropagation(),this.fileInput.value="",this.fileInput.click()}),this.fileInput.addEventListener("change",e=>{e.target.files[0]&&this.handleFileSelect(e.target.files[0])}),this.dropZone.addEventListener("dragover",e=>{e.preventDefault(),this.dropZone.classList.add("drag-over")}),this.dropZone.addEventListener("dragleave",()=>{this.dropZone.classList.remove("drag-over")}),this.dropZone.addEventListener("drop",e=>{e.preventDefault(),this.dropZone.classList.remove("drag-over");const t=e.dataTransfer.files[0];t&&t.type.startsWith("audio/")&&this.handleFileSelect(t)}),this.dropZone.addEventListener("click",()=>this.fileInput.click()),this.analyzeUrl.addEventListener("click",()=>this.handleGoogleDriveUrl()),this.driveUrl.addEventListener("keypress",e=>{e.key==="Enter"&&this.handleGoogleDriveUrl()}),this.signInBtn.addEventListener("click",()=>this.handleSignIn()),this.signOutBtn.addEventListener("click",()=>this.handleSignOut()),this.presetSelector.addEventListener("change",()=>this.handlePresetChange()),[this.targetFileType,this.targetSampleRate,this.targetBitDepth,this.targetChannels].forEach(e=>{e.addEventListener("change",()=>this.saveCriteria())}),this.playPause.addEventListener("click",()=>this.togglePlayback()),this.audioPlayer.addEventListener("loadedmetadata",()=>{this.playPause.textContent="Play"}),this.advancedAnalysisBtn.addEventListener("click",()=>this.runAdvancedAnalysis()),this.cancelAnalysis.addEventListener("click",()=>this.cancelAdvancedAnalysis())}loadSettings(){const e=localStorage.getItem("audio-analyzer-settings");if(e)try{const s=JSON.parse(e);if(s.criteria){this.targetFileType.value=s.criteria.fileType||"",this.targetSampleRate.value=s.criteria.sampleRate||"";const n=s.criteria.bitDepth;this.targetBitDepth.value=Array.isArray(n)?n[0]||"":n||"",this.targetChannels.value=s.criteria.channels||""}}catch(s){console.warn("Failed to load settings from localStorage:",s)}const t=localStorage.getItem("audio-analyzer-selected-preset");t?(this.presetSelector.value=t,this.handlePresetChange()):(this.presetSelector.value="auditions",this.handlePresetChange()),this.updateAuthStatus()}updateAuthStatus(){if(this.googleAuth.isSignedIn()){const t=this.googleAuth.getUserInfo();t&&t.name?this.authText.textContent=`✓ Signed in as ${t.name}`:this.authText.textContent="✓ Signed in to Google Drive",this.signInBtn.style.display="none",this.signOutBtn.style.display="inline-block"}else this.authText.textContent="Not signed in to Google",this.signInBtn.style.display="inline-block",this.signOutBtn.style.display="none"}async handleSignIn(){try{await this.googleAuth.signIn(),this.updateAuthStatus()}catch(e){console.error("Sign-in failed:",e),this.showError(`Google sign-in failed: ${e.message}`)}}handleSignOut(){this.googleAuth.signOut(),this.updateAuthStatus()}saveCriteria(){const t={criteria:{fileType:this.targetFileType.value,sampleRate:this.targetSampleRate.value,bitDepth:this.targetBitDepth.value,channels:this.targetChannels.value}};localStorage.setItem("audio-analyzer-settings",JSON.stringify(t)),this.currentResults&&this.validateAndDisplayResults(this.currentResults)}getPresetConfigurations(){return{auditions:{name:"Auditions",fileType:"wav",sampleRate:"48000",bitDepth:"24",channels:"1"},"character-recordings":{name:"Character Recordings",fileType:"wav",sampleRate:"48000",bitDepth:"24",channels:"1"},custom:{name:"Custom"},"p2b2-pairs":{name:"P2B2 Pairs",fileType:"wav",sampleRate:"48000",bitDepth:"16",channels:"2"},"three-hour":{name:"Three Hour",fileType:"wav",sampleRate:"48000",bitDepth:"24",channels:""}}}handlePresetChange(){const e=this.presetSelector.value,t=document.getElementById("customCriteriaSection");if(e){if(e==="custom")t.style.display="block";else{t.style.display="none";const n=this.getPresetConfigurations()[e];n&&(this.targetFileType.value=n.fileType||"",this.targetSampleRate.value=n.sampleRate||"",this.targetBitDepth.value=n.bitDepth||"",this.targetChannels.value=n.channels||"",this.saveCriteria(),this.currentResults&&this.validateAndDisplayResults(this.currentResults))}localStorage.setItem("audio-analyzer-selected-preset",e)}}switchTab(e){this.tabButtons.forEach(t=>t.classList.remove("active")),this.tabContents.forEach(t=>t.classList.remove("active")),document.querySelector(`[data-tab="${e}"]`).classList.add("active"),document.querySelector(`.tab-content[data-tab="${e}"]`).classList.add("active")}async handleFileSelect(e){if(console.log("handleFileSelect called with:",e),!e){console.log("No file provided to handleFileSelect");return}if(this.processingFile){console.log("Already processing a file, ignoring duplicate call");return}this.processingFile=!0,console.log("Starting file processing..."),this.cleanupForNewFile(),this.currentFile=e,console.log("Showing loading screen..."),this.showLoading();try{console.log("Starting analysis with core engine...");const t=await this.engine.analyzeFile(e);console.log("Analysis results:",t),this.currentResults=t,console.log("Setting up audio player..."),this.setupAudioPlayer(e),console.log("Validating and displaying results..."),this.validateAndDisplayResults(t),this.showResults(),console.log("Results displayed successfully")}catch(t){console.error("Analysis error:",t),this.showError(`Failed to analyze file: ${t.message}`),this.cleanupForNewFile()}finally{this.processingFile=!1,console.log("File processing completed")}}async handleGoogleDriveUrl(){const e=this.driveUrl.value.trim();if(e){if(this.processingFile){console.log("Already processing a file, ignoring Google Drive request");return}this.processingFile=!0,this.cleanupForNewFile(),this.showLoading();try{const t=this.extractFileIdFromUrl(e);if(!t)throw new Error("Invalid Google Drive URL. Please ensure it's a valid Drive file link.");const s=await this.googleAuth.downloadFile(t);this.currentFile=s,this.updateAuthStatus();const n=await this.engine.analyzeFile(s);this.currentResults=n,this.setupAudioPlayer(s),this.validateAndDisplayResults(n),this.showResults()}catch(t){console.error("Google Drive error:",t),this.cleanupForNewFile(),t.message.includes("sign-in")||t.message.includes("auth")?this.showError('Please sign in to Google to access Drive files. Click "Analyze" to authenticate.'):this.showError(`Failed to process Google Drive file: ${t.message}`)}finally{this.processingFile=!1}}}extractFileIdFromUrl(e){const t=[/\/file\/d\/([a-zA-Z0-9-_]+)/,/[?&]id=([a-zA-Z0-9-_]+)/,/^([a-zA-Z0-9-_]+)$/];for(const s of t){const n=e.match(s);if(n)return n[1]}return null}setupAudioPlayer(e){const t=URL.createObjectURL(e);this.audioPlayer.src=t,this.audioPlayer.load(),this.playerSection.style.display="block"}togglePlayback(){this.audioPlayer.paused?(this.audioPlayer.play(),this.playPause.textContent="Pause"):(this.audioPlayer.pause(),this.playPause.textContent="Play")}validateAndDisplayResults(e){const t={fileType:this.targetFileType.value,sampleRate:this.targetSampleRate.value,bitDepth:this.targetBitDepth.value,channels:this.targetChannels.value},s=this.engine.validateCriteria(e,t),n=this.engine.formatResults(e);document.getElementById("fileName").textContent=this.currentFile.name,document.getElementById("fileType").textContent=n.fileType,document.getElementById("sampleRate").textContent=n.sampleRate,document.getElementById("bitDepth").textContent=n.bitDepth,document.getElementById("channels").textContent=n.channels,document.getElementById("duration").textContent=n.duration,document.getElementById("fileSize").textContent=n.fileSize,this.applyValidationStyling(s)}applyValidationStyling(e){const t={fileType:document.getElementById("fileTypeRow"),sampleRate:document.getElementById("sampleRateRow"),bitDepth:document.getElementById("bitDepthRow"),channels:document.getElementById("channelsRow"),duration:document.getElementById("durationRow")};Object.entries(e).forEach(([s,n])=>{const i=t[s];i&&(i.classList.remove("pass","fail","warning","unknown"),i.classList.add(n.status))})}async runAdvancedAnalysis(){if(!this.audioBuffer&&this.currentFile)try{const e=await this.currentFile.arrayBuffer(),t=new(window.AudioContext||window.webkitAudioContext);this.audioBuffer=await t.decodeAudioData(e)}catch(e){this.showError(`Failed to decode audio: ${e.message}`);return}if(!this.audioBuffer){this.showError("No audio data available for analysis");return}this.isAnalyzing=!0,this.advancedAnalysisBtn.style.display="none",this.advancedProgress.style.display="block";try{const e=await this.engine.analyzeAdvanced(this.audioBuffer,(t,s)=>{this.progressText.textContent=t,this.progressFill.style.width=`${s*100}%`});document.getElementById("peakLevel").textContent=e.peakDb===-1/0?"-∞ dB":`${e.peakDb.toFixed(1)} dB`,document.getElementById("noiseFloor").textContent=e.noiseFloorDb===-1/0?"-∞ dB":`${e.noiseFloorDb.toFixed(1)} dB`,document.getElementById("normalization").textContent=e.normalizationStatus.message,this.advancedResultsSection.style.display="block"}catch(e){e.message!=="Analysis cancelled"&&(console.error("Advanced analysis error:",e),this.showError(`Advanced analysis failed: ${e.message}`))}finally{this.isAnalyzing=!1,this.advancedProgress.style.display="none",this.advancedAnalysisBtn.style.display="block"}}cancelAdvancedAnalysis(){this.engine.cancelAdvancedAnalysis(),this.isAnalyzing=!1,this.advancedProgress.style.display="none",this.advancedAnalysisBtn.style.display="block"}showLoading(){this.hideAllSections(),this.loading.style.display="block"}showResults(){this.hideAllSections(),this.resultsSection.style.display="block"}showError(e){this.hideAllSections(),this.errorMessage.textContent=e,this.error.style.display="block"}cleanupForNewFile(){this.currentFile&&(this.currentFile=null),this.audioBuffer&&(this.audioBuffer=null),this.currentResults&&(this.currentResults=null),this.audioPlayer&&this.audioPlayer.src&&(this.audioPlayer.src.startsWith("blob:")&&URL.revokeObjectURL(this.audioPlayer.src),this.audioPlayer.src="")}cleanup(){this.cleanupForNewFile(),this.engine.audioAnalyzer.audioContext,window.gc&&typeof window.gc=="function"&&window.gc()}hideAllSections(){this.loading.style.display="none",this.error.style.display="none",this.resultsSection.style.display="none",this.advancedResultsSection.style.display="none"}}document.addEventListener("DOMContentLoaded",()=>{const h=new b;window.addEventListener("beforeunload",()=>{h.cleanup()}),document.addEventListener("visibilitychange",()=>{document.hidden&&h.cleanup()})});
