(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function a(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();class _{constructor(){this.audioContext=null,this.audioBuffer=null}async analyzeFile(e){const t=await e.arrayBuffer();if(e.name.toLowerCase().endsWith(".wav")){const a=new DataView(t),i=this.parseWavHeaders(a);let n=this.getFileType(e.name);return n==="WAV"&&(i.audioFormat===1?n="WAV (PCM)":typeof i.audioFormat=="number"?n=`WAV (Compressed - Format ${i.audioFormat})`:n="WAV (Unknown Format)"),{fileType:n,sampleRate:i.sampleRate,channels:i.channels,bitDepth:i.bitDepth,duration:i.duration,fileSize:e.size}}this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext));try{const a=t.slice(0);return this.audioBuffer=await this.audioContext.decodeAudioData(a),{fileType:this.getFileType(e.name),sampleRate:this.audioBuffer.sampleRate,channels:this.audioBuffer.numberOfChannels,duration:this.audioBuffer.duration,fileSize:e.size,bitDepth:this.estimateBitDepth(t,e.name)}}catch{return await this.analyzeFileHeaders(t,e.name,e.size)}}async analyzeFileHeaders(e,t,a){const i=new DataView(e),n={fileType:this.getFileType(t),fileSize:a};if(t.toLowerCase().endsWith(".wav")){const s=this.parseWavHeaders(i);Object.assign(n,s)}else n.sampleRate="Unknown",n.bitDepth="Unknown",n.channels="Unknown",n.duration="Unknown";return n}parseWavHeaders(e){try{if(String.fromCharCode(e.getUint8(0),e.getUint8(1),e.getUint8(2),e.getUint8(3))!=="RIFF")throw new Error("Not a valid WAV file");if(String.fromCharCode(e.getUint8(8),e.getUint8(9),e.getUint8(10),e.getUint8(11))!=="WAVE")throw new Error("Not a valid WAV file");let i=12;for(;i<e.byteLength-8;){const n=String.fromCharCode(e.getUint8(i),e.getUint8(i+1),e.getUint8(i+2),e.getUint8(i+3)),s=e.getUint32(i+4,!0);if(n==="fmt "){const o=e.getUint16(i+8,!0),d=e.getUint16(i+10,!0),l=e.getUint32(i+12,!0),c=e.getUint16(i+22,!0),u=this.calculateWavDuration(e,l,d,c);return{sampleRate:l,channels:d,bitDepth:c,duration:u,audioFormat:o}}i+=8+s}throw new Error("fmt chunk not found")}catch(t){return console.error("Error parsing WAV headers:",t),{sampleRate:"Unknown",channels:"Unknown",bitDepth:"Unknown",duration:"Unknown",audioFormat:"Unknown"}}}calculateWavDuration(e,t,a,i){try{let n=12;for(;n<e.byteLength-8;){const s=String.fromCharCode(e.getUint8(n),e.getUint8(n+1),e.getUint8(n+2),e.getUint8(n+3)),o=e.getUint32(n+4,!0);if(s==="data"){const d=i/8;return o/(a*d)/t}n+=8+o}return"Unknown"}catch{return"Unknown"}}getFileType(e){const t=e.split(".").pop().toLowerCase();return{wav:"WAV",mp3:"MP3",flac:"FLAC",aac:"AAC",m4a:"M4A",ogg:"OGG",webm:"WebM"}[t]||t.toUpperCase()}estimateBitDepth(e,t){if(t.toLowerCase().endsWith(".wav"))return"See WAV analysis";const a=t.split(".").pop().toLowerCase();return["mp3","aac","m4a"].includes(a)?"Compressed (variable)":"Unknown"}}class V{static matchesFileType(e,t){const a={matches:!1,status:"fail"};if(e===t)return a.matches=!0,a.status="pass",a;if(t==="wav"||t==="WAV")return e==="WAV (PCM)"||e==="WAV"?(a.matches=!0,a.status="pass",a):(e.startsWith("WAV")&&(a.matches=!0,a.status="warning"),a);const i=e.replace(/\s*\(.*\)/,"").trim(),n=t.toUpperCase();return i===n&&(a.matches=!0,a.status="pass"),a}static validateResults(e,t,a=!1){const i={},n=o=>o?Array.isArray(o)?o:[o]:[],s=n(t.fileType);if(s.length>0){let o={matches:!1,status:"fail"};for(const d of s){const l=this.matchesFileType(e.fileType,d);if(l.status==="pass"){o=l;break}else l.status==="warning"&&o.status==="fail"&&(o=l)}i.fileType={matches:o.matches,target:s,actual:e.fileType,status:o.status}}if(!a){const o=n(t.sampleRate).map(c=>parseInt(c)).filter(c=>!isNaN(c));if(o.length>0){const c=e.sampleRate;let u,h;c==="Unknown"||typeof c!="number"?(h=!1,u="warning"):(h=o.includes(c),u=h?"pass":"fail"),i.sampleRate={matches:h,target:o,actual:c,status:u}}const d=n(t.bitDepth).map(c=>parseInt(c)).filter(c=>!isNaN(c));if(d.length>0){const c=e.bitDepth;let u,h;c==="Unknown"||typeof c!="number"?(h=!1,u="warning"):(h=d.includes(c),u=h?"pass":"fail"),i.bitDepth={matches:h,target:d,actual:c,status:u}}const l=n(t.channels).map(c=>parseInt(c)).filter(c=>!isNaN(c));if(l.length>0){const c=e.channels;let u,h;c==="Unknown"||typeof c!="number"?(h=!1,u="warning"):(h=l.includes(c),u=h?"pass":"fail"),i.channels={matches:h,target:l,actual:c,status:u}}if(t.minDuration){const c=parseInt(t.minDuration),u=e.duration;let h,m;u==="Unknown"||typeof u!="number"?(m=!1,h="warning"):(m=u>=c,h=m?"pass":"fail"),i.duration={matches:m,target:`${c}s minimum`,actual:u,status:h}}}return i}static formatDuration(e){const t=Math.floor(e/3600),a=Math.floor(e%3600/60),i=Math.floor(e%60);return t>0?`${t}h:${a.toString().padStart(2,"0")}m:${i.toString().padStart(2,"0")}s`:`${a}m:${i.toString().padStart(2,"0")}s`}static formatDisplayText(e){const t={};return t.fileType=e.fileType,t.sampleRate=typeof e.sampleRate=="number"?`${(e.sampleRate/1e3).toFixed(1)} kHz`:e.sampleRate,t.bitDepth=typeof e.bitDepth=="number"?`${e.bitDepth}-bit`:e.bitDepth,t.channels=typeof e.channels=="number"?`${e.channels}${e.channels===1?" (Mono)":e.channels===2?" (Stereo)":""}`:e.channels,t.duration=typeof e.duration=="number"?this.formatDuration(e.duration):e.duration,t.fileSize=`${(e.fileSize/1024/1024).toFixed(2)} MB`,t}static formatAdvancedResults(e){const t={};return t.peakLevel=e.peakDb===-1/0?"Silent":`${e.peakDb.toFixed(1)} dB`,t.peakStatus=e.peakDb<=-6?"pass":e.peakDb<=-3?"warning":"fail",t.noiseFloor=e.noiseFloorDb===-1/0?"Silent":`${e.noiseFloorDb.toFixed(1)} dB`,t.noiseStatus=e.noiseFloorDb<=-60?"pass":"fail",t.normalization=e.normalizationStatus.message,t.normalizationStatus=e.normalizationStatus.status==="normalized"?"pass":"fail",t}}class H{constructor(){this.analysisInProgress=!1}async analyzeAudioBuffer(e,t=null){const a=e.sampleRate,i=e.numberOfChannels,n=e.length,s=[];for(let o=0;o<i;o++)s.push(e.getChannelData(o));this.analysisInProgress=!0;try{t&&t("Analyzing peak levels...",0);let o=0;for(let f=0;f<i;f++){const y=s[f];for(let p=0;p<n;p++){if(!this.analysisInProgress)throw new Error("Analysis cancelled");const F=Math.abs(y[p]);if(F>o&&(o=F),p%1e4===0){const x=(f*n+p)/(i*n)*.5;t&&t("Analyzing peak levels...",x),p%1e5===0&&await new Promise(v=>setTimeout(v,1))}}}const d=o>0?20*Math.log10(o):-1/0;t&&t("Analyzing noise floor...",.5);const l=await this.analyzeNoiseFloor(s,i,n,t),c=await this.analyzeNoiseFloorHistogram(s,i,n);t&&t("Checking normalization...",.9);const u=this.checkNormalization(d);t&&t("Estimating reverb...",.95);const h=await this.estimateReverb(s,i,n,a,c),m=this.interpretReverb(h);t&&t("Analyzing silence...",.98);const{leadingSilence:r,trailingSilence:b,longestSilence:g}=this.analyzeSilence(s,i,n,a,c,d);return t&&t("Analysis complete!",1),{peakDb:d,noiseFloorDb:l,noiseFloorDbHistogram:c,normalizationStatus:u,reverbInfo:m,leadingSilence:r,trailingSilence:b,longestSilence:g}}finally{this.analysisInProgress=!1}}interpretReverb(e){return e<=0?{time:e,label:"N/A",description:"No reverb detected."}:e<.3?{time:e,label:"Excellent (Dry)",description:"Ideal for voiceover. Matches a vocal booth or well-treated studio environment."}:e<.5?{time:e,label:"Good (Controlled)",description:"A well-controlled room with minimal reflections. Acceptable for most recording."}:e<.8?{time:e,label:"Fair (Slightly Live)",description:"Noticeable room reflections. May reduce clarity for voiceover work."}:e<1.2?{time:e,label:"Poor (Reverberant)",description:"Significant reverb is present, making the recording sound distant and unprofessional."}:{time:e,label:"Very Poor (Echoey)",description:"Excessive echo and reverb. Unsuitable for professional voice recording."}}analyzeSilence(e,t,a,i,n,s){const o=s-n,d=.25,l=Math.max(0,o),c=n+l*d,u=Math.pow(10,c/20),h=50,m=Math.floor(i*(h/1e3)),r=Math.ceil(a/m),g=Math.ceil(150/h),f=new Array(r).fill(0);for(let S=0;S<r;S++){const k=S*m,A=Math.min(k+m,a);let $=0;for(let D=0;D<t;D++){const z=e[D];for(let R=k;R<A;R++){const U=Math.abs(z[R]);U>$&&($=U)}}$>u&&(f[S]=1)}let y=0;for(let S=0;S<r;S++)if(f[S]===1)y++;else{if(y>0&&y<g)for(let k=1;k<=y;k++)f[S-k]=0;y=0}if(y>0&&y<g)for(let S=1;S<=y;S++)f[r-S]=0;let p=0,F=0;for(let S=0;S<r;S++)f[S]===0?F++:(F>p&&(p=F),F=0);F>p&&(p=F);const x=p*(h/1e3),v=f.indexOf(1),w=f.lastIndexOf(1);let B=0,E=0;return v===-1?(B=a/i,E=a/i):(B=v*(h/1e3),E=(r-1-w)*(h/1e3)),{leadingSilence:B,trailingSilence:E,longestSilence:x}}async estimateReverb(e,t,a,i,n){const l=Math.floor(i*.02),c=-25;let u=[];const h=e[0];let m=0;for(let g=0;g<a-1024;g+=1024){let f=0;for(let p=g;p<g+1024;p++)f+=h[p]*h[p];const y=Math.sqrt(f/1024);if(y>m*1.5&&y>.01){let p=0,F=g;for(let v=g;v<g+1024;v++)Math.abs(h[v])>p&&(p=Math.abs(h[v]),F=v);const x=20*Math.log10(p);if(x>n+10){let v=-1;for(let w=F;w<a-l;w+=l){let B=0;for(let k=w;k<w+l;k++)B+=h[k]*h[k];const E=Math.sqrt(B/l);if((E>0?20*Math.log10(E):-120)<x+c){v=w;break}}if(v!==-1){const w=(v-F)/i;if(w>0){const B=w*(60/Math.abs(c));u.push(B)}}}}m=y}if(u.length<1)return 0;u.sort((g,f)=>g-f);const r=Math.floor(u.length/2);return u.length%2!==0?u[r]:(u[r-1]+u[r])/2}async analyzeNoiseFloorHistogram(e,t,a){const n=new Array(100).fill(0),s=-100,o=100,d=Math.floor(44100*.05);for(let h=0;h<t;h++){const m=e[h];for(let r=0;r<a;r+=d){const b=Math.min(r+d,a);let g=0;for(let p=r;p<b;p++)g+=m[p]*m[p];const f=Math.sqrt(g/(b-r)),y=f>0?20*Math.log10(f):s;if(y>=s){const p=Math.min(Math.floor((y-s)/o*100),99);n[p]++}}}let l=-1,c=0;for(let h=0;h<100;h++)n[h]>c&&(c=n[h],l=h);return l===-1?-1/0:l*(o/100)+s}async analyzeNoiseFloor(e,t,a,i){const n=Math.floor(a/100),s=[];for(let u=0;u<t;u++){const h=e[u];for(let m=0;m<a-n;m+=n){let r=0;for(let g=m;g<m+n&&g<a;g++)r+=h[g]*h[g];const b=Math.sqrt(r/n);s.push(b)}}s.sort((u,h)=>u-h);const o=Math.floor(s.length*.2),d=s.slice(0,o),l=d.reduce((u,h)=>u+h,0)/d.length;return l>0?20*Math.log10(l):-1/0}checkNormalization(e){let i,n;return Math.abs(e- -6)<=.1?(i="normalized",n="Properly normalized"):e>-6?(i="too_loud",n="Too loud"):(i="too_quiet",n="Too quiet"),{status:i,message:n,peakDb:e,targetDb:-6}}cancelAnalysis(){this.analysisInProgress=!1}analyzeStereoSeparation(e){if(e.numberOfChannels!==2)return null;const t=e.getChannelData(0),a=e.getChannelData(1),i=e.sampleRate,n=e.length,s=Math.floor(i*.25),o=1.1,d=.001;let l=0,c=0,u=0,h=0,m=0;for(let F=0;F<n;F+=s){let x=0,v=0;const w=Math.min(F+s,n),B=w-F;for(let A=F;A<w;A++)x+=t[A]*t[A],v+=a[A]*a[A];const E=Math.sqrt(x/B),S=Math.sqrt(v/B);if(m++,E<d&&S<d){h++;continue}const k=E/S;k>o?l++:k<1/o?c++:u++}const r=m-h;let b="Undetermined",g=0,f=0,y=0,p=0;return r>0?(p=u/r,f=l/r,y=c/r,p>.9?(b="Mono as Stereo",g=p):f>.1&&y>.1?(b="Conversational Stereo",g=f+y):f>.9?(b="Mono in Left Channel",g=f):y>.9?(b="Mono in Right Channel",g=y):(b="Mixed Stereo",g=1-p)):(b="Silent",g=1),{totalBlocks:m,activeBlocks:r,silentBlocks:h,leftDominantBlocks:l,rightDominantBlocks:c,balancedBlocks:u,stereoType:b,stereoConfidence:Math.min(g,1)}}}class W{async analyzeHeaders(e){const a=await e.slice(0,102400).arrayBuffer(),i=new DataView(a),n={filename:e.name,fileSize:e.size,fileType:this.getFileType(e.name)};if(e.name.toLowerCase().endsWith(".wav")){const s=this.parseWavHeaders(i,e.size);Object.assign(n,s),s.formatType&&(n.fileType=s.formatType)}else e.name.toLowerCase().endsWith(".mp3")?Object.assign(n,this.parseMp3Headers(i,e.size)):e.name.toLowerCase().endsWith(".flac")?Object.assign(n,this.parseFlacHeaders(i,e.size)):(n.sampleRate="Unknown",n.bitDepth="Unknown",n.channels="Unknown",n.duration="Unknown");return n}parseWavHeaders(e,t){try{if(String.fromCharCode(e.getUint8(0),e.getUint8(1),e.getUint8(2),e.getUint8(3))!=="RIFF")throw new Error("Not a valid WAV file");if(String.fromCharCode(e.getUint8(8),e.getUint8(9),e.getUint8(10),e.getUint8(11))!=="WAVE")throw new Error("Not a valid WAV file");let n=12;for(;n<e.byteLength-8;){const s=String.fromCharCode(e.getUint8(n),e.getUint8(n+1),e.getUint8(n+2),e.getUint8(n+3)),o=e.getUint32(n+4,!0);if(s==="fmt "){const d=e.getUint16(n+8,!0),l=e.getUint16(n+10,!0),c=e.getUint32(n+12,!0),u=e.getUint16(n+22,!0),h=e.getUint32(n+16,!0),m=t-44,r=h>0?m/h:"Unknown";return{sampleRate:c,channels:l,bitDepth:u,duration:typeof r=="number"?r:"Unknown",audioFormat:d,formatType:d===1?"WAV (PCM)":`WAV (Format ${d})`}}n+=8+o}throw new Error("fmt chunk not found")}catch{return{sampleRate:"Unknown",channels:"Unknown",bitDepth:"Unknown",duration:"Unknown",formatType:"WAV"}}}parseMp3Headers(e){try{let t=0;for(;t<e.byteLength-4;){if(e.getUint8(t)===255&&(e.getUint8(t+1)&224)===224){const a=e.getUint32(t,!1),i=a>>19&3,n=a>>17&3,s=a>>12&15,o=a>>10&3,d=a>>6&3,l=[44100,48e3,32e3],c=d===3?1:2;return{sampleRate:l[o]||"Unknown",channels:c,bitDepth:"Compressed (variable)",duration:"Unknown"}}t++}throw new Error("No MP3 frame found")}catch{return{sampleRate:"Unknown",channels:"Unknown",bitDepth:"Compressed (variable)",duration:"Unknown"}}}parseFlacHeaders(e){try{if(String.fromCharCode(e.getUint8(0),e.getUint8(1),e.getUint8(2),e.getUint8(3))!=="fLaC")throw new Error("Not a valid FLAC file");const a=e.getUint8(4),i=(a&128)!==0;if((a&127)===0){const s=e.getUint16(5,!1),o=e.getUint16(7,!1),d=e.getUint16(18,!1),l=e.getUint8(20),c=d<<4|l>>4,u=(l>>1&7)+1,h=((l&1)<<4|e.getUint8(21)>>4)+1;return{sampleRate:c,channels:u,bitDepth:h,duration:"Unknown"}}throw new Error("STREAMINFO block not found")}catch{return{sampleRate:"Unknown",channels:"Unknown",bitDepth:"Unknown",duration:"Unknown"}}}getFileType(e){const t=e.split(".").pop().toLowerCase();return{wav:"WAV",mp3:"MP3",flac:"FLAC",aac:"AAC",m4a:"M4A",ogg:"OGG"}[t]||t.toUpperCase()}}class G{constructor(e){this.analyzer=new W,this.validator=e,this.cancelled=!1}async processBatch(e,t,a,i){this.cancelled=!1;const n=[],s=Date.now();for(let o=0;o<e.length&&!this.cancelled;o++){const d=e[o];let l;try{const c=await this.analyzer.analyzeHeaders(d),u=typeof t=="function"?t():t,h=this.validator.validateResults(c,u);l={filename:d.name,file:d,analysis:c,validation:h,status:this.getOverallStatus(h)}}catch(c){l={filename:d.name,file:d,analysis:null,validation:null,status:"error",error:c.message}}n.push(l),i&&i(l),a&&a({current:o+1,total:e.length,currentFile:d.name,percentage:(o+1)/e.length*100,elapsedTime:Date.now()-s})}return n}getOverallStatus(e){const t=Object.values(e).map(a=>a.status);return t.includes("fail")?"fail":t.includes("warning")?"warning":"pass"}cancel(){this.cancelled=!0}}const q=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",j=window.location.pathname.startsWith("/beta"),N=q?"http://localhost:3000":j?"https://audio-analyzer.tinytech.site/beta":"https://audio-analyzer.tinytech.site",M={CLIENT_ID:"708688597317-bmmrje6hqg8vo52nctned54m32q8uhsr.apps.googleusercontent.com",REDIRECT_URI:N,SCOPE:"https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email",DISCOVERY_DOCS:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]},T={CLIENT_ID:"0y78slky3xitt421wmoa0fjdz6fi14hn",REDIRECT_URI:N,AUTHORIZATION_URL:"https://account.box.com/api/oauth2/authorize",TOKEN_URL:"https://api.box.com/oauth2/token",API_URL:"https://api.box.com/2.0",PROXY_URL:"https://box-proxy-708688597317.us-central1.run.app"};class J{constructor(){this.isInitialized=!1,this.accessToken=null,this.codeClient=null,this.userInfo=null}async init(){if(!this.isInitialized)return new Promise((e,t)=>{this.loadGoogleAPI().then(()=>{this.initializeGIS().then(e).catch(t)}).catch(t)})}async loadGoogleAPI(){return new Promise((e,t)=>{if(window.gapi){e();return}const a=document.createElement("script");a.src="https://apis.google.com/js/api.js",a.onload=()=>e(),a.onerror=()=>t(new Error("Failed to load Google API script")),document.head.appendChild(a)})}async initializeGIS(){return new Promise((e,t)=>{const a=document.createElement("script");a.src="https://accounts.google.com/gsi/client",a.onload=()=>{this.setupGIS().then(e).catch(t)},a.onerror=()=>t(new Error("Failed to load Google Identity Services")),document.head.appendChild(a)})}async setupGIS(){return new Promise((e,t)=>{const a=setTimeout(()=>{t(new Error("Google API setup timeout"))},1e4);window.gapi.load("client",async()=>{try{clearTimeout(a),await window.gapi.client.init({discoveryDocs:M.DISCOVERY_DOCS}),this.tokenClient=window.google.accounts.oauth2.initTokenClient({client_id:M.CLIENT_ID,scope:M.SCOPE,callback:i=>{if(i.error){console.error("Token response error:",i),t(new Error(`Google sign-in failed: ${i.error}`));return}this.accessToken=i.access_token;const n={access_token:i.access_token,expires_at:Date.now()+i.expires_in*1e3,scope:i.scope};localStorage.setItem("google_token",JSON.stringify(n)),e(n)}}),this.isInitialized=!0,e()}catch(i){clearTimeout(a),console.error("Google API setup error:",i);let n="Unknown setup error";i&&typeof i=="object"?n=i.message||i.error||i.details||JSON.stringify(i):i&&(n=i.toString()),t(new Error(`Failed to setup Google API: ${n}`))}})})}async signIn(){return this.isInitialized||await this.init(),new Promise((e,t)=>{try{this.tokenClient.callback=a=>{if(a.error){console.error("Token response error:",a),t(new Error(`Google sign-in failed: ${a.error}`));return}if(!(a.scope&&a.scope.includes("https://www.googleapis.com/auth/drive.readonly"))){console.warn("Drive scope not granted, retrying with consent prompt"),this.tokenClient.requestAccessToken({prompt:"consent"});return}this.accessToken=a.access_token;const n={access_token:a.access_token,expires_at:Date.now()+a.expires_in*1e3,scope:a.scope};localStorage.setItem("google_token",JSON.stringify(n)),e(n)},this.tokenClient.requestAccessToken({prompt:""})}catch(a){console.error("Google sign-in error:",a);let i="Unknown sign-in error";a&&typeof a=="object"?i=a.error||a.message||a.details||JSON.stringify(a):a&&(i=a.toString()),t(new Error(`Google sign-in failed: ${i}`))}})}async getValidToken(){const e=localStorage.getItem("google_token");if(e)try{const t=JSON.parse(e);if(t.expires_at>Date.now()+3e5)return this.accessToken=t.access_token,t}catch(t){console.warn("Invalid stored token:",t),localStorage.removeItem("google_token")}return await this.signIn()}async getUserInfo(){const e=await this.getValidToken();try{const t=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${e.access_token}`}});if(!t.ok)throw new Error(`Failed to get user info: ${t.status}`);const a=await t.json();return this.userInfo=a,a}catch(t){throw new Error(`Failed to get user info: ${t.message}`)}}async downloadFile(e){const t=await this.getValidToken();try{const a=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?fields=name,mimeType,size`,{headers:{Authorization:`Bearer ${t.access_token}`}});if(!a.ok)throw a.status===403?(this.signOut(),new Error("Insufficient permissions to access Google Drive. Please sign in again and grant Drive access.")):new Error(`Failed to get file metadata: ${a.status}`);const i=await a.json(),n=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:{Authorization:`Bearer ${t.access_token}`}});if(!n.ok)throw new Error(`Failed to download file: ${n.status}`);const s=await n.blob();return new File([s],i.name,{type:i.mimeType||"audio/mpeg"})}catch(a){throw new Error(`Google Drive download failed: ${a.message}`)}}async listAudioFilesInFolder(e){const t=await this.getValidToken();try{const i=["audio/mpeg","audio/wav","audio/x-wav","audio/wave","audio/flac","audio/x-flac","audio/aac","audio/mp4","audio/ogg","audio/x-m4a"].map(d=>`mimeType='${d}'`).join(" or "),n=`'${e}' in parents and (${i}) and trashed=false`,s=await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(n)}&fields=files(id,name,mimeType,size,modifiedTime,videoMediaMetadata)&pageSize=1000`,{headers:{Authorization:`Bearer ${t.access_token}`}});if(!s.ok)throw s.status===403?(this.signOut(),new Error("Insufficient permissions to access Google Drive folder. Please sign in again.")):new Error(`Failed to list folder contents: ${s.status}`);return(await s.json()).files||[]}catch(a){throw new Error(`Failed to list folder: ${a.message}`)}}async listFilesInFolder(e,t){const a=await this.getValidToken();try{const i=`'${e}' in parents and trashed=false`,n=await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(i)}&fields=files(id,name,mimeType)&pageSize=1000`,{headers:{Authorization:`Bearer ${a.access_token}`}});if(!n.ok)throw n.status===403?(this.signOut(),new Error("Insufficient permissions to access Google Drive folder. Please sign in again.")):new Error(`Failed to list folder contents: ${n.status}`);const o=(await n.json()).files||[];return t?o.filter(d=>d.name.toLowerCase().endsWith(t.toLowerCase())):o}catch(i){throw new Error(`Failed to list folder: ${i.message}`)}}async downloadFileHeaders(e,t=102400){const a=await this.getValidToken();try{const i=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:{Authorization:`Bearer ${a.access_token}`,Range:`bytes=0-${t-1}`}});if(!i.ok&&i.status!==206)throw new Error(`Failed to download file headers: ${i.status}`);return await i.blob()}catch(i){throw new Error(`Failed to download headers: ${i.message}`)}}async getFileMetadata(e){if(e.videoMediaMetadata)return e;const t=await this.getValidToken();try{const a=await fetch(`https://www.googleapis.com/drive/v3/files/${e.id}?fields=name,mimeType,size,modifiedTime,videoMediaMetadata`,{headers:{Authorization:`Bearer ${t.access_token}`}});if(!a.ok)throw a.status===403?(this.signOut(),new Error("Insufficient permissions to access Google Drive. Please sign in again and grant Drive access.")):new Error(`Failed to get file metadata: ${a.status}`);return await a.json()}catch(a){throw new Error(`Google Drive metadata fetch failed: ${a.message}`)}}signOut(){this.accessToken&&window.google&&window.google.accounts.oauth2.revoke(this.accessToken),this.accessToken=null,localStorage.removeItem("google_token")}isSignedIn(){const e=localStorage.getItem("google_token");if(!e)return!1;try{return JSON.parse(e).expires_at>Date.now()}catch{return!1}}}class Z{constructor(){this.isInitialized=!1,this.accessToken=null,this.userInfo=null}async init(){this.isInitialized||(console.log("[Box Auth] Init started at:",new Date().toISOString()),await this.handleOAuthCallback(),console.log("[Box Auth] Init completed at:",new Date().toISOString()),this.isInitialized=!0)}async handleOAuthCallback(){const e=new URLSearchParams(window.location.search);if(e.has("code")){console.log("[Box OAuth] Callback received at:",new Date().toISOString());const t=e.get("code"),a=e.get("state"),i=localStorage.getItem("box_oauth_state");if(!i||i!==a)return console.error("OAuth state mismatch"),!1;console.log("[Box OAuth] State verified, exchanging code at:",new Date().toISOString());try{const n=await fetch(`${T.PROXY_URL}?action=token&code=${encodeURIComponent(t)}`);if(console.log("[Box OAuth] Token exchange response at:",new Date().toISOString(),"Status:",n.status),!n.ok){const d=await n.text();throw console.error("[Box OAuth] Token exchange failed:",d),new Error(`Token exchange failed: ${n.status}`)}const s=await n.json(),o={access_token:s.access_token,refresh_token:s.refresh_token,expires_at:Date.now()+s.expires_in*1e3};return localStorage.setItem("box_token",JSON.stringify(o)),this.accessToken=s.access_token,localStorage.setItem("box_just_authenticated","true"),window.history.replaceState({},document.title,window.location.pathname),!0}catch(n){return console.error("Failed to exchange authorization code:",n),!1}}return!1}async signIn(){this.isInitialized||await this.init();const e=Math.random().toString(36).substring(2,15);localStorage.setItem("box_oauth_state",e);const t=new URL(T.AUTHORIZATION_URL);t.searchParams.append("client_id",T.CLIENT_ID),t.searchParams.append("response_type","code"),t.searchParams.append("redirect_uri",T.REDIRECT_URI),t.searchParams.append("state",e),window.location.href=t.toString()}async getValidToken(){const e=localStorage.getItem("box_token");if(e)try{const t=JSON.parse(e);if(t.expires_at>Date.now()+3e5)return this.accessToken=t.access_token,t}catch(t){console.warn("Invalid stored token:",t),localStorage.removeItem("box_token")}throw new Error("Not signed in to Box")}async getUserInfo(){const e=await this.getValidToken();try{const t=await fetch(`${T.API_URL}/users/me`,{headers:{Authorization:`Bearer ${e.access_token}`}});if(!t.ok)throw new Error(`Failed to get user info: ${t.status}`);const a=await t.json();return this.userInfo=a,a}catch(t){throw new Error(`Failed to get user info: ${t.message}`)}}async downloadFile(e,t=null){try{const a=await this.getValidToken();console.log("[Box Download] Token retrieved:",a?"Yes":"No","Expires at:",new Date(a.expires_at).toISOString());const i={Authorization:`Bearer ${a.access_token}`};console.log("[Box Download] Fetching metadata for file:",e);const n=await fetch(`${T.API_URL}/files/${e}`,{headers:i});if(!n.ok){const l=await n.text();throw console.error("[Box Download] Metadata fetch failed:",n.status,l),n.status===401?(this.signOut(),new Error("Session expired. Please sign in again.")):new Error(`Failed to get file metadata: ${n.status}`)}const s=await n.json();console.log("[Box Download] Metadata retrieved:",s.name),console.log("[Box Download] Downloading file content...");const o=await fetch(`${T.API_URL}/files/${e}/content`,{headers:i});if(!o.ok){const l=await o.text();throw console.error("[Box Download] File download failed:",o.status,l),new Error(`Failed to download file: ${o.status}`)}const d=await o.blob();return new File([d],s.name,{type:s.content_type||"audio/mpeg"})}catch(a){throw new Error(`Box download failed: ${a.message}`)}}async listAudioFilesInFolder(e,t=null){try{const a=`${T.API_URL}/folders/${e}/items?fields=id,name,type,size,modified_at&limit=1000`;let i=`${T.PROXY_URL}?url=${encodeURIComponent(a)}`;if(t)i+=`&boxapi=${encodeURIComponent(t)}`;else{const c=await this.getValidToken();i+=`&token=${encodeURIComponent(c.access_token)}`}const n=await fetch(i);if(!n.ok)throw!t&&n.status===401?(this.signOut(),new Error("Session expired. Please sign in again.")):new Error(`Failed to list folder contents: ${n.status}`);const o=(await n.json()).entries||[],d=[".mp3",".wav",".flac",".aac",".m4a",".ogg"];return o.filter(c=>{if(c.type!=="file")return!1;const u=c.name.toLowerCase();return d.some(h=>u.endsWith(h))})}catch(a){throw new Error(`Failed to list folder: ${a.message}`)}}async listFilesInFolder(e,t,a=null){try{const i={};if(a)i.BoxApi=`shared_link=${a}`;else{const l=await this.getValidToken();i.Authorization=`Bearer ${l.access_token}`}const n=await fetch(`${T.API_URL}/folders/${e}/items?fields=id,name,type&limit=1000`,{headers:i});if(!n.ok)throw!a&&n.status===401?(this.signOut(),new Error("Session expired. Please sign in again.")):new Error(`Failed to list folder contents: ${n.status}`);let d=((await n.json()).entries||[]).filter(l=>l.type==="file");return t&&(d=d.filter(l=>l.name.toLowerCase().endsWith(t.toLowerCase()))),d}catch(i){throw new Error(`Failed to list folder: ${i.message}`)}}async downloadFileHeaders(e,t=102400,a=null){try{const i={Range:`bytes=0-${t-1}`};if(a)i.BoxApi=`shared_link=${a}`;else{const s=await this.getValidToken();i.Authorization=`Bearer ${s.access_token}`}const n=await fetch(`${T.API_URL}/files/${e}/content`,{headers:i});if(!n.ok&&n.status!==206)throw new Error(`Failed to download file headers: ${n.status}`);return await n.blob()}catch(i){throw new Error(`Failed to download headers: ${i.message}`)}}async getFileMetadata(e,t=null){try{const a={};if(t)a.BoxApi=`shared_link=${t}`;else{const n=await this.getValidToken();a.Authorization=`Bearer ${n.access_token}`}const i=await fetch(`${T.API_URL}/files/${e.id}?fields=id,name,size,modified_at,content_type`,{headers:a});if(!i.ok)throw!t&&i.status===401?(this.signOut(),new Error("Session expired. Please sign in again.")):new Error(`Failed to get file metadata: ${i.status}`);return await i.json()}catch(a){throw new Error(`Box metadata fetch failed: ${a.message}`)}}signOut(){this.accessToken=null,this.userInfo=null,localStorage.removeItem("box_token"),localStorage.removeItem("box_oauth_state")}isSignedIn(){const e=localStorage.getItem("box_token");if(!e)return!1;try{return JSON.parse(e).expires_at>Date.now()}catch{return!1}}}class Y{constructor(){this.audioAnalyzer=new _,this.levelAnalyzer=new H}async analyzeFile(e){return await this.audioAnalyzer.analyzeFile(e)}async analyzeAdvanced(e,t){return await this.levelAnalyzer.analyzeAudioBuffer(e,t)}analyzeStereoSeparation(e){return this.levelAnalyzer.analyzeStereoSeparation(e)}validateCriteria(e,t){return V.validateResults(e,t)}formatResults(e){return V.formatDisplayText(e)}formatAdvancedResults(e){return V.formatAdvancedResults(e)}cancelAdvancedAnalysis(){this.levelAnalyzer.cancelAnalysis()}}function O(I){const e=document.createElement("div");return e.textContent=I,e.innerHTML}class X{constructor(){this.engine=new Y,this.googleAuth=new J,this.boxAuth=new Z,this.batchProcessor=new G(V),this.currentFile=null,this.audioBuffer=null,this.isAnalyzing=!1,this.currentResults=null,this.processingFile=!1,this.batchMode=!1,this.batchResults=null,this.batchCancelled=!1,this.currentBatchSource=null,this.bilingualValidationData=null,this.initializeElements(),this.attachEventListeners(),this.loadSettings(),this.initializeDarkMode(),this.updateBuildInfo()}initializeElements(){this.tabButtons=document.querySelectorAll(".tab-button"),this.tabContents=document.querySelectorAll(".tab-content"),this.darkModeToggle=document.getElementById("darkModeToggle"),this.dropZone=document.getElementById("dropZone"),this.browseBtn=document.getElementById("browseBtn"),this.fileInput=document.getElementById("fileInput"),this.driveUrl=document.getElementById("driveUrl"),this.analyzeUrl=document.getElementById("analyzeUrl"),this.authText=document.getElementById("authText"),this.signInBtn=document.getElementById("signInBtn"),this.signOutBtn=document.getElementById("signOutBtn"),this.boxUrl=document.getElementById("boxUrl"),this.analyzeBoxUrl=document.getElementById("analyzeBoxUrl"),this.boxAuthText=document.getElementById("boxAuthText"),this.boxSignInBtn=document.getElementById("boxSignInBtn"),this.boxSignOutBtn=document.getElementById("boxSignOutBtn"),this.analysisTypeSection=document.getElementById("analysisTypeSection"),this.enableAudioAnalysis=document.getElementById("enableAudioAnalysis"),this.enableFilenameValidation=document.getElementById("enableFilenameValidation"),this.filenameValidationFields=document.getElementById("filenameValidationFields"),this.speakerId=document.getElementById("speakerId"),this.scriptsFolderUrl=document.getElementById("scriptsFolderUrl"),this.boxAnalysisTypeSection=document.getElementById("boxAnalysisTypeSection"),this.boxEnableAudioAnalysis=document.getElementById("boxEnableAudioAnalysis"),this.boxEnableFilenameValidation=document.getElementById("boxEnableFilenameValidation"),this.boxFilenameValidationFields=document.getElementById("boxFilenameValidationFields"),this.localAnalysisTypeSection=document.getElementById("localAnalysisTypeSection"),this.localEnableAudioAnalysis=document.getElementById("localEnableAudioAnalysis"),this.localEnableFilenameValidation=document.getElementById("localEnableFilenameValidation"),this.localFilenameValidationFields=document.getElementById("localFilenameValidationFields"),this.presetSelector=document.getElementById("presetSelector"),this.targetFileType=document.getElementById("targetFileType"),this.targetSampleRate=document.getElementById("targetSampleRate"),this.targetBitDepth=document.getElementById("targetBitDepth"),this.targetChannels=document.getElementById("targetChannels"),this.targetMinDuration=document.getElementById("targetMinDuration"),this.playerSection=document.getElementById("playerSection"),this.resultsSection=document.getElementById("resultsSection"),this.advancedResultsSection=document.getElementById("advancedResultsSection"),this.audioPlayer=document.getElementById("audioPlayer"),this.playPause=document.getElementById("playPause"),this.advancedAnalysisBtn=document.getElementById("advancedAnalysisBtn"),this.advancedProgress=document.getElementById("advancedProgress"),this.progressFill=document.getElementById("progressFill"),this.progressText=document.getElementById("progressText"),this.cancelAnalysis=document.getElementById("cancelAnalysis"),this.loading=document.getElementById("loading"),this.error=document.getElementById("error"),this.errorMessage=document.getElementById("errorMessage"),this.batchProgress=document.getElementById("batchProgress"),this.batchCurrentFile=document.getElementById("batchCurrentFile"),this.batchProgressText=document.getElementById("batchProgressText"),this.batchProgressBar=document.getElementById("batchProgressBar"),this.cancelBatch=document.getElementById("cancelBatch"),this.batchResultsSection=document.getElementById("batchResultsSection"),this.batchPassCount=document.getElementById("batchPassCount"),this.batchWarningCount=document.getElementById("batchWarningCount"),this.batchFailCount=document.getElementById("batchFailCount"),this.batchErrorCount=document.getElementById("batchErrorCount"),this.batchTotalDuration=document.getElementById("batchTotalDuration"),this.batchTotalDurationContainer=document.querySelector(".total-duration"),this.batchTableBody=document.getElementById("batchTableBody")}attachEventListeners(){this.darkModeToggle.addEventListener("click",()=>this.toggleDarkMode()),this.tabButtons.forEach(e=>{e.addEventListener("click",()=>this.switchTab(e.dataset.tab))}),this.browseBtn.addEventListener("click",e=>{e.stopPropagation(),this.fileInput.value="",this.fileInput.click()}),this.fileInput.addEventListener("change",e=>{const t=Array.from(e.target.files||[]);t.length>0&&this.handleFilesSelect(t)}),this.dropZone.addEventListener("dragover",e=>{e.preventDefault(),this.dropZone.classList.add("drag-over")}),this.dropZone.addEventListener("dragleave",()=>{this.dropZone.classList.remove("drag-over")}),this.dropZone.addEventListener("drop",e=>{e.preventDefault(),this.dropZone.classList.remove("drag-over");const t=Array.from(e.dataTransfer.files||[]).filter(a=>a.type.startsWith("audio/"));t.length>0&&this.handleFilesSelect(t)}),this.dropZone.addEventListener("click",()=>this.fileInput.click()),this.analyzeUrl.addEventListener("click",()=>this.handleGoogleDriveUrl()),this.driveUrl.addEventListener("keypress",e=>{e.key==="Enter"&&this.handleGoogleDriveUrl()}),this.signInBtn.addEventListener("click",()=>this.handleSignIn()),this.signOutBtn.addEventListener("click",()=>this.handleSignOut()),this.analyzeBoxUrl.addEventListener("click",()=>this.handleBoxUrl()),this.boxUrl.addEventListener("keypress",e=>{e.key==="Enter"&&this.handleBoxUrl()}),this.boxSignInBtn.addEventListener("click",()=>this.handleBoxSignIn()),this.boxSignOutBtn.addEventListener("click",()=>this.handleBoxSignOut()),this.presetSelector.addEventListener("change",()=>this.handlePresetChange()),this.enableFilenameValidation.addEventListener("change",()=>this.toggleFilenameValidationFields()),this.enableAudioAnalysis.addEventListener("change",()=>this.validateAnalysisTypeSelection()),this.speakerId.addEventListener("input",()=>this.saveFilenameValidationSettings()),this.scriptsFolderUrl.addEventListener("input",()=>this.saveFilenameValidationSettings()),this.boxEnableFilenameValidation.addEventListener("change",()=>this.toggleBoxFilenameValidationFields()),this.boxEnableAudioAnalysis.addEventListener("change",()=>this.validateBoxAnalysisTypeSelection()),this.localEnableFilenameValidation.addEventListener("change",()=>this.toggleLocalFilenameValidationFields()),this.localEnableAudioAnalysis.addEventListener("change",()=>this.validateLocalAnalysisTypeSelection()),[this.targetFileType,this.targetSampleRate,this.targetBitDepth,this.targetChannels].forEach(e=>{e.addEventListener("change",()=>this.saveCriteria())}),this.targetMinDuration.addEventListener("input",()=>this.saveCriteria()),this.playPause.addEventListener("click",()=>this.togglePlayback()),this.audioPlayer.addEventListener("loadedmetadata",()=>{this.playPause.textContent="Play"}),this.advancedAnalysisBtn.addEventListener("click",()=>this.runAdvancedAnalysis()),this.cancelAnalysis.addEventListener("click",()=>this.cancelAdvancedAnalysis()),this.cancelBatch.addEventListener("click",()=>this.cancelBatchProcessing())}loadSettings(){const e=localStorage.getItem("audio-analyzer-settings");if(e)try{const a=JSON.parse(e);if(a.criteria){const i=(n,s)=>{Array.from(n.options).forEach(d=>{d.selected=!1}),(Array.isArray(s)?s:s?[s]:[]).forEach(d=>{const l=Array.from(n.options).find(c=>c.value===d);l&&(l.selected=!0)})};i(this.targetFileType,a.criteria.fileType||[]),i(this.targetSampleRate,a.criteria.sampleRate||[]),i(this.targetBitDepth,a.criteria.bitDepth||[]),i(this.targetChannels,a.criteria.channels||[]),this.targetMinDuration.value=a.criteria.minDuration||""}}catch(a){console.warn("Failed to load settings from localStorage:",a)}const t=localStorage.getItem("audio-analyzer-selected-preset");t?(this.presetSelector.value=t,this.handlePresetChange()):(this.presetSelector.value="auditions-character-recordings",this.handlePresetChange()),this.loadFilenameValidationSettings(),this.loadBoxFilenameValidationSettings(),this.loadLocalFilenameValidationSettings(),this.googleAuth.init().catch(a=>console.error("Google Auth init error:",a)),this.updateAuthStatus(),this.boxAuth.init().then(()=>{this.updateBoxAuthStatus(),localStorage.getItem("box_just_authenticated")==="true"&&(localStorage.removeItem("box_just_authenticated"),this.switchTab("box"))}).catch(a=>console.error("Box Auth init error:",a))}updateAuthStatus(){const e=this.googleAuth.isSignedIn();if(console.log("updateAuthStatus called, isSignedIn:",e),console.log("signInBtn element:",this.signInBtn),e){const t=this.googleAuth.getUserInfo();t&&t.name?this.authText.textContent=`✓ Signed in as ${t.name}`:this.authText.textContent="✓ Signed in to Google Drive",this.signInBtn.style.display="none",this.signOutBtn.style.display="inline-block"}else this.authText.textContent="Not signed in to Google",this.signInBtn.style.display="inline-block",this.signOutBtn.style.display="none",console.log("Set signInBtn display to inline-block")}async handleSignIn(){try{await this.googleAuth.signIn(),this.updateAuthStatus()}catch(e){console.error("Sign-in failed:",e),this.showError(`Google sign-in failed: ${e.message}`)}}handleSignOut(){this.googleAuth.signOut(),this.updateAuthStatus()}updateBoxAuthStatus(){if(this.boxAuth.isSignedIn()){const t=this.boxAuth.userInfo;t&&t.name?this.boxAuthText.textContent=`✓ Signed in as ${t.name}`:this.boxAuthText.textContent="✓ Signed in to Box",this.boxSignInBtn.style.display="none",this.boxSignOutBtn.style.display="inline-block"}else this.boxAuthText.textContent="Not signed in to Box",this.boxSignInBtn.style.display="inline-block",this.boxSignOutBtn.style.display="none"}async handleBoxSignIn(){try{await this.boxAuth.signIn(),this.updateBoxAuthStatus()}catch(e){console.error("Box sign-in failed:",e),this.showError(`Box sign-in failed: ${e.message}`)}}handleBoxSignOut(){this.boxAuth.signOut(),this.updateBoxAuthStatus()}getCriteria(){const e=a=>Array.from(a.selectedOptions).map(i=>i.value);return{fileType:e(this.targetFileType),sampleRate:e(this.targetSampleRate),bitDepth:e(this.targetBitDepth),channels:e(this.targetChannels),minDuration:this.targetMinDuration.value||""}}saveCriteria(){const t={criteria:this.getCriteria()};localStorage.setItem("audio-analyzer-settings",JSON.stringify(t)),this.currentResults&&this.validateAndDisplayResults(this.currentResults),this.batchResults&&this.batchMode&&this.revalidateBatchResults()}getPresetConfigurations(){return{"auditions-character-recordings":{name:"Auditions: Character Recordings",fileType:["wav"],sampleRate:["48000"],bitDepth:["24"],channels:["1"],minDuration:"120"},"auditions-emotional-voice":{name:"Auditions: Emotional Voice",fileType:["wav"],sampleRate:["48000"],bitDepth:["16","24"],channels:["1","2"],minDuration:"30"},"character-recordings":{name:"Character Recordings",fileType:["wav"],sampleRate:["48000"],bitDepth:["24"],channels:["1"],minDuration:""},"p2b2-pairs-mono":{name:"P2B2 Pairs (Mono)",fileType:["wav"],sampleRate:["44100","48000"],bitDepth:["16","24"],channels:["1"],minDuration:""},"p2b2-pairs-stereo":{name:"P2B2 Pairs (Stereo)",fileType:["wav"],sampleRate:["44100","48000"],bitDepth:["16","24"],channels:["2"],minDuration:""},"p2b2-pairs-mixed":{name:"P2B2 Pairs (Mixed)",fileType:["wav"],sampleRate:["44100","48000"],bitDepth:["16","24"],channels:["1","2"],minDuration:""},"three-hour":{name:"Three Hour",fileType:["wav"],sampleRate:["48000"],bitDepth:["24"],channels:["1"],minDuration:"",supportsFilenameValidation:!0,filenameValidationType:"script-match",gdriveOnly:!0},"bilingual-conversational":{name:"Bilingual Conversational",fileType:["wav"],sampleRate:["48000"],bitDepth:["16","24"],channels:["2"],minDuration:"",supportsFilenameValidation:!0,filenameValidationType:"bilingual-pattern"},custom:{name:"Custom"}}}handlePresetChange(){const e=this.presetSelector.value,t=document.getElementById("customCriteriaSection");if(e){if(e==="custom")t.style.display="block";else{t.style.display="none";const i=this.getPresetConfigurations()[e];if(i){const n=(s,o)=>{Array.from(s.options).forEach(l=>{l.selected=!1}),(Array.isArray(o)?o:o?[o]:[]).forEach(l=>{const c=Array.from(s.options).find(u=>u.value===l);c&&(c.selected=!0)})};n(this.targetFileType,i.fileType||[]),n(this.targetSampleRate,i.sampleRate||[]),n(this.targetBitDepth,i.bitDepth||[]),n(this.targetChannels,i.channels||[]),this.targetMinDuration.value=i.minDuration||"",this.saveCriteria(),this.currentResults&&this.validateAndDisplayResults(this.currentResults),this.batchResults&&this.batchMode&&this.revalidateBatchResults(),this.updateValidationSectionsVisibility()}}localStorage.setItem("audio-analyzer-selected-preset",e)}}toggleFilenameValidationFields(){this.enableFilenameValidation.checked?this.filenameValidationFields.style.display="block":this.filenameValidationFields.style.display="none",this.saveFilenameValidationSettings()}validateAnalysisTypeSelection(){!this.enableAudioAnalysis.checked&&!this.enableFilenameValidation.checked&&(this.enableAudioAnalysis.checked=!0,alert("At least one analysis type must be selected")),this.saveFilenameValidationSettings()}saveFilenameValidationSettings(){const e={enableAudioAnalysis:this.enableAudioAnalysis.checked,enableFilenameValidation:this.enableFilenameValidation.checked,speakerId:this.speakerId.value,scriptsFolderUrl:this.scriptsFolderUrl.value};localStorage.setItem("audio-analyzer-filename-validation",JSON.stringify(e))}loadFilenameValidationSettings(){const e=localStorage.getItem("audio-analyzer-filename-validation");if(e)try{const t=JSON.parse(e);this.enableAudioAnalysis.checked=t.enableAudioAnalysis!==!1,this.enableFilenameValidation.checked=t.enableFilenameValidation||!1,this.speakerId.value=t.speakerId||"",this.scriptsFolderUrl.value=t.scriptsFolderUrl||"";const a=this.presetSelector.value,n=this.getPresetConfigurations()[a];this.enableFilenameValidation.checked&&n&&n.supportsFilenameValidation?this.filenameValidationFields.style.display="block":this.filenameValidationFields.style.display="none"}catch(t){console.error("Error loading filename validation settings:",t)}}toggleBoxFilenameValidationFields(){this.boxEnableFilenameValidation.checked?this.boxFilenameValidationFields.style.display="block":this.boxFilenameValidationFields.style.display="none",this.saveBoxFilenameValidationSettings()}validateBoxAnalysisTypeSelection(){!this.boxEnableAudioAnalysis.checked&&!this.boxEnableFilenameValidation.checked&&(this.boxEnableAudioAnalysis.checked=!0,alert("At least one analysis type must be selected")),this.saveBoxFilenameValidationSettings()}saveBoxFilenameValidationSettings(){const e={enableAudioAnalysis:this.boxEnableAudioAnalysis.checked,enableFilenameValidation:this.boxEnableFilenameValidation.checked};localStorage.setItem("audio-analyzer-box-filename-validation",JSON.stringify(e))}loadBoxFilenameValidationSettings(){const e=localStorage.getItem("audio-analyzer-box-filename-validation");if(e)try{const t=JSON.parse(e);this.boxEnableAudioAnalysis.checked=t.enableAudioAnalysis!==!1,this.boxEnableFilenameValidation.checked=t.enableFilenameValidation||!1}catch(t){console.error("Error loading Box filename validation settings:",t)}}toggleLocalFilenameValidationFields(){if(this.localEnableFilenameValidation.checked){const e=this.getPresetConfigurations(),t=this.presetSelector.value,a=e[t];(a==null?void 0:a.filenameValidationType)==="bilingual-pattern"?this.localFilenameValidationFields.style.display="block":this.localFilenameValidationFields.style.display="none"}else this.localFilenameValidationFields.style.display="none";this.saveLocalFilenameValidationSettings()}validateLocalAnalysisTypeSelection(){!this.localEnableAudioAnalysis.checked&&!this.localEnableFilenameValidation.checked&&(this.localEnableAudioAnalysis.checked=!0,alert("At least one analysis type must be selected")),this.saveLocalFilenameValidationSettings()}saveLocalFilenameValidationSettings(){const e={enableAudioAnalysis:this.localEnableAudioAnalysis.checked,enableFilenameValidation:this.localEnableFilenameValidation.checked};localStorage.setItem("audio-analyzer-local-filename-validation",JSON.stringify(e))}loadLocalFilenameValidationSettings(){const e=localStorage.getItem("audio-analyzer-local-filename-validation");if(e)try{const t=JSON.parse(e);this.localEnableAudioAnalysis.checked=t.enableAudioAnalysis!==!1,this.localEnableFilenameValidation.checked=t.enableFilenameValidation||!1}catch(t){console.error("Error loading local filename validation settings:",t)}}switchTab(e){this.tabButtons.forEach(t=>t.classList.remove("active")),this.tabContents.forEach(t=>t.classList.remove("active")),document.querySelector(`[data-tab="${e}"]`).classList.add("active"),document.querySelectorAll(`.tab-content[data-tab="${e}"]`).forEach(t=>{t.classList.add("active")}),this.cleanupForNewFile(),this.hideAllSections(),this.updateValidationSectionsVisibility()}toggleDarkMode(){const e=document.documentElement;e.classList.contains("dark-mode")?(e.classList.remove("dark-mode"),localStorage.setItem("darkMode","false")):(e.classList.add("dark-mode"),localStorage.setItem("darkMode","true"))}initializeDarkMode(){const e=localStorage.getItem("darkMode");e!==null?e==="true"&&document.documentElement.classList.add("dark-mode"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.documentElement.classList.add("dark-mode")}updateBuildInfo(){const e=document.getElementById("buildInfo");if(e){const t=new Date,a=t.getFullYear(),i=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0"),s=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0"),d=`${a}.${i}.${n}-${s}${o}`;e.textContent=`Audio Analyzer build-${d}`}}updateValidationSectionsVisibility(){const e=document.querySelector(".tab-button.active"),t=e?e.dataset.tab:"local",a=this.getPresetConfigurations(),i=this.presetSelector.value,n=a[i];if(!n)return;const s=n.filenameValidationType;if(t==="gdrive"&&n.supportsFilenameValidation)if(this.analysisTypeSection.style.display="block",this.enableFilenameValidation.checked){this.filenameValidationFields.style.display="block";const o=document.getElementById("driveThreeHourFields"),d=document.getElementById("driveBilingualFields");s==="script-match"?(o&&(o.style.display="block"),d&&(d.style.display="none")):s==="bilingual-pattern"?(o&&(o.style.display="none"),d&&(d.style.display="block")):(o&&(o.style.display="none"),d&&(d.style.display="none"))}else this.filenameValidationFields.style.display="none";else this.analysisTypeSection.style.display="none",this.filenameValidationFields.style.display="none";t==="box"&&n.supportsFilenameValidation&&!n.gdriveOnly?(this.boxAnalysisTypeSection.style.display="block",this.boxEnableFilenameValidation.checked?s==="bilingual-pattern"?this.boxFilenameValidationFields.style.display="block":this.boxFilenameValidationFields.style.display="none":this.boxFilenameValidationFields.style.display="none"):(this.boxAnalysisTypeSection.style.display="none",this.boxFilenameValidationFields.style.display="none"),t==="local"&&n.supportsFilenameValidation&&!n.gdriveOnly?(this.localAnalysisTypeSection.style.display="block",this.localEnableFilenameValidation.checked?s==="bilingual-pattern"?this.localFilenameValidationFields.style.display="block":this.localFilenameValidationFields.style.display="none":this.localFilenameValidationFields.style.display="none"):(this.localAnalysisTypeSection.style.display="none",this.localFilenameValidationFields.style.display="none")}async handleFilesSelect(e){if(!(!e||e.length===0)){if(this.processingFile){console.log("Already processing files, ignoring duplicate call");return}e.length===1?(this.batchMode=!1,await this.handleFileSelect(e[0])):(this.batchMode=!0,await this.handleBatchFiles(e))}}async handleFileSelect(e){if(console.log("handleFileSelect called with:",e),!e){console.log("No file provided to handleFileSelect");return}if(this.processingFile){console.log("Already processing a file, ignoring duplicate call");return}this.processingFile=!0,console.log("Starting file processing..."),this.cleanupForNewFile(),this.currentFile=e,console.log("Showing loading screen..."),this.showLoading();try{console.log("Starting analysis with core engine...");const t=await this.engine.analyzeFile(e);console.log("Analysis results:",t),this.currentResults=t,console.log("Setting up audio player..."),this.setupAudioPlayer(e),console.log("Validating and displaying results..."),this.validateAndDisplayResults(t),this.showResults(),console.log("Results displayed successfully")}catch(t){console.error("Analysis error:",t),this.showError(`Failed to analyze file: ${t.message}`),this.cleanupForNewFile()}finally{this.processingFile=!1,console.log("File processing completed")}}async handleBatchFiles(e){this.processingFile=!0,this.batchCancelled=!1,this.cleanupForNewFile(),console.log(`Starting batch processing of ${e.length} files`),this.batchMode=!0,this.currentBatchSource="local",this.batchResults=[],this.showBatchProgress(0,e.length,"Initializing..."),this.initializeBatchResultsTable();try{const t=await this.batchProcessor.processBatch(e,()=>this.getCriteria(),a=>{this.showBatchProgress(a.current,a.total,a.currentFile)},async a=>{if(this.localEnableFilenameValidation&&this.localEnableFilenameValidation.checked){const i=this.getPresetConfigurations(),n=this.presetSelector.value,s=i[n],o=s==null?void 0:s.filenameValidationType;if(o==="bilingual-pattern"&&(a.filenameValidation=await this.validateBilingualFilename(a.filename),a.status=this.getOverallStatus(a.validation,!1,a.filenameValidation)),o==="bilingual-pattern"&&a.analysis&&a.analysis.duration&&a.filename.replace(/\.\w+$/i,"").startsWith("SPONTANEOUS")){const l=a.analysis.duration;l>600&&(a.validation||(a.validation={}),a.validation.duration={status:"warning",issue:`SPONTANEOUS recordings must be ≤10 minutes (current: ${Math.round(l/60)} min)`},a.status=this.getOverallStatus(a.validation,!1,a.filenameValidation))}}this.batchResults.push(a),this.addBatchResultRow(a),this.updateBatchSummary()});this.batchResults=t,this.updateBatchSummary(),this.batchCancelled||(this.batchProgress.style.display="none")}catch(t){console.error("Batch processing error:",t),this.showError(`Failed to process batch: ${t.message}`),this.cleanupForNewFile()}finally{this.processingFile=!1}}async handleGoogleDriveUrl(){const e=this.driveUrl.value.trim();if(e){if(this.processingFile){console.log("Already processing a file, ignoring Google Drive request");return}this.processingFile=!0,this.cleanupForNewFile(),this.showLoading();try{const t=this.extractFileIdFromUrl(e);if(!t)throw new Error("Invalid Google Drive URL. Please ensure it's a valid Drive file or folder link.");this.updateAuthStatus(),t.isFolder?await this.handleGoogleDriveFolder(t.id):await this.handleGoogleDriveFile(t.id)}catch(t){console.error("Google Drive error:",t),this.cleanupForNewFile(),t.message.includes("sign-in")||t.message.includes("auth")?this.showError('Please sign in to Google to access Drive files. Click "Analyze" to authenticate.'):this.showError(`Failed to process Google Drive: ${t.message}`)}finally{this.processingFile=!1}}}async handleGoogleDriveFile(e){const t=await this.googleAuth.downloadFile(e);this.currentFile=t;const a=await this.engine.analyzeFile(t);this.currentResults=a,this.setupAudioPlayer(t),this.validateAndDisplayResults(a),this.showResults()}async fetchScriptFiles(e){try{const a=(await this.googleAuth.listFilesInFolder(e,".txt")).map(i=>i.name.trim().replace(/\.txt$/i,""));return console.log(`Found ${a.length} script files:`,a),a}catch(t){throw console.error("Error fetching script files:",t),new Error("Failed to fetch script files. Check the scripts folder URL.")}}validateFilename(e,t,a){const i=e.trim(),s=i.replace(/\.wav$/i,"").split(`_${a}`)[0],o=`${s}_${a}.wav`;return t.includes(s)?i===o?{status:"pass",expectedFormat:o,issue:""}:{status:"fail",expectedFormat:`${s}_${a}.wav`,issue:"Incorrect filename for existing script"}:{status:"fail",expectedFormat:"-",issue:"No matching script file found"}}async loadBilingualValidationData(){if(!this.bilingualValidationData)try{const e=await fetch("https://us-central1-chromeextensionauth-472920.cloudfunctions.net/bilingualValidation");if(!e.ok)throw new Error("Failed to load bilingual validation data");const{data:t}=await e.json();this.bilingualValidationData=t}catch(e){console.error("Error loading bilingual validation data:",e),this.showError("Could not load filename validation data. Please refresh the page.")}}async validateBilingualFilename(e){await this.loadBilingualValidationData();const t=this.bilingualValidationData;if(!t)return{status:"fail",issue:"Bilingual validation data could not be loaded."};const a=[];e!==e.trim()&&a.push("Filename has leading or trailing whitespace"),/\s/.test(e)&&a.push("Filename contains whitespace characters");const i=/\.wav$/i.test(e);if(i||a.push("Filename must end with .wav extension"),i){const o=e.replace(/\.wav$/i,"");/\.\w+$/.test(o)&&a.push("Filename has multiple extensions (e.g., .mp3.wav or .wav.wav)")}const n=e.replace(/\.\w+$/i,"");if(n.startsWith("SPONTANEOUS_")){n.startsWith("SPONTANEOUS_")||a.push('Unscripted recordings must start with "SPONTANEOUS_" (all caps)');const o=n.match(/^SPONTANEOUS_(\d+)-(.+)$/);if(!o)return a.push("Invalid unscripted format: expected SPONTANEOUS_[number]-[LanguageCode]-user-[UserID]-agent-[AgentID]"),{status:"fail",expectedFormat:"SPONTANEOUS_[number]-[LanguageCode]-user-[UserID]-agent-[AgentID].wav",issue:a.join(`
`),isSpontaneous:!0};const d=o[1],l=o[2];l!==l.toLowerCase()&&a.push('All text after "SPONTANEOUS_[number]-" must be lowercase');const c=l.toLowerCase().split("-");if(c.length!==5)return a.push(`Invalid format: expected 5 parts after SPONTANEOUS_[number]-, got ${c.length}`),{status:"fail",expectedFormat:"SPONTANEOUS_[number]-[LanguageCode]-user-[UserID]-agent-[AgentID].wav",issue:a.join(`
`),isSpontaneous:!0};const u=c[0],h=c[1],m=c[2],r=c[3],b=c[4];return h!=="user"&&a.push(`Expected 'user' label, got '${h}'`),r!=="agent"&&a.push(`Expected 'agent' label, got '${r}'`),t.languageCodes.includes(u)||a.push(`Invalid language code: '${u}'`),t.contributorPairs.some(y=>y[0]===m&&y[1]===b||y[0]===b&&y[1]===m)||a.push(`Invalid contributor pair: user-${m}, agent-${b}`),a.length>0?{status:"fail",expectedFormat:"SPONTANEOUS_[number]-[LanguageCode]-user-[UserID]-agent-[AgentID].wav",issue:a.join(`
`),isSpontaneous:!0}:{status:"pass",expectedFormat:`SPONTANEOUS_${d}-${u}-user-${m}-agent-${b}.wav`,issue:"",isSpontaneous:!0}}else{n!==n.toLowerCase()&&a.push("Filename must be all lowercase");const o=n.toLowerCase().split("-");if(o.length!==6)return a.push(`Invalid format: expected 6 parts separated by '-', got ${o.length}`),{status:"fail",expectedFormat:"[ConversationID]-[LanguageCode]-user-[UserID]-agent-[AgentID].wav",issue:a.join(`
`),isSpontaneous:!1};const d=o[0],l=o[1],c=o[2],u=o[3],h=o[4],m=o[5];return c!=="user"&&a.push(`Expected 'user' label, got '${c}'`),h!=="agent"&&a.push(`Expected 'agent' label, got '${h}'`),t.languageCodes.includes(l)||a.push(`Invalid language code: '${l}'`),t.languageCodes.includes(l)&&((t.conversationsByLanguage[l]||[]).includes(d)||a.push(`Invalid conversation ID: '${d}' for language '${l}'`)),t.contributorPairs.some(g=>g[0]===u&&g[1]===m||g[0]===m&&g[1]===u)||a.push(`Invalid contributor pair: user-${u}, agent-${m}`),a.length>0?{status:"fail",expectedFormat:"[ConversationID]-[LanguageCode]-user-[UserID]-agent-[AgentID].wav",issue:a.join(`
`),isSpontaneous:!1}:{status:"pass",expectedFormat:`${d}-${l}-user-${u}-agent-${m}.wav`,issue:"",isSpontaneous:!1}}}async handleGoogleDriveFolder(e){const t=await this.googleAuth.listAudioFilesInFolder(e);if(t.length===0)throw new Error("No audio files found in this folder");console.log(`Found ${t.length} audio files in folder`);const a=this.getPresetConfigurations(),i=this.presetSelector.value,n=a[i],s=n==null?void 0:n.filenameValidationType;let o=[];if(this.enableFilenameValidation.checked&&s==="script-match"){const c=this.scriptsFolderUrl.value.trim();if(!this.speakerId.value.trim())throw new Error("Speaker ID is required for filename validation");if(c){const h=this.extractFolderId(c);if(h)o=await this.fetchScriptFiles(h);else throw new Error("Invalid scripts folder URL")}else throw new Error("Scripts folder URL is required for filename validation")}this.batchMode=!0,this.currentBatchSource="drive",this.batchResults=[],this.batchCancelled=!1,this.scriptBaseNames=o,this.currentValidationType=s,this.showBatchProgress(0,t.length,"Initializing..."),this.initializeBatchResultsTable();const d=3;let l=0;for(let c=0;c<t.length;c+=d){if(this.batchCancelled){console.log("Batch processing cancelled");break}const h=t.slice(c,c+d).map(async r=>{var b,g;if(this.batchCancelled)return null;try{const f=this.currentValidationType;let y,p=!1;const F=this.enableFilenameValidation.checked&&!this.enableAudioAnalysis.checked;if(F){const w=await this.googleAuth.getFileMetadata(r);console.log("Full metadata for",w.name,":",w),y={filename:w.name,fileSize:parseInt(w.size)||0,fileType:this.getFileTypeFromName(w.name),sampleRate:"Unknown",bitDepth:"Unknown",channels:"Unknown",duration:(b=w.videoMediaMetadata)!=null&&b.durationMillis?w.videoMediaMetadata.durationMillis/1e3:"Unknown"},p=!0}else{let B=null;for(let E=0;E<3;E++)try{const S=await this.googleAuth.downloadFileHeaders(r.id),k=parseInt(r.size)||S.size,A=new File([S],r.name,{type:r.mimeType,lastModified:new Date(r.modifiedTime).getTime()});Object.defineProperty(A,"size",{value:k,writable:!1}),y=await this.batchProcessor.analyzer.analyzeHeaders(A);break}catch(S){if(B=S,(S.message.includes("500")||S.message.includes("502")||S.message.includes("503")||S.message.includes("504"))&&E<2){const A=Math.min(1e3*Math.pow(2,E),5e3);console.log(`Retry ${E+1}/3 for ${r.name} after ${A}ms...`),await new Promise($=>setTimeout($,A))}else throw B}}(g=r.videoMediaMetadata)!=null&&g.durationMillis&&(y.duration=r.videoMediaMetadata.durationMillis/1e3);const x=V.validateResults(y,this.getCriteria(),F);let v=null;if(this.enableFilenameValidation.checked){if(f==="script-match"&&this.scriptBaseNames.length>0){const w=this.speakerId.value.trim();v=this.validateFilename(r.name,this.scriptBaseNames,w)}else f==="bilingual-pattern"&&(v=await this.validateBilingualFilename(r.name));f==="bilingual-pattern"&&y&&y.duration&&r.name.replace(/\.\w+$/i,"").startsWith("SPONTANEOUS")&&y.duration>600&&(x||(x={}),x.duration={status:"warning",issue:`SPONTANEOUS recordings must be ≤10 minutes (current: ${Math.round(y.duration/60)} min)`})}return{filename:r.name,file:null,driveFileId:r.id,analysis:y,validation:x,filenameValidation:v,status:this.getOverallStatus(x,F,v),warning:p?"Limited analysis (Google Drive error)":null}}catch(f){return console.error(`Error processing ${r.name}:`,f),{filename:r.name,file:null,driveFileId:r.id,analysis:null,validation:null,status:"error",error:f.message}}});(await Promise.all(h)).forEach(r=>{r&&(this.batchResults.push(r),this.addBatchResultRow(r),l++,this.batchCancelled||this.showBatchProgress(l,t.length,r.filename))}),this.updateBatchSummary()}this.batchCancelled||(this.batchProgress.style.display="none")}extractFileIdFromUrl(e){const t=[/\/file\/d\/([a-zA-Z0-9-_]+)/,/\/folders\/([a-zA-Z0-9-_]+)/,/[?&]id=([a-zA-Z0-9-_]+)/,/^([a-zA-Z0-9-_]+)$/];for(const a of t){const i=e.match(a);if(i)return{id:i[1],isFolder:a===t[1]}}return null}extractFolderId(e){const t=e.match(/[-\w]{25,}/);return t?t[0]:null}async handleBoxUrl(){const e=this.boxUrl.value.trim();if(e){if(this.processingFile){console.log("Already processing a file, ignoring Box request");return}if(!this.boxAuth.isSignedIn()){await this.handleBoxSignIn();return}this.processingFile=!0,this.cleanupForNewFile(),this.showLoading();try{const t=this.extractBoxIdFromUrl(e);if(!t)throw new Error("Invalid Box URL. Please ensure it's a valid Box file or folder link.");this.currentBoxSharedLink=e,this.updateBoxAuthStatus();const a=null;t.isFolder?await this.handleBoxFolder(t.id,a):await this.handleBoxFile(t.id,a)}catch(t){console.error("Box error:",t),this.cleanupForNewFile(),t.message.includes("sign-in")||t.message.includes("auth")||t.message.includes("Session expired")?this.currentBoxSharedLink?this.showError(`Failed to access Box file: ${t.message}. The file may not be publicly shared.`):this.showError('Please sign in to Box to access files. Click "Analyze" to authenticate.'):this.showError(`Failed to process Box: ${t.message}`)}finally{this.processingFile=!1,this.currentBoxSharedLink=null}}}async handleBoxFile(e,t=null){const i=this.boxAnalysisTypeSection.style.display!=="none"&&this.boxEnableFilenameValidation.checked,n=i&&!this.boxEnableAudioAnalysis.checked,s=await this.boxAuth.getFileMetadata({id:e},t),o=s.name;let d=null;i&&(d=await this.validateBilingualFilename(o));let l;if(n){l={filename:o,fileSize:parseInt(s.size)||0,fileType:this.getFileTypeFromName(o),sampleRate:"Unknown",bitDepth:"Unknown",channels:"Unknown",duration:"Unknown"},this.currentFile=null,this.currentResults=l;const c=this.getCriteria(),u=this.engine.validateCriteria(l,c),h=o.replace(/\.\w+$/i,"").startsWith("SPONTANEOUS");if(i&&h&&l&&l.duration&&l.duration!=="Unknown"){const r=l.duration;r>600&&(u||(u={}),u.duration={status:"warning",issue:`SPONTANEOUS recordings must be ≤10 minutes (current: ${Math.round(r/60)} min)`})}this.currentResults.validation=u,this.currentResults.filenameValidation=d,this.validateAndDisplayResults(l,d),this.showResults()}else{const c=await this.boxAuth.downloadFile(e,t);this.currentFile=c,l=await this.engine.analyzeFile(c),l&&s&&s.size&&(l.fileSize=s.size),this.currentResults=l,this.currentResults.filenameValidation=d,this.setupAudioPlayer(c),this.validateAndDisplayResults(l,d),this.showResults()}}async handleBoxFolder(e,t=null){const a=await this.boxAuth.listAudioFilesInFolder(e,t);if(a.length===0)throw new Error("No audio files found in the Box folder");this.batchMode=!0,this.currentBatchSource="box",this.batchCancelled=!1,this.showBatchProgress();const i=this.boxAnalysisTypeSection.style.display!=="none",n=i&&this.boxEnableFilenameValidation.checked&&!this.boxEnableAudioAnalysis.checked;try{this.batchResults=[];let s=0,o=0,d=0,l=0,c=0;this.initializeBatchResultsTable();for(let u=0;u<a.length;u++){if(this.batchCancelled){console.log("Batch processing cancelled by user");break}const h=a[u];this.showBatchProgress(u+1,a.length,h.name);try{let m=null,r=null;i&&this.boxEnableFilenameValidation.checked&&(r=await this.validateBilingualFilename(h.name));let b=null;if(n)b=await this.boxAuth.getFileMetadata(h,t),m={filename:h.name,fileSize:parseInt(b.size)||0,fileType:this.getFileTypeFromName(h.name),sampleRate:"Unknown",bitDepth:"Unknown",channels:"Unknown",duration:"Unknown"};else{b=await this.boxAuth.getFileMetadata(h,t);const v=await this.boxAuth.downloadFileHeaders(h.id,102400,t),w=new File([v],h.name),B=parseInt(b.size)||w.size;Object.defineProperty(w,"size",{value:B,writable:!1}),m=await this.batchProcessor.analyzer.analyzeHeaders(w),m&&m.duration&&m.duration!=="Unknown"&&(c+=m.duration)}const g=this.getCriteria(),f=m?this.engine.validateCriteria(m,g):{},y=h.name.replace(/\.\w+$/i,"").startsWith("SPONTANEOUS");if(i&&y&&m&&m.duration&&m.duration!=="Unknown"){const v=m.duration;v>600&&(f||(f={}),f.duration={status:"warning",issue:`SPONTANEOUS recordings must be ≤10 minutes (current: ${Math.round(v/60)} min)`})}const F=this.getOverallStatus(f,n,r);F==="pass"?s++:F==="warning"?o++:F==="fail"&&d++;const x={name:h.name,filename:h.name,analysis:m,validation:f,filenameValidation:r,status:F,error:null,boxFileId:h.id};this.batchResults.push(x),this.addBatchResultRow(x)}catch(m){console.error(`Error processing ${h.name}:`,m),l++;const r={name:h.name,filename:h.name,analysis:null,validation:{},filenameValidation:null,status:"error",error:m.message};this.batchResults.push(r),this.addBatchResultRow(r)}}this.updateBatchSummary(s,o,d,l,c),this.batchCancelled||(this.batchProgress.style.display="none")}catch(s){console.error("Batch processing error:",s),this.showError(`Failed to process batch: ${s.message}`),this.cleanupForNewFile()}finally{this.processingFile=!1}}async fetchBoxScriptFiles(e,t=null){try{const i=(await this.boxAuth.listFilesInFolder(e,".txt",t)).map(n=>n.name.trim().replace(/\.txt$/i,""));return console.log(`Found ${i.length} Box script files:`,i),i}catch(a){throw console.error("Error fetching Box script files:",a),new Error("Failed to fetch script files. Check the scripts folder URL.")}}extractBoxIdFromUrl(e){const t=e.match(/\/s\/[^/]+\/file\/(\d+)/);if(t)return{id:t[1],isFolder:!1,sharedLink:e};const a=e.match(/\/s\/[^/]+\/folder\/(\d+)/);if(a)return{id:a[1],isFolder:!0,sharedLink:e};const i=[/\/file\/(\d+)/,/\/folder\/(\d+)/,/^(\d+)$/];for(const n of i){const s=e.match(n);if(s)return{id:s[1],isFolder:n===i[1],sharedLink:null}}return null}extractBoxFolderId(e){const t=e.match(/\/folder\/(\d+)/);return t?t[1]:null}setupAudioPlayer(e){const t=URL.createObjectURL(e);this.audioPlayer.src=t,this.audioPlayer.load(),this.playerSection.style.display="block"}togglePlayback(){this.audioPlayer.paused?(this.audioPlayer.play(),this.playPause.textContent="Pause"):(this.audioPlayer.pause(),this.playPause.textContent="Play")}validateAndDisplayResults(e,t=null){const a=this.getCriteria();let i=this.engine.validateCriteria(e,a);const n=this.getPresetConfigurations(),s=this.presetSelector.value,o=n[s],d=o==null?void 0:o.filenameValidationType,c=(this.currentFile?this.currentFile.name:e.filename||"").replace(/\.\w+$/i,"").startsWith("SPONTANEOUS");if(d==="bilingual-pattern"&&c&&e&&e.duration&&e.duration!=="Unknown"){const k=e.duration;k>600&&(i||(i={}),i.duration={status:"warning",issue:`SPONTANEOUS recordings must be ≤10 minutes (current: ${Math.round(k/60)} min)`})}const u=this.engine.formatResults(e),h=this.currentFile?this.currentFile.name:e.filename||"-",m=this.getOverallStatus(i,!1,t),r=this.getValidationStatus(i,"fileType",e.fileType),b=this.getValidationStatus(i,"sampleRate",e.sampleRate),g=this.getValidationStatus(i,"bitDepth",e.bitDepth),f=this.getValidationStatus(i,"channels",e.channels),y=this.getValidationStatus(i,"duration",e.duration);this.updateSingleFileColumnVisibility(a,t);const p=document.createElement("tr");p.className=`batch-row ${m}`;let F="";if(t){const k=t.status==="pass"?"✅":"❌";let A="";t.status==="pass"?A="Filename is valid":(A=t.issue,t.expectedFormat&&(A+=`

Expected: ${t.expectedFormat}`)),F=`<td class="filename-check-${t.status}" title="${A}">${k}</td>`}else F='<td style="display: none;"></td>';const x='<button class="play-btn-small" id="singleFilePlayBtn">▶</button>',v=O(h);p.innerHTML=`
      <td class="filename" title="${v}">${v}</td>
      <td><span class="status-badge ${m}">${m}</span></td>
      ${F}
      <td class="validation-${r}">${u.fileType||"Unknown"}</td>
      <td class="validation-${b}">${u.sampleRate||"-"}</td>
      <td class="validation-${g}">${u.bitDepth||"-"}</td>
      <td class="validation-${f}">${u.channels||"-"}</td>
      <td class="validation-${y}">${u.duration||"-"}</td>
      <td>${u.fileSize||"-"}</td>
      <td>${x}</td>
    `;const w=document.getElementById("singleTableBody");w.innerHTML="",w.appendChild(p);const B=p.querySelector("#singleFilePlayBtn");B&&B.addEventListener("click",()=>{this.togglePlayPause()});const E=p.querySelector(".filename-check-pass, .filename-check-fail");E&&this.setupFilenameCheckTooltip(E);const S=p.querySelector(".filename");S&&this.setupFilenameCheckTooltip(S)}updateSingleFileColumnVisibility(e,t){const a=document.getElementById("singleFilenameCheckHeader");a&&(a.style.display=t?"":"none"),["singleFormatHeader","singleSampleRateHeader","singleBitDepthHeader","singleChannelsHeader","singleDurationHeader"].forEach(n=>{const s=document.getElementById(n);s&&(s.style.display="")})}async runAdvancedAnalysis(){if(!this.audioBuffer&&this.currentFile)try{const e=await this.currentFile.arrayBuffer(),t=new(window.AudioContext||window.webkitAudioContext);this.audioBuffer=await t.decodeAudioData(e)}catch(e){this.showError(`Failed to decode audio: ${e.message}`);return}if(!this.audioBuffer){this.showError("No audio data available for analysis");return}this.isAnalyzing=!0,this.advancedAnalysisBtn.style.display="none",this.advancedProgress.style.display="block";try{const e=await this.engine.analyzeAdvanced(this.audioBuffer,(o,d)=>{this.progressText.textContent=o,this.progressFill.style.width=`${d*100}%`});document.getElementById("peakLevel").textContent=e.peakDb===-1/0?"-∞ dB":`${e.peakDb.toFixed(1)} dB`,document.getElementById("noiseFloor").textContent=e.noiseFloorDb===-1/0?"-∞ dB":`${e.noiseFloorDb.toFixed(1)} dB`,document.getElementById("noiseFloorHistogram").textContent=e.noiseFloorDbHistogram===-1/0?"-∞ dB":`${e.noiseFloorDbHistogram.toFixed(1)} dB`;const t=document.getElementById("normalization"),a=e.normalizationStatus;t.innerHTML=`${a.message}<br><small>Peak: ${a.peakDb.toFixed(1)}dB (Target: ${a.targetDb.toFixed(1)}dB)</small>`;const i=this.engine.analyzeStereoSeparation(this.audioBuffer),n=document.getElementById("stereoSeparation");i?n.innerHTML=`${i.stereoType}<br><small>(Confidence: ${Math.round(i.stereoConfidence*100)}%)</small>`:n.textContent="Not applicable (mono file)";const s=document.getElementById("reverbEstimation");e.reverbInfo&&e.reverbInfo.time>0?(s.innerHTML=`~${e.reverbInfo.time.toFixed(2)} s<br><small>${e.reverbInfo.label}</small>`,s.title=e.reverbInfo.description):(s.textContent="-",s.title=""),document.getElementById("leadingSilence").textContent=`${e.leadingSilence.toFixed(2)} s`,document.getElementById("trailingSilence").textContent=`${e.trailingSilence.toFixed(2)} s`,document.getElementById("longestSilence").textContent=`${e.longestSilence.toFixed(2)} s`,this.advancedResultsSection.style.display="block"}catch(e){e.message!=="Analysis cancelled"&&(console.error("Advanced analysis error:",e),this.showError(`Advanced analysis failed: ${e.message}`))}finally{this.isAnalyzing=!1,this.advancedProgress.style.display="none",this.advancedAnalysisBtn.style.display="block"}}cancelAdvancedAnalysis(){this.engine.cancelAdvancedAnalysis(),this.isAnalyzing=!1,this.advancedProgress.style.display="none",this.advancedAnalysisBtn.style.display="block"}cancelBatchProcessing(){this.batchCancelled=!0,this.batchProcessor.cancel(),this.batchProgress.style.display="none",this.batchProgressText.textContent="Processing cancelled"}showLoading(){this.hideAllSections(),this.loading.style.display="block"}showResults(){this.hideAllSections(),this.resultsSection.style.display="block";const e=document.getElementById("validationLegend");e&&(e.style.display="block")}showError(e){this.hideAllSections(),this.errorMessage.textContent=e,this.error.style.display="block"}showBatchProgress(e,t,a){this.batchProgress.style.display="block";const i=Math.round(e/t*100);this.batchProgressBar.style.width=`${i}%`,this.batchProgressText.textContent=`${e}/${t} (${i}%)`,this.batchCurrentFile.textContent=a||"Processing..."}initializeBatchResultsTable(){this.hideAllSections(),this.batchProgress.style.display="block",this.batchResultsSection.style.display="block",this.batchTableBody.innerHTML="";const e=this.getPresetConfigurations(),t=this.presetSelector.value,a=e[t],i=(a==null?void 0:a.supportsFilenameValidation)||!1,n=this.currentBatchSource==="box"?i&&this.boxEnableFilenameValidation.checked:this.currentBatchSource==="drive"?i&&this.enableFilenameValidation.checked:this.currentBatchSource==="local"?i&&this.localEnableFilenameValidation.checked:!1,s=this.currentBatchSource==="box"?this.boxEnableAudioAnalysis.checked:this.currentBatchSource==="drive"?this.enableAudioAnalysis.checked:this.currentBatchSource==="local"?this.localEnableAudioAnalysis.checked:!0,o=n&&!s,d=document.querySelector(".batch-results-table");d&&(o?d.classList.add("metadata-only"):d.classList.remove("metadata-only"));const l=document.getElementById("filenameCheckHeader");l&&(l.style.display=n?"":"none"),["sampleRateHeader","bitDepthHeader","channelsHeader","durationHeader"].forEach(h=>{const m=document.getElementById(h);m&&(m.style.display=o?"none":"")}),this.batchTotalDurationContainer&&(this.batchTotalDurationContainer.style.display=o?"none":""),this.batchPassCount.textContent="0",this.batchWarningCount.textContent="0",this.batchFailCount.textContent="0",this.batchErrorCount.textContent="0",this.batchTotalDuration.textContent="0h 0m";const u=document.getElementById("batchValidationLegend");u&&(u.style.display="block")}addBatchResultRow(e){var S,k,A,$,D,z,R,U;const t=this.getPresetConfigurations(),a=this.presetSelector.value,i=t[a],n=(i==null?void 0:i.supportsFilenameValidation)||!1,s=this.currentBatchSource==="box"?n&&this.boxEnableFilenameValidation.checked:this.currentBatchSource==="drive"?n&&this.enableFilenameValidation.checked:this.currentBatchSource==="local"?n&&this.localEnableFilenameValidation.checked:!1,o=this.currentBatchSource==="box"?this.boxEnableAudioAnalysis.checked:this.currentBatchSource==="drive"?this.enableAudioAnalysis.checked:this.currentBatchSource==="local"?this.localEnableAudioAnalysis.checked:!0;if(e.analysis&&!e.error){const P=this.getCriteria(),C=s&&!o,L=(A=(k=(S=e.validation)==null?void 0:S.duration)==null?void 0:k.issue)!=null&&A.includes("SPONTANEOUS")?e.validation.duration:null;e.validation=V.validateResults(e.analysis,P,C),C&&(e.validation.sampleRate&&(e.validation.sampleRate.status="unknown"),e.validation.bitDepth&&(e.validation.bitDepth.status="unknown"),e.validation.channels&&(e.validation.channels.status="unknown"),e.validation.duration&&(e.validation.duration.status="unknown")),L&&(e.validation.duration=L),e.status=this.getOverallStatus(e.validation,!1,e.filenameValidation)}const d=this.batchResults.length-1,l=document.createElement("tr");l.className=`batch-row ${e.status}`;const c=e.analysis?V.formatDisplayText(e.analysis):{},u=this.getValidationStatus(e.validation,"fileType",($=e.analysis)==null?void 0:$.fileType),h=this.getValidationStatus(e.validation,"sampleRate",(D=e.analysis)==null?void 0:D.sampleRate),m=this.getValidationStatus(e.validation,"bitDepth",(z=e.analysis)==null?void 0:z.bitDepth),r=this.getValidationStatus(e.validation,"channels",(R=e.analysis)==null?void 0:R.channels),b=this.getValidationStatus(e.validation,"duration",(U=e.analysis)==null?void 0:U.duration),g=s&&!o;let f="";if(s)if(e.filenameValidation){const P=e.filenameValidation.status==="pass"?"✅":"❌";let C="";e.filenameValidation.status==="pass"?C="Filename is valid":(C=e.filenameValidation.issue,e.filenameValidation.expectedFormat&&(C+=`

Expected: ${e.filenameValidation.expectedFormat}`)),f=`<td class="filename-check-${e.filenameValidation.status}" title="${C}">${P}</td>`}else f='<td style="display: none;"></td>';else f='<td style="display: none;"></td>';const y=g?"":`<td class="validation-${h}">${c.sampleRate||"-"}</td>`,p=g?"":`<td class="validation-${m}">${c.bitDepth||"-"}</td>`,F=g?"":`<td class="validation-${r}">${c.channels||"-"}</td>`,x=g?"":`<td class="validation-${b}">${c.duration||"-"}</td>`;let v="-";e.file||e.driveFileId?v=`<button class="play-btn-small" data-index="${d}">▶</button>`:e.boxFileId&&(v=`<a href="https://app.box.com/file/${e.boxFileId}" target="_blank" title="Open in Box" class="play-btn-small box-link">▶</a>`);const w=O(e.filename);if(l.innerHTML=`
      <td class="filename" title="${w}">${w}</td>
      <td><span class="status-badge ${e.status}">${e.status}</span></td>
      ${f}
      <td class="validation-${u}">${c.fileType||"Unknown"}</td>
      ${y}
      ${p}
      ${F}
      ${x}
      <td>${c.fileSize||"-"}</td>
      <td>${v}</td>
    `,this.batchTableBody.appendChild(l),e.file||e.driveFileId){const P=l.querySelector(".play-btn-small");P&&P.addEventListener("click",C=>{const L=parseInt(C.target.dataset.index);this.playBatchFile(L)})}const B=l.querySelector(".filename-check-pass, .filename-check-fail");B&&this.setupFilenameCheckTooltip(B);const E=l.querySelector(".filename");E&&this.setupFilenameCheckTooltip(E)}setupFilenameCheckTooltip(e){let t=null;e.addEventListener("mouseenter",a=>{const i=e.getAttribute("title");if(!i)return;e.removeAttribute("title"),e.dataset.originalTitle=i,t=document.createElement("div"),t.className="filename-tooltip",t.textContent=i,document.body.appendChild(t);const n=e.getBoundingClientRect();t.style.left=n.left+n.width/2+"px",t.style.top=n.bottom+5+"px"}),e.addEventListener("mouseleave",()=>{t&&(t.remove(),t=null),e.dataset.originalTitle&&e.setAttribute("title",e.dataset.originalTitle)})}updateBatchSummary(){const e=this.batchResults.filter(s=>s.status==="pass").length,t=this.batchResults.filter(s=>s.status==="warning").length,a=this.batchResults.filter(s=>s.status==="fail").length,i=this.batchResults.filter(s=>s.status==="error").length;this.batchPassCount.textContent=e,this.batchWarningCount.textContent=t,this.batchFailCount.textContent=a,this.batchErrorCount.textContent=i;const n=this.batchResults.filter(s=>s.status==="pass"||s.status==="warning").reduce((s,o)=>{var l;const d=(l=o.analysis)==null?void 0:l.duration;return typeof d=="number"&&!isNaN(d)?s+d:s},0);this.batchTotalDuration.textContent=this.formatTotalDuration(n)}showBatchResults(e){this.hideAllSections(),this.batchResultsSection.style.display="block";const t=e.filter(r=>r.status==="pass").length,a=e.filter(r=>r.status==="warning").length,i=e.filter(r=>r.status==="fail").length,n=e.filter(r=>r.status==="error").length;this.batchPassCount.textContent=t,this.batchWarningCount.textContent=a,this.batchFailCount.textContent=i,this.batchErrorCount.textContent=n;const s=e.filter(r=>r.status==="pass"||r.status==="warning").reduce((r,b)=>{var f;const g=(f=b.analysis)==null?void 0:f.duration;return typeof g=="number"&&!isNaN(g)?r+g:r},0);this.batchTotalDuration.textContent=this.formatTotalDuration(s);const o=this.getPresetConfigurations(),d=this.presetSelector.value,l=o[d],c=(l==null?void 0:l.supportsFilenameValidation)||!1,u=this.currentBatchSource==="box"?!1:this.currentBatchSource==="drive"?c&&this.enableFilenameValidation.checked:this.currentBatchSource==="local"?c&&this.localEnableFilenameValidation.checked:!1,h=this.currentBatchSource==="box"?this.boxEnableAudioAnalysis.checked:this.currentBatchSource==="drive"?this.enableAudioAnalysis.checked:this.currentBatchSource==="local"?this.localEnableAudioAnalysis.checked:!0,m=u&&!h;this.batchTableBody.innerHTML="",e.forEach((r,b)=>{var $,D,z,R,U;const g=document.createElement("tr");g.className=`batch-row ${r.status}`;const f=r.analysis?V.formatDisplayText(r.analysis):{},y=this.getValidationStatus(r.validation,"fileType",($=r.analysis)==null?void 0:$.fileType),p=this.getValidationStatus(r.validation,"sampleRate",(D=r.analysis)==null?void 0:D.sampleRate),F=this.getValidationStatus(r.validation,"bitDepth",(z=r.analysis)==null?void 0:z.bitDepth),x=this.getValidationStatus(r.validation,"channels",(R=r.analysis)==null?void 0:R.channels),v=this.getValidationStatus(r.validation,"duration",(U=r.analysis)==null?void 0:U.duration);let w="";if(u)if(r.filenameValidation){const P=r.filenameValidation.status==="pass"?"✅":"❌";let C="";r.filenameValidation.status==="pass"?C="Filename is valid":(C=r.filenameValidation.issue,r.filenameValidation.expectedFormat&&(C+=`

Expected: ${r.filenameValidation.expectedFormat}`)),w=`<td class="filename-check-${r.filenameValidation.status}" title="${C}">${P}</td>`}else w='<td style="display: none;"></td>';else w='<td style="display: none;"></td>';const B=m?"":`<td class="validation-${p}">${f.sampleRate||"-"}</td>`,E=m?"":`<td class="validation-${F}">${f.bitDepth||"-"}</td>`,S=m?"":`<td class="validation-${x}">${f.channels||"-"}</td>`,k=m?"":`<td class="validation-${v}">${f.duration||"-"}</td>`,A=O(r.filename);g.innerHTML=`
        <td class="filename" title="${A}">${A}</td>
        <td><span class="status-badge ${r.status}">${r.status}</span></td>
        ${w}
        <td class="validation-${y}">${f.fileType||"Unknown"}</td>
        ${B}
        ${E}
        ${S}
        ${k}
        <td>${f.fileSize||"-"}</td>
        <td><button class="play-btn-small" data-index="${b}">▶</button></td>
      `,this.batchTableBody.appendChild(g)}),this.batchResults=e,this.batchTableBody.querySelectorAll(".play-btn-small").forEach(r=>{r.addEventListener("click",b=>{const g=parseInt(b.target.dataset.index);this.playBatchFile(g)})}),this.batchTableBody.querySelectorAll(".filename").forEach(r=>{this.setupFilenameCheckTooltip(r)}),document.getElementById("batchValidationLegend").style.display="block"}formatValue(e){return e==null||e==="Unknown"?"-":e}formatDuration(e){if(!e||e==="Unknown")return"-";const t=Math.floor(e/60),a=Math.floor(e%60);return`${t}:${a.toString().padStart(2,"0")}`}formatTotalDuration(e){if(!e||e===0)return"0h 0m 0s";const t=Math.floor(e/3600),a=Math.floor(e%3600/60),i=Math.floor(e%60);return t>0?`${t}h ${a}m ${i}s`:a>0?`${a}m ${i}s`:`${i}s`}getValidationStatus(e,t,a){return e&&e[t]?e[t].status:a==="Unknown"?"warning":"pass"}playBatchFile(e){if(!this.batchResults||!this.batchResults[e])return;const t=this.batchResults[e];if(t.file){const a=URL.createObjectURL(t.file);window.open(a,"_blank"),setTimeout(()=>URL.revokeObjectURL(a),1e3)}else if(t.driveFileId){const a=`https://drive.google.com/file/d/${t.driveFileId}/view`;window.open(a,"_blank")}}revalidateBatchResults(){if(!this.batchResults)return;const e=this.getCriteria(),t=this.getPresetConfigurations(),a=this.presetSelector.value,i=t[a],n=(i==null?void 0:i.supportsFilenameValidation)||!1,s=this.currentBatchSource==="box"?n&&this.boxEnableFilenameValidation.checked:this.currentBatchSource==="drive"?n&&this.enableFilenameValidation.checked:this.currentBatchSource==="local"?n&&this.localEnableFilenameValidation.checked:!1,o=this.currentBatchSource==="box"?this.boxEnableAudioAnalysis.checked:this.currentBatchSource==="drive"?this.enableAudioAnalysis.checked:this.currentBatchSource==="local"?this.localEnableAudioAnalysis.checked:!0,d=s&&!o,l=document.getElementById("filenameCheckHeader");l&&(l.style.display=s?"":"none"),["sampleRateHeader","bitDepthHeader","channelsHeader","durationHeader"].forEach(u=>{const h=document.getElementById(u);h&&(h.style.display=d?"none":"")}),this.batchResults.forEach(u=>{u.analysis&&(u.validation=V.validateResults(u.analysis,e),u.status=this.getOverallStatus(u.validation,!1,u.filenameValidation))}),this.showBatchResults(this.batchResults)}getOverallStatus(e,t=!1,a=null){let i=Object.values(e).map(n=>n.status);if(t){const n=["sampleRate","bitDepth","channels"];i=Object.entries(e).filter(([s])=>!n.includes(s)).map(([,s])=>s.status)}return a&&a.status&&i.push(a.status),i.includes("fail")?"fail":i.includes("warning")?"warning":"pass"}getFileTypeFromName(e){const t=e.split(".").pop().toLowerCase();return{wav:"WAV",mp3:"MP3",flac:"FLAC",aac:"AAC",m4a:"M4A",ogg:"OGG"}[t]||t.toUpperCase()}cleanupForNewFile(){this.currentFile&&(this.currentFile=null),this.audioBuffer&&(this.audioBuffer=null),this.currentResults&&(this.currentResults=null),this.audioPlayer&&this.audioPlayer.src&&(this.audioPlayer.src.startsWith("blob:")&&URL.revokeObjectURL(this.audioPlayer.src),this.audioPlayer.src="")}cleanup(){this.cleanupForNewFile(),this.engine.audioAnalyzer.audioContext,window.gc&&typeof window.gc=="function"&&window.gc()}hideAllSections(){this.loading.style.display="none",this.error.style.display="none",this.resultsSection.style.display="none",this.advancedResultsSection.style.display="none",this.batchProgress.style.display="none",this.batchResultsSection.style.display="none",document.getElementById("validationLegend").style.display="none",document.getElementById("batchValidationLegend").style.display="none"}}document.addEventListener("DOMContentLoaded",()=>{const I=new X;window.addEventListener("beforeunload",()=>{I.cleanup()}),document.addEventListener("visibilitychange",()=>{document.hidden&&I.cleanup()})});
