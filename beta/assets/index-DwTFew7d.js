(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();class b{constructor(){this.audioContext=null,this.audioBuffer=null}async analyzeFile(e){const t=await e.arrayBuffer();if(e.name.toLowerCase().endsWith(".wav")){const n=new DataView(t),s=this.parseWavHeaders(n);let a=this.getFileType(e.name);return a==="WAV"&&(s.audioFormat===1?a="WAV (PCM)":typeof s.audioFormat=="number"?a=`WAV (Compressed - Format ${s.audioFormat})`:a="WAV (Unknown Format)"),{fileType:a,sampleRate:s.sampleRate,channels:s.channels,bitDepth:s.bitDepth,duration:s.duration,fileSize:e.size}}this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext));try{return this.audioBuffer=await this.audioContext.decodeAudioData(t),{fileType:this.getFileType(e.name),sampleRate:this.audioBuffer.sampleRate,channels:this.audioBuffer.numberOfChannels,duration:this.audioBuffer.duration,fileSize:e.size,bitDepth:this.estimateBitDepth(t,e.name)}}catch{return await this.analyzeFileHeaders(t,e.name,e.size)}}async analyzeFileHeaders(e,t,n){const s=new DataView(e),a={fileType:this.getFileType(t),fileSize:n};if(t.toLowerCase().endsWith(".wav")){const i=this.parseWavHeaders(s);Object.assign(a,i)}else a.sampleRate="Unknown",a.bitDepth="Unknown",a.channels="Unknown",a.duration="Unknown";return a}parseWavHeaders(e){try{if(String.fromCharCode(e.getUint8(0),e.getUint8(1),e.getUint8(2),e.getUint8(3))!=="RIFF")throw new Error("Not a valid WAV file");if(String.fromCharCode(e.getUint8(8),e.getUint8(9),e.getUint8(10),e.getUint8(11))!=="WAVE")throw new Error("Not a valid WAV file");let s=12;for(;s<e.byteLength-8;){const a=String.fromCharCode(e.getUint8(s),e.getUint8(s+1),e.getUint8(s+2),e.getUint8(s+3)),i=e.getUint32(s+4,!0);if(a==="fmt "){const o=e.getUint16(s+8,!0),r=e.getUint16(s+10,!0),l=e.getUint32(s+12,!0),h=e.getUint16(s+22,!0),d=this.calculateWavDuration(e,l,r,h);return{sampleRate:l,channels:r,bitDepth:h,duration:d,audioFormat:o}}s+=8+i}throw new Error("fmt chunk not found")}catch(t){return console.error("Error parsing WAV headers:",t),{sampleRate:"Unknown",channels:"Unknown",bitDepth:"Unknown",duration:"Unknown",audioFormat:"Unknown"}}}calculateWavDuration(e,t,n,s){try{let a=12;for(;a<e.byteLength-8;){const i=String.fromCharCode(e.getUint8(a),e.getUint8(a+1),e.getUint8(a+2),e.getUint8(a+3)),o=e.getUint32(a+4,!0);if(i==="data"){const r=s/8;return o/(n*r)/t}a+=8+o}return"Unknown"}catch{return"Unknown"}}getFileType(e){const t=e.split(".").pop().toLowerCase();return{wav:"WAV",mp3:"MP3",flac:"FLAC",aac:"AAC",m4a:"M4A",ogg:"OGG",webm:"WebM"}[t]||t.toUpperCase()}estimateBitDepth(e,t){if(t.toLowerCase().endsWith(".wav"))return"See WAV analysis";const n=t.split(".").pop().toLowerCase();return["mp3","aac","m4a"].includes(n)?"Compressed (variable)":"Unknown"}}class m{static matchesFileType(e,t){const n={matches:!1,status:"fail"};if(e===t)return n.matches=!0,n.status="pass",n;if(t==="wav"||t==="WAV")return e==="WAV (PCM)"?(n.matches=!0,n.status="pass",n):(e.startsWith("WAV")&&(n.matches=!0,n.status="warning"),n);const s=e.replace(/\s*\(.*\)/,"").trim(),a=t.toUpperCase();return s===a&&(n.matches=!0,n.status="pass"),n}static validateResults(e,t){const n={};if(t.sampleRate){const o=parseInt(t.sampleRate),r=e.sampleRate;let l="fail";r===o?l="pass":r>o&&(l="warning"),n.sampleRate={matches:r>=o,target:o,actual:r,status:l}}if(t.bitDepth){const o=parseInt(t.bitDepth),r=e.bitDepth;let l="fail";r===o?l="pass":r>o&&(l="warning"),n.bitDepth={matches:r>=o,target:o,actual:r,status:l}}if(t.channels){const o=parseInt(t.channels),r=e.channels===o;n.channels={matches:r,target:o,actual:e.channels,status:r?"pass":"fail"}}if(t.fileType){const o=this.matchesFileType(e.fileType,t.fileType);n.fileType={matches:o.matches,target:t.fileType,actual:e.fileType,status:o.status}}const s=e.duration;let a="fail",i=!1;return s>=120?(a="pass",i=!0):s>=60&&(a="warning",i=!1),n.duration={matches:i,target:"2+ minutes",actual:s,status:a},n}static formatDuration(e){const t=Math.floor(e/3600),n=Math.floor(e%3600/60),s=Math.floor(e%60);return t>0?`${t}h:${n.toString().padStart(2,"0")}m:${s.toString().padStart(2,"0")}s`:`${n}m:${s.toString().padStart(2,"0")}s`}static formatDisplayText(e){const t={};return t.fileType=e.fileType,t.sampleRate=typeof e.sampleRate=="number"?`${(e.sampleRate/1e3).toFixed(1)} kHz`:e.sampleRate,t.bitDepth=typeof e.bitDepth=="number"?`${e.bitDepth}-bit`:e.bitDepth,t.channels=typeof e.channels=="number"?`${e.channels}${e.channels===1?" (Mono)":e.channels===2?" (Stereo)":""}`:e.channels,t.duration=typeof e.duration=="number"?this.formatDuration(e.duration):e.duration,t.fileSize=`${(e.fileSize/1024/1024).toFixed(2)} MB`,t}static formatAdvancedResults(e){const t={};return t.peakLevel=e.peakDb===-1/0?"Silent":`${e.peakDb.toFixed(1)} dB`,t.peakStatus=e.peakDb<=-6?"pass":e.peakDb<=-3?"warning":"fail",t.noiseFloor=e.noiseFloorDb===-1/0?"Silent":`${e.noiseFloorDb.toFixed(1)} dB`,t.noiseStatus=e.noiseFloorDb<=-60?"pass":"fail",t.normalization=e.normalizationStatus.message,t.normalizationStatus=e.normalizationStatus.status==="normalized"?"pass":"fail",t}}class S{constructor(){this.analysisInProgress=!1}async analyzeAudioBuffer(e,t=null){e.sampleRate;const n=e.numberOfChannels,s=e.length,a=[];for(let i=0;i<n;i++)a.push(e.getChannelData(i));this.analysisInProgress=!0;try{t&&t("Analyzing peak levels...",0);let i=0;for(let h=0;h<n;h++){const d=a[h];for(let c=0;c<s;c++){if(!this.analysisInProgress)throw new Error("Analysis cancelled");const g=Math.abs(d[c]);if(g>i&&(i=g),c%1e4===0){const p=(h*s+c)/(n*s)*.5;t&&t("Analyzing peak levels...",p),c%1e5===0&&await new Promise(y=>setTimeout(y,1))}}}const o=i>0?20*Math.log10(i):-1/0;t&&t("Analyzing noise floor...",.5);const r=await this.analyzeNoiseFloor(a,n,s,t);t&&t("Checking normalization...",.9);const l=this.checkNormalization(o);return t&&t("Analysis complete!",1),{peakDb:o,noiseFloorDb:r,normalizationStatus:l}}finally{this.analysisInProgress=!1}}async analyzeNoiseFloor(e,t,n,s){const a=Math.floor(n/100),i=[];for(let d=0;d<t;d++){const c=e[d];for(let g=0;g<n-a;g+=a){let p=0;for(let f=g;f<g+a&&f<n;f++)p+=c[f]*c[f];const y=Math.sqrt(p/a);i.push(y)}}i.sort((d,c)=>d-c);const o=Math.floor(i.length*.2),r=i.slice(0,o),l=r.reduce((d,c)=>d+c,0)/r.length;return l>0?20*Math.log10(l):-1/0}checkNormalization(e){return Math.abs(e- -6)<=.1?{status:"normalized",message:"Properly normalized to -6dB"}:e>-6?{status:"too_loud",message:`Too loud: ${e.toFixed(1)}dB (target: -6dB)`}:{status:"too_quiet",message:`Too quiet: ${e.toFixed(1)}dB (target: -6dB)`}}cancelAnalysis(){this.analysisInProgress=!1}}class v{async analyzeHeaders(e){const n=await e.slice(0,102400).arrayBuffer(),s=new DataView(n),a={filename:e.name,fileSize:e.size,fileType:this.getFileType(e.name)};if(e.name.toLowerCase().endsWith(".wav")){const i=this.parseWavHeaders(s,e.size);Object.assign(a,i),i.formatType&&(a.fileType=i.formatType)}else e.name.toLowerCase().endsWith(".mp3")?Object.assign(a,this.parseMp3Headers(s,e.size)):e.name.toLowerCase().endsWith(".flac")?Object.assign(a,this.parseFlacHeaders(s,e.size)):(a.sampleRate="Unknown",a.bitDepth="Unknown",a.channels="Unknown",a.duration="Unknown");return a}parseWavHeaders(e,t){try{if(String.fromCharCode(e.getUint8(0),e.getUint8(1),e.getUint8(2),e.getUint8(3))!=="RIFF")throw new Error("Not a valid WAV file");if(String.fromCharCode(e.getUint8(8),e.getUint8(9),e.getUint8(10),e.getUint8(11))!=="WAVE")throw new Error("Not a valid WAV file");let a=12;for(;a<e.byteLength-8;){const i=String.fromCharCode(e.getUint8(a),e.getUint8(a+1),e.getUint8(a+2),e.getUint8(a+3)),o=e.getUint32(a+4,!0);if(i==="fmt "){const r=e.getUint16(a+8,!0),l=e.getUint16(a+10,!0),h=e.getUint32(a+12,!0),d=e.getUint16(a+22,!0),c=e.getUint32(a+16,!0),g=t-44,p=c>0?g/c:"Unknown";return{sampleRate:h,channels:l,bitDepth:d,duration:typeof p=="number"?p:"Unknown",audioFormat:r,formatType:r===1?"WAV (PCM)":`WAV (Format ${r})`}}a+=8+o}throw new Error("fmt chunk not found")}catch{return{sampleRate:"Unknown",channels:"Unknown",bitDepth:"Unknown",duration:"Unknown",formatType:"WAV"}}}parseMp3Headers(e){try{let t=0;for(;t<e.byteLength-4;){if(e.getUint8(t)===255&&(e.getUint8(t+1)&224)===224){const n=e.getUint32(t,!1),s=n>>19&3,a=n>>17&3,i=n>>12&15,o=n>>10&3,r=n>>6&3,l=[44100,48e3,32e3],h=r===3?1:2;return{sampleRate:l[o]||"Unknown",channels:h,bitDepth:"Compressed (variable)",duration:"Unknown"}}t++}throw new Error("No MP3 frame found")}catch{return{sampleRate:"Unknown",channels:"Unknown",bitDepth:"Compressed (variable)",duration:"Unknown"}}}parseFlacHeaders(e){try{if(String.fromCharCode(e.getUint8(0),e.getUint8(1),e.getUint8(2),e.getUint8(3))!=="fLaC")throw new Error("Not a valid FLAC file");const n=e.getUint8(4),s=(n&128)!==0;if((n&127)===0){const i=e.getUint16(5,!1),o=e.getUint16(7,!1),r=e.getUint16(18,!1),l=e.getUint8(20),h=r<<4|l>>4,d=(l>>1&7)+1,c=((l&1)<<4|e.getUint8(21)>>4)+1;return{sampleRate:h,channels:d,bitDepth:c,duration:"Unknown"}}throw new Error("STREAMINFO block not found")}catch{return{sampleRate:"Unknown",channels:"Unknown",bitDepth:"Unknown",duration:"Unknown"}}}getFileType(e){const t=e.split(".").pop().toLowerCase();return{wav:"WAV",mp3:"MP3",flac:"FLAC",aac:"AAC",m4a:"M4A",ogg:"OGG"}[t]||t.toUpperCase()}}class F{constructor(e){this.analyzer=new v,this.validator=e,this.cancelled=!1}async processBatch(e,t,n){this.cancelled=!1;const s=[],a=Date.now();for(let i=0;i<e.length&&!this.cancelled;i++){const o=e[i];try{const r=await this.analyzer.analyzeHeaders(o),l=this.validator.validateResults(r,t);s.push({filename:o.name,file:o,analysis:r,validation:l,status:this.getOverallStatus(l)}),n&&n({current:i+1,total:e.length,currentFile:o.name,percentage:(i+1)/e.length*100,elapsedTime:Date.now()-a})}catch(r){s.push({filename:o.name,file:o,analysis:null,validation:null,status:"error",error:r.message})}}return s}getOverallStatus(e){const t=Object.values(e).map(n=>n.status);return t.includes("fail")?"fail":t.includes("warning")?"warning":"pass"}cancel(){this.cancelled=!0}}const A=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",B=window.location.pathname.startsWith("/beta"),I=A?"http://localhost:3000":B?"https://audio-analyzer.tinytech.site/beta":"https://audio-analyzer.tinytech.site",w={CLIENT_ID:"708688597317-bmmrje6hqg8vo52nctned54m32q8uhsr.apps.googleusercontent.com",REDIRECT_URI:I,SCOPE:"https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email",DISCOVERY_DOCS:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]};class k{constructor(){this.isInitialized=!1,this.accessToken=null,this.codeClient=null,this.userInfo=null}async init(){if(!this.isInitialized)return new Promise((e,t)=>{this.loadGoogleAPI().then(()=>{this.initializeGIS().then(e).catch(t)}).catch(t)})}async loadGoogleAPI(){return new Promise((e,t)=>{if(window.gapi){e();return}const n=document.createElement("script");n.src="https://apis.google.com/js/api.js",n.onload=()=>e(),n.onerror=()=>t(new Error("Failed to load Google API script")),document.head.appendChild(n)})}async initializeGIS(){return new Promise((e,t)=>{const n=document.createElement("script");n.src="https://accounts.google.com/gsi/client",n.onload=()=>{this.setupGIS().then(e).catch(t)},n.onerror=()=>t(new Error("Failed to load Google Identity Services")),document.head.appendChild(n)})}async setupGIS(){return new Promise((e,t)=>{const n=setTimeout(()=>{t(new Error("Google API setup timeout"))},1e4);window.gapi.load("client",async()=>{try{clearTimeout(n),await window.gapi.client.init({discoveryDocs:w.DISCOVERY_DOCS}),this.tokenClient=window.google.accounts.oauth2.initTokenClient({client_id:w.CLIENT_ID,scope:w.SCOPE,callback:s=>{if(s.error){console.error("Token response error:",s),t(new Error(`Google sign-in failed: ${s.error}`));return}this.accessToken=s.access_token;const a={access_token:s.access_token,expires_at:Date.now()+s.expires_in*1e3,scope:s.scope};localStorage.setItem("google_token",JSON.stringify(a)),e(a)}}),this.isInitialized=!0,e()}catch(s){clearTimeout(n),console.error("Google API setup error:",s);let a="Unknown setup error";s&&typeof s=="object"?a=s.message||s.error||s.details||JSON.stringify(s):s&&(a=s.toString()),t(new Error(`Failed to setup Google API: ${a}`))}})})}async signIn(){return this.isInitialized||await this.init(),new Promise((e,t)=>{try{this.tokenClient.callback=n=>{if(n.error){console.error("Token response error:",n),t(new Error(`Google sign-in failed: ${n.error}`));return}if(!(n.scope&&n.scope.includes("https://www.googleapis.com/auth/drive.readonly"))){console.warn("Drive scope not granted, retrying with consent prompt"),this.tokenClient.requestAccessToken({prompt:"consent"});return}this.accessToken=n.access_token;const a={access_token:n.access_token,expires_at:Date.now()+n.expires_in*1e3,scope:n.scope};localStorage.setItem("google_token",JSON.stringify(a)),e(a)},this.tokenClient.requestAccessToken({prompt:""})}catch(n){console.error("Google sign-in error:",n);let s="Unknown sign-in error";n&&typeof n=="object"?s=n.error||n.message||n.details||JSON.stringify(n):n&&(s=n.toString()),t(new Error(`Google sign-in failed: ${s}`))}})}async getValidToken(){const e=localStorage.getItem("google_token");if(e)try{const t=JSON.parse(e);if(t.expires_at>Date.now()+3e5)return this.accessToken=t.access_token,t}catch(t){console.warn("Invalid stored token:",t),localStorage.removeItem("google_token")}return await this.signIn()}async getUserInfo(){const e=await this.getValidToken();try{const t=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${e.access_token}`}});if(!t.ok)throw new Error(`Failed to get user info: ${t.status}`);const n=await t.json();return this.userInfo=n,n}catch(t){throw new Error(`Failed to get user info: ${t.message}`)}}async downloadFile(e){const t=await this.getValidToken();try{const n=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?fields=name,mimeType,size`,{headers:{Authorization:`Bearer ${t.access_token}`}});if(!n.ok)throw n.status===403?(this.signOut(),new Error("Insufficient permissions to access Google Drive. Please sign in again and grant Drive access.")):new Error(`Failed to get file metadata: ${n.status}`);const s=await n.json(),a=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:{Authorization:`Bearer ${t.access_token}`}});if(!a.ok)throw new Error(`Failed to download file: ${a.status}`);const i=await a.blob();return new File([i],s.name,{type:s.mimeType||"audio/mpeg"})}catch(n){throw new Error(`Google Drive download failed: ${n.message}`)}}async listAudioFilesInFolder(e){const t=await this.getValidToken();try{const s=["audio/mpeg","audio/wav","audio/x-wav","audio/wave","audio/flac","audio/x-flac","audio/aac","audio/mp4","audio/ogg","audio/x-m4a"].map(r=>`mimeType='${r}'`).join(" or "),a=`'${e}' in parents and (${s}) and trashed=false`,i=await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(a)}&fields=files(id,name,mimeType,size,modifiedTime)&pageSize=1000`,{headers:{Authorization:`Bearer ${t.access_token}`}});if(!i.ok)throw i.status===403?(this.signOut(),new Error("Insufficient permissions to access Google Drive folder. Please sign in again.")):new Error(`Failed to list folder contents: ${i.status}`);return(await i.json()).files||[]}catch(n){throw new Error(`Failed to list folder: ${n.message}`)}}async downloadFileHeaders(e,t=102400){const n=await this.getValidToken();try{const s=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:{Authorization:`Bearer ${n.access_token}`,Range:`bytes=0-${t-1}`}});if(!s.ok&&s.status!==206)throw new Error(`Failed to download file headers: ${s.status}`);return await s.blob()}catch(s){throw new Error(`Failed to download headers: ${s.message}`)}}signOut(){this.accessToken&&window.google&&window.google.accounts.oauth2.revoke(this.accessToken),this.accessToken=null,localStorage.removeItem("google_token")}isSignedIn(){const e=localStorage.getItem("google_token");if(!e)return!1;try{return JSON.parse(e).expires_at>Date.now()}catch{return!1}}}class E{constructor(){this.audioAnalyzer=new b,this.levelAnalyzer=new S}async analyzeFile(e){return await this.audioAnalyzer.analyzeFile(e)}async analyzeAdvanced(e,t){return await this.levelAnalyzer.analyzeAudioBuffer(e,t)}validateCriteria(e,t){return m.validateResults(e,t)}formatResults(e){return m.formatDisplayText(e)}formatAdvancedResults(e){return m.formatAdvancedResults(e)}cancelAdvancedAnalysis(){this.levelAnalyzer.cancelAnalysis()}}class C{constructor(){this.engine=new E,this.googleAuth=new k,this.batchProcessor=new F(m),this.currentFile=null,this.audioBuffer=null,this.isAnalyzing=!1,this.currentResults=null,this.processingFile=!1,this.batchMode=!1,this.batchResults=null,this.initializeElements(),this.attachEventListeners(),this.loadSettings()}initializeElements(){this.tabButtons=document.querySelectorAll(".tab-button"),this.tabContents=document.querySelectorAll(".tab-content"),this.dropZone=document.getElementById("dropZone"),this.browseBtn=document.getElementById("browseBtn"),this.fileInput=document.getElementById("fileInput"),this.driveUrl=document.getElementById("driveUrl"),this.analyzeUrl=document.getElementById("analyzeUrl"),this.authText=document.getElementById("authText"),this.signInBtn=document.getElementById("signInBtn"),this.signOutBtn=document.getElementById("signOutBtn"),this.presetSelector=document.getElementById("presetSelector"),this.targetFileType=document.getElementById("targetFileType"),this.targetSampleRate=document.getElementById("targetSampleRate"),this.targetBitDepth=document.getElementById("targetBitDepth"),this.targetChannels=document.getElementById("targetChannels"),this.playerSection=document.getElementById("playerSection"),this.resultsSection=document.getElementById("resultsSection"),this.advancedResultsSection=document.getElementById("advancedResultsSection"),this.audioPlayer=document.getElementById("audioPlayer"),this.playPause=document.getElementById("playPause"),this.advancedAnalysisBtn=document.getElementById("advancedAnalysisBtn"),this.advancedProgress=document.getElementById("advancedProgress"),this.progressFill=document.getElementById("progressFill"),this.progressText=document.getElementById("progressText"),this.cancelAnalysis=document.getElementById("cancelAnalysis"),this.loading=document.getElementById("loading"),this.error=document.getElementById("error"),this.errorMessage=document.getElementById("errorMessage"),this.batchProgress=document.getElementById("batchProgress"),this.batchCurrentFile=document.getElementById("batchCurrentFile"),this.batchProgressText=document.getElementById("batchProgressText"),this.batchProgressBar=document.getElementById("batchProgressBar"),this.cancelBatch=document.getElementById("cancelBatch"),this.batchResultsSection=document.getElementById("batchResultsSection"),this.batchPassCount=document.getElementById("batchPassCount"),this.batchWarningCount=document.getElementById("batchWarningCount"),this.batchFailCount=document.getElementById("batchFailCount"),this.batchTableBody=document.getElementById("batchTableBody")}attachEventListeners(){this.tabButtons.forEach(e=>{e.addEventListener("click",()=>this.switchTab(e.dataset.tab))}),this.browseBtn.addEventListener("click",e=>{e.stopPropagation(),this.fileInput.value="",this.fileInput.click()}),this.fileInput.addEventListener("change",e=>{const t=Array.from(e.target.files||[]);t.length>0&&this.handleFilesSelect(t)}),this.dropZone.addEventListener("dragover",e=>{e.preventDefault(),this.dropZone.classList.add("drag-over")}),this.dropZone.addEventListener("dragleave",()=>{this.dropZone.classList.remove("drag-over")}),this.dropZone.addEventListener("drop",e=>{e.preventDefault(),this.dropZone.classList.remove("drag-over");const t=Array.from(e.dataTransfer.files||[]).filter(n=>n.type.startsWith("audio/"));t.length>0&&this.handleFilesSelect(t)}),this.dropZone.addEventListener("click",()=>this.fileInput.click()),this.analyzeUrl.addEventListener("click",()=>this.handleGoogleDriveUrl()),this.driveUrl.addEventListener("keypress",e=>{e.key==="Enter"&&this.handleGoogleDriveUrl()}),this.signInBtn.addEventListener("click",()=>this.handleSignIn()),this.signOutBtn.addEventListener("click",()=>this.handleSignOut()),this.presetSelector.addEventListener("change",()=>this.handlePresetChange()),[this.targetFileType,this.targetSampleRate,this.targetBitDepth,this.targetChannels].forEach(e=>{e.addEventListener("change",()=>this.saveCriteria())}),this.playPause.addEventListener("click",()=>this.togglePlayback()),this.audioPlayer.addEventListener("loadedmetadata",()=>{this.playPause.textContent="Play"}),this.advancedAnalysisBtn.addEventListener("click",()=>this.runAdvancedAnalysis()),this.cancelAnalysis.addEventListener("click",()=>this.cancelAdvancedAnalysis())}loadSettings(){const e=localStorage.getItem("audio-analyzer-settings");if(e)try{const n=JSON.parse(e);if(n.criteria){this.targetFileType.value=n.criteria.fileType||"",this.targetSampleRate.value=n.criteria.sampleRate||"";const s=n.criteria.bitDepth;this.targetBitDepth.value=Array.isArray(s)?s[0]||"":s||"",this.targetChannels.value=n.criteria.channels||""}}catch(n){console.warn("Failed to load settings from localStorage:",n)}const t=localStorage.getItem("audio-analyzer-selected-preset");t?(this.presetSelector.value=t,this.handlePresetChange()):(this.presetSelector.value="auditions",this.handlePresetChange()),this.updateAuthStatus()}updateAuthStatus(){if(this.googleAuth.isSignedIn()){const t=this.googleAuth.getUserInfo();t&&t.name?this.authText.textContent=`✓ Signed in as ${t.name}`:this.authText.textContent="✓ Signed in to Google Drive",this.signInBtn.style.display="none",this.signOutBtn.style.display="inline-block"}else this.authText.textContent="Not signed in to Google",this.signInBtn.style.display="inline-block",this.signOutBtn.style.display="none"}async handleSignIn(){try{await this.googleAuth.signIn(),this.updateAuthStatus()}catch(e){console.error("Sign-in failed:",e),this.showError(`Google sign-in failed: ${e.message}`)}}handleSignOut(){this.googleAuth.signOut(),this.updateAuthStatus()}getCriteria(){return{fileType:this.targetFileType.value,sampleRate:this.targetSampleRate.value,bitDepth:this.targetBitDepth.value,channels:this.targetChannels.value}}saveCriteria(){const t={criteria:this.getCriteria()};localStorage.setItem("audio-analyzer-settings",JSON.stringify(t)),this.currentResults&&this.validateAndDisplayResults(this.currentResults),this.batchResults&&this.batchMode&&this.revalidateBatchResults()}getPresetConfigurations(){return{auditions:{name:"Auditions",fileType:"wav",sampleRate:"48000",bitDepth:"24",channels:"1"},"character-recordings":{name:"Character Recordings",fileType:"wav",sampleRate:"48000",bitDepth:"24",channels:"1"},custom:{name:"Custom"},"p2b2-pairs":{name:"P2B2 Pairs",fileType:"wav",sampleRate:"48000",bitDepth:"16",channels:"2"},"three-hour":{name:"Three Hour",fileType:"wav",sampleRate:"48000",bitDepth:"24",channels:""}}}handlePresetChange(){const e=this.presetSelector.value,t=document.getElementById("customCriteriaSection");if(e){if(e==="custom")t.style.display="block";else{t.style.display="none";const s=this.getPresetConfigurations()[e];s&&(this.targetFileType.value=s.fileType||"",this.targetSampleRate.value=s.sampleRate||"",this.targetBitDepth.value=s.bitDepth||"",this.targetChannels.value=s.channels||"",this.saveCriteria(),this.currentResults&&this.validateAndDisplayResults(this.currentResults),this.batchResults&&this.batchMode&&this.revalidateBatchResults())}localStorage.setItem("audio-analyzer-selected-preset",e)}}switchTab(e){this.tabButtons.forEach(t=>t.classList.remove("active")),this.tabContents.forEach(t=>t.classList.remove("active")),document.querySelector(`[data-tab="${e}"]`).classList.add("active"),document.querySelector(`.tab-content[data-tab="${e}"]`).classList.add("active")}async handleFilesSelect(e){if(!(!e||e.length===0)){if(this.processingFile){console.log("Already processing files, ignoring duplicate call");return}e.length===1?(this.batchMode=!1,await this.handleFileSelect(e[0])):(this.batchMode=!0,await this.handleBatchFiles(e))}}async handleFileSelect(e){if(console.log("handleFileSelect called with:",e),!e){console.log("No file provided to handleFileSelect");return}if(this.processingFile){console.log("Already processing a file, ignoring duplicate call");return}this.processingFile=!0,console.log("Starting file processing..."),this.cleanupForNewFile(),this.currentFile=e,console.log("Showing loading screen..."),this.showLoading();try{console.log("Starting analysis with core engine...");const t=await this.engine.analyzeFile(e);console.log("Analysis results:",t),this.currentResults=t,console.log("Setting up audio player..."),this.setupAudioPlayer(e),console.log("Validating and displaying results..."),this.validateAndDisplayResults(t),this.showResults(),console.log("Results displayed successfully")}catch(t){console.error("Analysis error:",t),this.showError(`Failed to analyze file: ${t.message}`),this.cleanupForNewFile()}finally{this.processingFile=!1,console.log("File processing completed")}}async handleBatchFiles(e){this.processingFile=!0,this.cleanupForNewFile(),console.log(`Starting batch processing of ${e.length} files`),this.showBatchProgress(0,e.length,"Initializing...");try{const t=this.getCriteria(),n=await this.batchProcessor.processBatch(e,t,s=>{this.showBatchProgress(s.current,s.total,s.currentFile)});this.batchResults=n,this.showBatchResults(n)}catch(t){console.error("Batch processing error:",t),this.showError(`Failed to process batch: ${t.message}`),this.cleanupForNewFile()}finally{this.processingFile=!1}}async handleGoogleDriveUrl(){const e=this.driveUrl.value.trim();if(e){if(this.processingFile){console.log("Already processing a file, ignoring Google Drive request");return}this.processingFile=!0,this.cleanupForNewFile(),this.showLoading();try{const t=this.extractFileIdFromUrl(e);if(!t)throw new Error("Invalid Google Drive URL. Please ensure it's a valid Drive file or folder link.");this.updateAuthStatus(),t.isFolder?await this.handleGoogleDriveFolder(t.id):await this.handleGoogleDriveFile(t.id)}catch(t){console.error("Google Drive error:",t),this.cleanupForNewFile(),t.message.includes("sign-in")||t.message.includes("auth")?this.showError('Please sign in to Google to access Drive files. Click "Analyze" to authenticate.'):this.showError(`Failed to process Google Drive: ${t.message}`)}finally{this.processingFile=!1}}}async handleGoogleDriveFile(e){const t=await this.googleAuth.downloadFile(e);this.currentFile=t;const n=await this.engine.analyzeFile(t);this.currentResults=n,this.setupAudioPlayer(t),this.validateAndDisplayResults(n),this.showResults()}async handleGoogleDriveFolder(e){const t=await this.googleAuth.listAudioFilesInFolder(e);if(t.length===0)throw new Error("No audio files found in this folder");console.log(`Found ${t.length} audio files in folder`),this.batchMode=!0,this.showBatchProgress(0,t.length,"Initializing...");const n=this.getCriteria(),s=[];for(let a=0;a<t.length;a++){const i=t[a];try{this.showBatchProgress(a,t.length,i.name);const o=await this.googleAuth.downloadFileHeaders(i.id),r=new File([o],i.name,{type:i.mimeType,lastModified:new Date(i.modifiedTime).getTime()}),l=await this.batchProcessor.analyzer.analyzeHeaders(r),h=m.validateResults(l,n);s.push({filename:i.name,file:null,analysis:l,validation:h,status:this.getOverallStatus(h)})}catch(o){console.error(`Error processing ${i.name}:`,o),s.push({filename:i.name,file:null,analysis:null,validation:null,status:"error",error:o.message})}this.showBatchProgress(a+1,t.length,i.name)}this.showBatchResults(s)}extractFileIdFromUrl(e){const t=[/\/file\/d\/([a-zA-Z0-9-_]+)/,/\/folders\/([a-zA-Z0-9-_]+)/,/[?&]id=([a-zA-Z0-9-_]+)/,/^([a-zA-Z0-9-_]+)$/];for(const n of t){const s=e.match(n);if(s)return{id:s[1],isFolder:n===t[1]}}return null}setupAudioPlayer(e){const t=URL.createObjectURL(e);this.audioPlayer.src=t,this.audioPlayer.load(),this.playerSection.style.display="block"}togglePlayback(){this.audioPlayer.paused?(this.audioPlayer.play(),this.playPause.textContent="Pause"):(this.audioPlayer.pause(),this.playPause.textContent="Play")}validateAndDisplayResults(e){const t=this.getCriteria(),n=this.engine.validateCriteria(e,t),s=this.engine.formatResults(e);document.getElementById("fileName").textContent=this.currentFile.name,document.getElementById("fileType").textContent=s.fileType,document.getElementById("sampleRate").textContent=s.sampleRate,document.getElementById("bitDepth").textContent=s.bitDepth,document.getElementById("channels").textContent=s.channels,document.getElementById("duration").textContent=s.duration,document.getElementById("fileSize").textContent=s.fileSize,this.applyValidationStyling(n)}applyValidationStyling(e){const t={fileType:document.getElementById("fileTypeRow"),sampleRate:document.getElementById("sampleRateRow"),bitDepth:document.getElementById("bitDepthRow"),channels:document.getElementById("channelsRow"),duration:document.getElementById("durationRow")};Object.entries(e).forEach(([n,s])=>{const a=t[n];a&&(a.classList.remove("pass","fail","warning","unknown"),a.classList.add(s.status))})}async runAdvancedAnalysis(){if(!this.audioBuffer&&this.currentFile)try{const e=await this.currentFile.arrayBuffer(),t=new(window.AudioContext||window.webkitAudioContext);this.audioBuffer=await t.decodeAudioData(e)}catch(e){this.showError(`Failed to decode audio: ${e.message}`);return}if(!this.audioBuffer){this.showError("No audio data available for analysis");return}this.isAnalyzing=!0,this.advancedAnalysisBtn.style.display="none",this.advancedProgress.style.display="block";try{const e=await this.engine.analyzeAdvanced(this.audioBuffer,(t,n)=>{this.progressText.textContent=t,this.progressFill.style.width=`${n*100}%`});document.getElementById("peakLevel").textContent=e.peakDb===-1/0?"-∞ dB":`${e.peakDb.toFixed(1)} dB`,document.getElementById("noiseFloor").textContent=e.noiseFloorDb===-1/0?"-∞ dB":`${e.noiseFloorDb.toFixed(1)} dB`,document.getElementById("normalization").textContent=e.normalizationStatus.message,this.advancedResultsSection.style.display="block"}catch(e){e.message!=="Analysis cancelled"&&(console.error("Advanced analysis error:",e),this.showError(`Advanced analysis failed: ${e.message}`))}finally{this.isAnalyzing=!1,this.advancedProgress.style.display="none",this.advancedAnalysisBtn.style.display="block"}}cancelAdvancedAnalysis(){this.engine.cancelAdvancedAnalysis(),this.isAnalyzing=!1,this.advancedProgress.style.display="none",this.advancedAnalysisBtn.style.display="block"}showLoading(){this.hideAllSections(),this.loading.style.display="block"}showResults(){this.hideAllSections(),this.resultsSection.style.display="block"}showError(e){this.hideAllSections(),this.errorMessage.textContent=e,this.error.style.display="block"}showBatchProgress(e,t,n){this.hideAllSections(),this.batchProgress.style.display="block";const s=Math.round(e/t*100);this.batchProgressBar.style.width=`${s}%`,this.batchProgressText.textContent=`${e}/${t} (${s}%)`,this.batchCurrentFile.textContent=n||"Processing..."}showBatchResults(e){this.hideAllSections(),this.batchResultsSection.style.display="block";const t=e.filter(a=>a.status==="pass").length,n=e.filter(a=>a.status==="warning").length,s=e.filter(a=>a.status==="fail").length;this.batchPassCount.textContent=t,this.batchWarningCount.textContent=n,this.batchFailCount.textContent=s,this.batchTableBody.innerHTML="",e.forEach((a,i)=>{const o=document.createElement("tr");o.className=`batch-row ${a.status}`;const r=a.analysis?m.formatDisplayText(a.analysis):{},l=this.getValidationStatus(a.validation,"fileType"),h=this.getValidationStatus(a.validation,"sampleRate"),d=this.getValidationStatus(a.validation,"bitDepth"),c=this.getValidationStatus(a.validation,"channels"),g=this.getValidationStatus(a.validation,"duration");o.innerHTML=`
        <td class="filename">${a.filename}</td>
        <td><span class="status-badge ${a.status}">${a.status}</span></td>
        <td class="validation-${l}">${r.fileType||"Unknown"}</td>
        <td class="validation-${h}">${r.sampleRate||"-"}</td>
        <td class="validation-${d}">${r.bitDepth||"-"}</td>
        <td class="validation-${c}">${r.channels||"-"}</td>
        <td class="validation-${g}">${r.duration||"-"}</td>
        <td>${r.fileSize||"-"}</td>
        <td><button class="play-btn-small" data-index="${i}">▶</button></td>
      `,this.batchTableBody.appendChild(o)}),this.batchResults=e,this.batchTableBody.querySelectorAll(".play-btn-small").forEach(a=>{a.addEventListener("click",i=>{const o=parseInt(i.target.dataset.index);this.playBatchFile(o)})})}formatValue(e){return e==null||e==="Unknown"?"-":e}formatDuration(e){if(!e||e==="Unknown")return"-";const t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n.toString().padStart(2,"0")}`}getValidationStatus(e,t){return!e||!e[t]?"":e[t].status}playBatchFile(e){if(!this.batchResults||!this.batchResults[e])return;const t=this.batchResults[e];if(!t.file)return;const n=URL.createObjectURL(t.file);window.open(n,"_blank"),setTimeout(()=>URL.revokeObjectURL(n),1e3)}revalidateBatchResults(){if(!this.batchResults)return;const e=this.getCriteria();this.batchResults.forEach(t=>{t.analysis&&(t.validation=m.validateResults(t.analysis,e),t.status=this.getOverallStatus(t.validation))}),this.showBatchResults(this.batchResults)}getOverallStatus(e){const t=Object.values(e).map(n=>n.status);return t.includes("fail")?"fail":t.includes("warning")?"warning":"pass"}cleanupForNewFile(){this.currentFile&&(this.currentFile=null),this.audioBuffer&&(this.audioBuffer=null),this.currentResults&&(this.currentResults=null),this.audioPlayer&&this.audioPlayer.src&&(this.audioPlayer.src.startsWith("blob:")&&URL.revokeObjectURL(this.audioPlayer.src),this.audioPlayer.src="")}cleanup(){this.cleanupForNewFile(),this.engine.audioAnalyzer.audioContext,window.gc&&typeof window.gc=="function"&&window.gc()}hideAllSections(){this.loading.style.display="none",this.error.style.display="none",this.resultsSection.style.display="none",this.advancedResultsSection.style.display="none",this.batchProgress.style.display="none",this.batchResultsSection.style.display="none"}}document.addEventListener("DOMContentLoaded",()=>{const u=new C;window.addEventListener("beforeunload",()=>{u.cleanup()}),document.addEventListener("visibilitychange",()=>{document.hidden&&u.cleanup()})});
