(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function a(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();class B{constructor(){this.audioContext=null,this.audioBuffer=null}async analyzeFile(t){const e=await t.arrayBuffer();if(t.name.toLowerCase().endsWith(".wav")){const a=new DataView(e),s=this.parseWavHeaders(a);let n=this.getFileType(t.name);return n==="WAV"&&(s.audioFormat===1?n="WAV (PCM)":typeof s.audioFormat=="number"?n=`WAV (Compressed - Format ${s.audioFormat})`:n="WAV (Unknown Format)"),{fileType:n,sampleRate:s.sampleRate,channels:s.channels,bitDepth:s.bitDepth,duration:s.duration,fileSize:t.size}}this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext));try{return this.audioBuffer=await this.audioContext.decodeAudioData(e),{fileType:this.getFileType(t.name),sampleRate:this.audioBuffer.sampleRate,channels:this.audioBuffer.numberOfChannels,duration:this.audioBuffer.duration,fileSize:t.size,bitDepth:this.estimateBitDepth(e,t.name)}}catch{return await this.analyzeFileHeaders(e,t.name,t.size)}}async analyzeFileHeaders(t,e,a){const s=new DataView(t),n={fileType:this.getFileType(e),fileSize:a};if(e.toLowerCase().endsWith(".wav")){const i=this.parseWavHeaders(s);Object.assign(n,i)}else n.sampleRate="Unknown",n.bitDepth="Unknown",n.channels="Unknown",n.duration="Unknown";return n}parseWavHeaders(t){try{if(String.fromCharCode(t.getUint8(0),t.getUint8(1),t.getUint8(2),t.getUint8(3))!=="RIFF")throw new Error("Not a valid WAV file");if(String.fromCharCode(t.getUint8(8),t.getUint8(9),t.getUint8(10),t.getUint8(11))!=="WAVE")throw new Error("Not a valid WAV file");let s=12;for(;s<t.byteLength-8;){const n=String.fromCharCode(t.getUint8(s),t.getUint8(s+1),t.getUint8(s+2),t.getUint8(s+3)),i=t.getUint32(s+4,!0);if(n==="fmt "){const r=t.getUint16(s+8,!0),l=t.getUint16(s+10,!0),c=t.getUint32(s+12,!0),o=t.getUint16(s+22,!0),d=this.calculateWavDuration(t,c,l,o);return{sampleRate:c,channels:l,bitDepth:o,duration:d,audioFormat:r}}s+=8+i}throw new Error("fmt chunk not found")}catch(e){return console.error("Error parsing WAV headers:",e),{sampleRate:"Unknown",channels:"Unknown",bitDepth:"Unknown",duration:"Unknown",audioFormat:"Unknown"}}}calculateWavDuration(t,e,a,s){try{let n=12;for(;n<t.byteLength-8;){const i=String.fromCharCode(t.getUint8(n),t.getUint8(n+1),t.getUint8(n+2),t.getUint8(n+3)),r=t.getUint32(n+4,!0);if(i==="data"){const l=s/8;return r/(a*l)/e}n+=8+r}return"Unknown"}catch{return"Unknown"}}getFileType(t){const e=t.split(".").pop().toLowerCase();return{wav:"WAV",mp3:"MP3",flac:"FLAC",aac:"AAC",m4a:"M4A",ogg:"OGG",webm:"WebM"}[e]||e.toUpperCase()}estimateBitDepth(t,e){if(e.toLowerCase().endsWith(".wav"))return"See WAV analysis";const a=e.split(".").pop().toLowerCase();return["mp3","aac","m4a"].includes(a)?"Compressed (variable)":"Unknown"}}class b{static matchesFileType(t,e){const a={matches:!1,status:"fail"};if(t===e)return a.matches=!0,a.status="pass",a;if(e==="wav"||e==="WAV")return t==="WAV (PCM)"||t==="WAV"?(a.matches=!0,a.status="pass",a):(t.startsWith("WAV")&&(a.matches=!0,a.status="warning"),a);const s=t.replace(/\s*\(.*\)/,"").trim(),n=e.toUpperCase();return s===n&&(a.matches=!0,a.status="pass"),a}static validateResults(t,e,a=!1){const s={},n=r=>r?Array.isArray(r)?r:[r]:[],i=n(e.fileType);if(i.length>0){let r={matches:!1,status:"fail"};for(const l of i){const c=this.matchesFileType(t.fileType,l);if(c.status==="pass"){r=c;break}else c.status==="warning"&&r.status==="fail"&&(r=c)}s.fileType={matches:r.matches,target:i,actual:t.fileType,status:r.status}}if(!a){const r=n(e.sampleRate).map(o=>parseInt(o)).filter(o=>!isNaN(o));if(r.length>0){const o=t.sampleRate,d=r.includes(o);s.sampleRate={matches:d,target:r,actual:o,status:d?"pass":"fail"}}const l=n(e.bitDepth).map(o=>parseInt(o)).filter(o=>!isNaN(o));if(l.length>0){const o=t.bitDepth,d=l.includes(o);s.bitDepth={matches:d,target:l,actual:o,status:d?"pass":"fail"}}const c=n(e.channels).map(o=>parseInt(o)).filter(o=>!isNaN(o));if(c.length>0){const o=t.channels,d=c.includes(o);s.channels={matches:d,target:c,actual:o,status:d?"pass":"fail"}}if(e.minDuration){const o=parseInt(e.minDuration),d=t.duration,h=typeof d=="number"&&d>=o;s.duration={matches:h,target:`${o}s minimum`,actual:d,status:h?"pass":"fail"}}}return s}static formatDuration(t){const e=Math.floor(t/3600),a=Math.floor(t%3600/60),s=Math.floor(t%60);return e>0?`${e}h:${a.toString().padStart(2,"0")}m:${s.toString().padStart(2,"0")}s`:`${a}m:${s.toString().padStart(2,"0")}s`}static formatDisplayText(t){const e={};return e.fileType=t.fileType,e.sampleRate=typeof t.sampleRate=="number"?`${(t.sampleRate/1e3).toFixed(1)} kHz`:t.sampleRate,e.bitDepth=typeof t.bitDepth=="number"?`${t.bitDepth}-bit`:t.bitDepth,e.channels=typeof t.channels=="number"?`${t.channels}${t.channels===1?" (Mono)":t.channels===2?" (Stereo)":""}`:t.channels,e.duration=typeof t.duration=="number"?this.formatDuration(t.duration):t.duration,e.fileSize=`${(t.fileSize/1024/1024).toFixed(2)} MB`,e}static formatAdvancedResults(t){const e={};return e.peakLevel=t.peakDb===-1/0?"Silent":`${t.peakDb.toFixed(1)} dB`,e.peakStatus=t.peakDb<=-6?"pass":t.peakDb<=-3?"warning":"fail",e.noiseFloor=t.noiseFloorDb===-1/0?"Silent":`${t.noiseFloorDb.toFixed(1)} dB`,e.noiseStatus=t.noiseFloorDb<=-60?"pass":"fail",e.normalization=t.normalizationStatus.message,e.normalizationStatus=t.normalizationStatus.status==="normalized"?"pass":"fail",e}}class E{constructor(){this.analysisInProgress=!1}async analyzeAudioBuffer(t,e=null){t.sampleRate;const a=t.numberOfChannels,s=t.length,n=[];for(let i=0;i<a;i++)n.push(t.getChannelData(i));this.analysisInProgress=!0;try{e&&e("Analyzing peak levels...",0);let i=0;for(let o=0;o<a;o++){const d=n[o];for(let h=0;h<s;h++){if(!this.analysisInProgress)throw new Error("Analysis cancelled");const u=Math.abs(d[h]);if(u>i&&(i=u),h%1e4===0){const m=(o*s+h)/(a*s)*.5;e&&e("Analyzing peak levels...",m),h%1e5===0&&await new Promise(f=>setTimeout(f,1))}}}const r=i>0?20*Math.log10(i):-1/0;e&&e("Analyzing noise floor...",.5);const l=await this.analyzeNoiseFloor(n,a,s,e);e&&e("Checking normalization...",.9);const c=this.checkNormalization(r);return e&&e("Analysis complete!",1),{peakDb:r,noiseFloorDb:l,normalizationStatus:c}}finally{this.analysisInProgress=!1}}async analyzeNoiseFloor(t,e,a,s){const n=Math.floor(a/100),i=[];for(let d=0;d<e;d++){const h=t[d];for(let u=0;u<a-n;u+=n){let m=0;for(let y=u;y<u+n&&y<a;y++)m+=h[y]*h[y];const f=Math.sqrt(m/n);i.push(f)}}i.sort((d,h)=>d-h);const r=Math.floor(i.length*.2),l=i.slice(0,r),c=l.reduce((d,h)=>d+h,0)/l.length;return c>0?20*Math.log10(c):-1/0}checkNormalization(t){return Math.abs(t- -6)<=.1?{status:"normalized",message:"Properly normalized to -6dB"}:t>-6?{status:"too_loud",message:`Too loud: ${t.toFixed(1)}dB (target: -6dB)`}:{status:"too_quiet",message:`Too quiet: ${t.toFixed(1)}dB (target: -6dB)`}}cancelAnalysis(){this.analysisInProgress=!1}}class R{async analyzeHeaders(t){const a=await t.slice(0,102400).arrayBuffer(),s=new DataView(a),n={filename:t.name,fileSize:t.size,fileType:this.getFileType(t.name)};if(t.name.toLowerCase().endsWith(".wav")){const i=this.parseWavHeaders(s,t.size);Object.assign(n,i),i.formatType&&(n.fileType=i.formatType)}else t.name.toLowerCase().endsWith(".mp3")?Object.assign(n,this.parseMp3Headers(s,t.size)):t.name.toLowerCase().endsWith(".flac")?Object.assign(n,this.parseFlacHeaders(s,t.size)):(n.sampleRate="Unknown",n.bitDepth="Unknown",n.channels="Unknown",n.duration="Unknown");return n}parseWavHeaders(t,e){try{if(String.fromCharCode(t.getUint8(0),t.getUint8(1),t.getUint8(2),t.getUint8(3))!=="RIFF")throw new Error("Not a valid WAV file");if(String.fromCharCode(t.getUint8(8),t.getUint8(9),t.getUint8(10),t.getUint8(11))!=="WAVE")throw new Error("Not a valid WAV file");let n=12;for(;n<t.byteLength-8;){const i=String.fromCharCode(t.getUint8(n),t.getUint8(n+1),t.getUint8(n+2),t.getUint8(n+3)),r=t.getUint32(n+4,!0);if(i==="fmt "){const l=t.getUint16(n+8,!0),c=t.getUint16(n+10,!0),o=t.getUint32(n+12,!0),d=t.getUint16(n+22,!0),h=t.getUint32(n+16,!0),u=e-44,m=h>0?u/h:"Unknown";return{sampleRate:o,channels:c,bitDepth:d,duration:typeof m=="number"?m:"Unknown",audioFormat:l,formatType:l===1?"WAV (PCM)":`WAV (Format ${l})`}}n+=8+r}throw new Error("fmt chunk not found")}catch{return{sampleRate:"Unknown",channels:"Unknown",bitDepth:"Unknown",duration:"Unknown",formatType:"WAV"}}}parseMp3Headers(t){try{let e=0;for(;e<t.byteLength-4;){if(t.getUint8(e)===255&&(t.getUint8(e+1)&224)===224){const a=t.getUint32(e,!1),s=a>>19&3,n=a>>17&3,i=a>>12&15,r=a>>10&3,l=a>>6&3,c=[44100,48e3,32e3],o=l===3?1:2;return{sampleRate:c[r]||"Unknown",channels:o,bitDepth:"Compressed (variable)",duration:"Unknown"}}e++}throw new Error("No MP3 frame found")}catch{return{sampleRate:"Unknown",channels:"Unknown",bitDepth:"Compressed (variable)",duration:"Unknown"}}}parseFlacHeaders(t){try{if(String.fromCharCode(t.getUint8(0),t.getUint8(1),t.getUint8(2),t.getUint8(3))!=="fLaC")throw new Error("Not a valid FLAC file");const a=t.getUint8(4),s=(a&128)!==0;if((a&127)===0){const i=t.getUint16(5,!1),r=t.getUint16(7,!1),l=t.getUint16(18,!1),c=t.getUint8(20),o=l<<4|c>>4,d=(c>>1&7)+1,h=((c&1)<<4|t.getUint8(21)>>4)+1;return{sampleRate:o,channels:d,bitDepth:h,duration:"Unknown"}}throw new Error("STREAMINFO block not found")}catch{return{sampleRate:"Unknown",channels:"Unknown",bitDepth:"Unknown",duration:"Unknown"}}}getFileType(t){const e=t.split(".").pop().toLowerCase();return{wav:"WAV",mp3:"MP3",flac:"FLAC",aac:"AAC",m4a:"M4A",ogg:"OGG"}[e]||e.toUpperCase()}}class D{constructor(t){this.analyzer=new R,this.validator=t,this.cancelled=!1}async processBatch(t,e,a,s){this.cancelled=!1;const n=[],i=Date.now();for(let r=0;r<t.length&&!this.cancelled;r++){const l=t[r];let c;try{const o=await this.analyzer.analyzeHeaders(l),d=typeof e=="function"?e():e,h=this.validator.validateResults(o,d);c={filename:l.name,file:l,analysis:o,validation:h,status:this.getOverallStatus(h)}}catch(o){c={filename:l.name,file:l,analysis:null,validation:null,status:"error",error:o.message}}n.push(c),s&&s(c),a&&a({current:r+1,total:t.length,currentFile:l.name,percentage:(r+1)/t.length*100,elapsedTime:Date.now()-i})}return n}getOverallStatus(t){const e=Object.values(t).map(a=>a.status);return e.includes("fail")?"fail":e.includes("warning")?"warning":"pass"}cancel(){this.cancelled=!0}}const T=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",U=window.location.pathname.startsWith("/beta"),$=T?"http://localhost:3000":U?"https://audio-analyzer.tinytech.site/beta":"https://audio-analyzer.tinytech.site",A={CLIENT_ID:"708688597317-bmmrje6hqg8vo52nctned54m32q8uhsr.apps.googleusercontent.com",REDIRECT_URI:$,SCOPE:"https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email",DISCOVERY_DOCS:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]};class P{constructor(){this.isInitialized=!1,this.accessToken=null,this.codeClient=null,this.userInfo=null}async init(){if(!this.isInitialized)return new Promise((t,e)=>{this.loadGoogleAPI().then(()=>{this.initializeGIS().then(t).catch(e)}).catch(e)})}async loadGoogleAPI(){return new Promise((t,e)=>{if(window.gapi){t();return}const a=document.createElement("script");a.src="https://apis.google.com/js/api.js",a.onload=()=>t(),a.onerror=()=>e(new Error("Failed to load Google API script")),document.head.appendChild(a)})}async initializeGIS(){return new Promise((t,e)=>{const a=document.createElement("script");a.src="https://accounts.google.com/gsi/client",a.onload=()=>{this.setupGIS().then(t).catch(e)},a.onerror=()=>e(new Error("Failed to load Google Identity Services")),document.head.appendChild(a)})}async setupGIS(){return new Promise((t,e)=>{const a=setTimeout(()=>{e(new Error("Google API setup timeout"))},1e4);window.gapi.load("client",async()=>{try{clearTimeout(a),await window.gapi.client.init({discoveryDocs:A.DISCOVERY_DOCS}),this.tokenClient=window.google.accounts.oauth2.initTokenClient({client_id:A.CLIENT_ID,scope:A.SCOPE,callback:s=>{if(s.error){console.error("Token response error:",s),e(new Error(`Google sign-in failed: ${s.error}`));return}this.accessToken=s.access_token;const n={access_token:s.access_token,expires_at:Date.now()+s.expires_in*1e3,scope:s.scope};localStorage.setItem("google_token",JSON.stringify(n)),t(n)}}),this.isInitialized=!0,t()}catch(s){clearTimeout(a),console.error("Google API setup error:",s);let n="Unknown setup error";s&&typeof s=="object"?n=s.message||s.error||s.details||JSON.stringify(s):s&&(n=s.toString()),e(new Error(`Failed to setup Google API: ${n}`))}})})}async signIn(){return this.isInitialized||await this.init(),new Promise((t,e)=>{try{this.tokenClient.callback=a=>{if(a.error){console.error("Token response error:",a),e(new Error(`Google sign-in failed: ${a.error}`));return}if(!(a.scope&&a.scope.includes("https://www.googleapis.com/auth/drive.readonly"))){console.warn("Drive scope not granted, retrying with consent prompt"),this.tokenClient.requestAccessToken({prompt:"consent"});return}this.accessToken=a.access_token;const n={access_token:a.access_token,expires_at:Date.now()+a.expires_in*1e3,scope:a.scope};localStorage.setItem("google_token",JSON.stringify(n)),t(n)},this.tokenClient.requestAccessToken({prompt:""})}catch(a){console.error("Google sign-in error:",a);let s="Unknown sign-in error";a&&typeof a=="object"?s=a.error||a.message||a.details||JSON.stringify(a):a&&(s=a.toString()),e(new Error(`Google sign-in failed: ${s}`))}})}async getValidToken(){const t=localStorage.getItem("google_token");if(t)try{const e=JSON.parse(t);if(e.expires_at>Date.now()+3e5)return this.accessToken=e.access_token,e}catch(e){console.warn("Invalid stored token:",e),localStorage.removeItem("google_token")}return await this.signIn()}async getUserInfo(){const t=await this.getValidToken();try{const e=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${t.access_token}`}});if(!e.ok)throw new Error(`Failed to get user info: ${e.status}`);const a=await e.json();return this.userInfo=a,a}catch(e){throw new Error(`Failed to get user info: ${e.message}`)}}async downloadFile(t){const e=await this.getValidToken();try{const a=await fetch(`https://www.googleapis.com/drive/v3/files/${t}?fields=name,mimeType,size`,{headers:{Authorization:`Bearer ${e.access_token}`}});if(!a.ok)throw a.status===403?(this.signOut(),new Error("Insufficient permissions to access Google Drive. Please sign in again and grant Drive access.")):new Error(`Failed to get file metadata: ${a.status}`);const s=await a.json(),n=await fetch(`https://www.googleapis.com/drive/v3/files/${t}?alt=media`,{headers:{Authorization:`Bearer ${e.access_token}`}});if(!n.ok)throw new Error(`Failed to download file: ${n.status}`);const i=await n.blob();return new File([i],s.name,{type:s.mimeType||"audio/mpeg"})}catch(a){throw new Error(`Google Drive download failed: ${a.message}`)}}async listAudioFilesInFolder(t){const e=await this.getValidToken();try{const s=["audio/mpeg","audio/wav","audio/x-wav","audio/wave","audio/flac","audio/x-flac","audio/aac","audio/mp4","audio/ogg","audio/x-m4a"].map(l=>`mimeType='${l}'`).join(" or "),n=`'${t}' in parents and (${s}) and trashed=false`,i=await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(n)}&fields=files(id,name,mimeType,size,modifiedTime,videoMediaMetadata)&pageSize=1000`,{headers:{Authorization:`Bearer ${e.access_token}`}});if(!i.ok)throw i.status===403?(this.signOut(),new Error("Insufficient permissions to access Google Drive folder. Please sign in again.")):new Error(`Failed to list folder contents: ${i.status}`);return(await i.json()).files||[]}catch(a){throw new Error(`Failed to list folder: ${a.message}`)}}async listFilesInFolder(t,e){const a=await this.getValidToken();try{const s=`'${t}' in parents and trashed=false`,n=await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(s)}&fields=files(id,name,mimeType)&pageSize=1000`,{headers:{Authorization:`Bearer ${a.access_token}`}});if(!n.ok)throw n.status===403?(this.signOut(),new Error("Insufficient permissions to access Google Drive folder. Please sign in again.")):new Error(`Failed to list folder contents: ${n.status}`);const r=(await n.json()).files||[];return e?r.filter(l=>l.name.toLowerCase().endsWith(e.toLowerCase())):r}catch(s){throw new Error(`Failed to list folder: ${s.message}`)}}async downloadFileHeaders(t,e=102400){const a=await this.getValidToken();try{const s=await fetch(`https://www.googleapis.com/drive/v3/files/${t}?alt=media`,{headers:{Authorization:`Bearer ${a.access_token}`,Range:`bytes=0-${e-1}`}});if(!s.ok&&s.status!==206)throw new Error(`Failed to download file headers: ${s.status}`);return await s.blob()}catch(s){throw new Error(`Failed to download headers: ${s.message}`)}}async getFileMetadata(t){if(t.videoMediaMetadata)return t;const e=await this.getValidToken();try{const a=await fetch(`https://www.googleapis.com/drive/v3/files/${t.id}?fields=name,mimeType,size,modifiedTime,videoMediaMetadata`,{headers:{Authorization:`Bearer ${e.access_token}`}});if(!a.ok)throw a.status===403?(this.signOut(),new Error("Insufficient permissions to access Google Drive. Please sign in again and grant Drive access.")):new Error(`Failed to get file metadata: ${a.status}`);return await a.json()}catch(a){throw new Error(`Google Drive metadata fetch failed: ${a.message}`)}}signOut(){this.accessToken&&window.google&&window.google.accounts.oauth2.revoke(this.accessToken),this.accessToken=null,localStorage.removeItem("google_token")}isSignedIn(){const t=localStorage.getItem("google_token");if(!t)return!1;try{return JSON.parse(t).expires_at>Date.now()}catch{return!1}}}class z{constructor(){this.audioAnalyzer=new B,this.levelAnalyzer=new E}async analyzeFile(t){return await this.audioAnalyzer.analyzeFile(t)}async analyzeAdvanced(t,e){return await this.levelAnalyzer.analyzeAudioBuffer(t,e)}validateCriteria(t,e){return b.validateResults(t,e)}formatResults(t){return b.formatDisplayText(t)}formatAdvancedResults(t){return b.formatAdvancedResults(t)}cancelAdvancedAnalysis(){this.levelAnalyzer.cancelAnalysis()}}class x{constructor(){this.engine=new z,this.googleAuth=new P,this.batchProcessor=new D(b),this.currentFile=null,this.audioBuffer=null,this.isAnalyzing=!1,this.currentResults=null,this.processingFile=!1,this.batchMode=!1,this.batchResults=null,this.batchCancelled=!1,this.initializeElements(),this.attachEventListeners(),this.loadSettings()}initializeElements(){this.tabButtons=document.querySelectorAll(".tab-button"),this.tabContents=document.querySelectorAll(".tab-content"),this.dropZone=document.getElementById("dropZone"),this.browseBtn=document.getElementById("browseBtn"),this.fileInput=document.getElementById("fileInput"),this.driveUrl=document.getElementById("driveUrl"),this.analyzeUrl=document.getElementById("analyzeUrl"),this.authText=document.getElementById("authText"),this.signInBtn=document.getElementById("signInBtn"),this.signOutBtn=document.getElementById("signOutBtn"),this.analysisTypeSection=document.getElementById("analysisTypeSection"),this.enableAudioAnalysis=document.getElementById("enableAudioAnalysis"),this.enableFilenameValidation=document.getElementById("enableFilenameValidation"),this.filenameValidationFields=document.getElementById("filenameValidationFields"),this.speakerId=document.getElementById("speakerId"),this.scriptsFolderUrl=document.getElementById("scriptsFolderUrl"),this.presetSelector=document.getElementById("presetSelector"),this.targetFileType=document.getElementById("targetFileType"),this.targetSampleRate=document.getElementById("targetSampleRate"),this.targetBitDepth=document.getElementById("targetBitDepth"),this.targetChannels=document.getElementById("targetChannels"),this.targetMinDuration=document.getElementById("targetMinDuration"),this.playerSection=document.getElementById("playerSection"),this.resultsSection=document.getElementById("resultsSection"),this.advancedResultsSection=document.getElementById("advancedResultsSection"),this.audioPlayer=document.getElementById("audioPlayer"),this.playPause=document.getElementById("playPause"),this.advancedAnalysisBtn=document.getElementById("advancedAnalysisBtn"),this.advancedProgress=document.getElementById("advancedProgress"),this.progressFill=document.getElementById("progressFill"),this.progressText=document.getElementById("progressText"),this.cancelAnalysis=document.getElementById("cancelAnalysis"),this.loading=document.getElementById("loading"),this.error=document.getElementById("error"),this.errorMessage=document.getElementById("errorMessage"),this.batchProgress=document.getElementById("batchProgress"),this.batchCurrentFile=document.getElementById("batchCurrentFile"),this.batchProgressText=document.getElementById("batchProgressText"),this.batchProgressBar=document.getElementById("batchProgressBar"),this.cancelBatch=document.getElementById("cancelBatch"),this.batchResultsSection=document.getElementById("batchResultsSection"),this.batchPassCount=document.getElementById("batchPassCount"),this.batchWarningCount=document.getElementById("batchWarningCount"),this.batchFailCount=document.getElementById("batchFailCount"),this.batchErrorCount=document.getElementById("batchErrorCount"),this.batchTotalDuration=document.getElementById("batchTotalDuration"),this.batchTableBody=document.getElementById("batchTableBody")}attachEventListeners(){this.tabButtons.forEach(t=>{t.addEventListener("click",()=>this.switchTab(t.dataset.tab))}),this.browseBtn.addEventListener("click",t=>{t.stopPropagation(),this.fileInput.value="",this.fileInput.click()}),this.fileInput.addEventListener("change",t=>{const e=Array.from(t.target.files||[]);e.length>0&&this.handleFilesSelect(e)}),this.dropZone.addEventListener("dragover",t=>{t.preventDefault(),this.dropZone.classList.add("drag-over")}),this.dropZone.addEventListener("dragleave",()=>{this.dropZone.classList.remove("drag-over")}),this.dropZone.addEventListener("drop",t=>{t.preventDefault(),this.dropZone.classList.remove("drag-over");const e=Array.from(t.dataTransfer.files||[]).filter(a=>a.type.startsWith("audio/"));e.length>0&&this.handleFilesSelect(e)}),this.dropZone.addEventListener("click",()=>this.fileInput.click()),this.analyzeUrl.addEventListener("click",()=>this.handleGoogleDriveUrl()),this.driveUrl.addEventListener("keypress",t=>{t.key==="Enter"&&this.handleGoogleDriveUrl()}),this.signInBtn.addEventListener("click",()=>this.handleSignIn()),this.signOutBtn.addEventListener("click",()=>this.handleSignOut()),this.presetSelector.addEventListener("change",()=>this.handlePresetChange()),this.enableFilenameValidation.addEventListener("change",()=>this.toggleFilenameValidationFields()),this.enableAudioAnalysis.addEventListener("change",()=>this.validateAnalysisTypeSelection()),this.speakerId.addEventListener("input",()=>this.saveFilenameValidationSettings()),this.scriptsFolderUrl.addEventListener("input",()=>this.saveFilenameValidationSettings()),[this.targetFileType,this.targetSampleRate,this.targetBitDepth,this.targetChannels].forEach(t=>{t.addEventListener("change",()=>this.saveCriteria())}),this.targetMinDuration.addEventListener("input",()=>this.saveCriteria()),this.playPause.addEventListener("click",()=>this.togglePlayback()),this.audioPlayer.addEventListener("loadedmetadata",()=>{this.playPause.textContent="Play"}),this.advancedAnalysisBtn.addEventListener("click",()=>this.runAdvancedAnalysis()),this.cancelAnalysis.addEventListener("click",()=>this.cancelAdvancedAnalysis()),this.cancelBatch.addEventListener("click",()=>this.cancelBatchProcessing())}loadSettings(){const t=localStorage.getItem("audio-analyzer-settings");if(t)try{const a=JSON.parse(t);if(a.criteria){const s=(n,i)=>{Array.from(n.options).forEach(l=>{l.selected=!1}),(Array.isArray(i)?i:i?[i]:[]).forEach(l=>{const c=Array.from(n.options).find(o=>o.value===l);c&&(c.selected=!0)})};s(this.targetFileType,a.criteria.fileType||[]),s(this.targetSampleRate,a.criteria.sampleRate||[]),s(this.targetBitDepth,a.criteria.bitDepth||[]),s(this.targetChannels,a.criteria.channels||[]),this.targetMinDuration.value=a.criteria.minDuration||""}}catch(a){console.warn("Failed to load settings from localStorage:",a)}const e=localStorage.getItem("audio-analyzer-selected-preset");e?(this.presetSelector.value=e,this.handlePresetChange()):(this.presetSelector.value="auditions",this.handlePresetChange()),this.loadFilenameValidationSettings(),this.updateAuthStatus()}updateAuthStatus(){if(this.googleAuth.isSignedIn()){const e=this.googleAuth.getUserInfo();e&&e.name?this.authText.textContent=`✓ Signed in as ${e.name}`:this.authText.textContent="✓ Signed in to Google Drive",this.signInBtn.style.display="none",this.signOutBtn.style.display="inline-block"}else this.authText.textContent="Not signed in to Google",this.signInBtn.style.display="inline-block",this.signOutBtn.style.display="none"}async handleSignIn(){try{await this.googleAuth.signIn(),this.updateAuthStatus()}catch(t){console.error("Sign-in failed:",t),this.showError(`Google sign-in failed: ${t.message}`)}}handleSignOut(){this.googleAuth.signOut(),this.updateAuthStatus()}getCriteria(){const t=a=>Array.from(a.selectedOptions).map(s=>s.value);return{fileType:t(this.targetFileType),sampleRate:t(this.targetSampleRate),bitDepth:t(this.targetBitDepth),channels:t(this.targetChannels),minDuration:this.targetMinDuration.value||""}}saveCriteria(){const e={criteria:this.getCriteria()};localStorage.setItem("audio-analyzer-settings",JSON.stringify(e)),this.currentResults&&this.validateAndDisplayResults(this.currentResults),this.batchResults&&this.batchMode&&this.revalidateBatchResults()}getPresetConfigurations(){return{auditions:{name:"Auditions",fileType:["wav"],sampleRate:["48000"],bitDepth:["24"],channels:["1"],minDuration:"120"},"character-recordings":{name:"Character Recordings",fileType:["wav"],sampleRate:["48000"],bitDepth:["24"],channels:["1"],minDuration:""},"p2b2-pairs-mono":{name:"P2B2 Pairs (Mono)",fileType:["wav"],sampleRate:["44100","48000"],bitDepth:["16","24"],channels:["1"],minDuration:""},"p2b2-pairs-stereo":{name:"P2B2 Pairs (Stereo)",fileType:["wav"],sampleRate:["44100","48000"],bitDepth:["16","24"],channels:["2"],minDuration:""},"p2b2-pairs-mixed":{name:"P2B2 Pairs (Mixed)",fileType:["wav"],sampleRate:["44100","48000"],bitDepth:["16","24"],channels:["1","2"],minDuration:""},"three-hour":{name:"Three Hour",fileType:["wav"],sampleRate:["48000"],bitDepth:["24"],channels:["1"],minDuration:"",supportsFilenameValidation:!0,filenameValidationType:"script-match"},"bilingual-conversational":{name:"Bilingual Conversational",fileType:["wav"],sampleRate:["48000"],bitDepth:["16","24"],channels:["2"],minDuration:""},custom:{name:"Custom"}}}handlePresetChange(){const t=this.presetSelector.value,e=document.getElementById("customCriteriaSection");if(t){if(t==="custom")e.style.display="block";else{e.style.display="none";const s=this.getPresetConfigurations()[t];if(s){const n=(i,r)=>{Array.from(i.options).forEach(c=>{c.selected=!1}),(Array.isArray(r)?r:r?[r]:[]).forEach(c=>{const o=Array.from(i.options).find(d=>d.value===c);o&&(o.selected=!0)})};n(this.targetFileType,s.fileType||[]),n(this.targetSampleRate,s.sampleRate||[]),n(this.targetBitDepth,s.bitDepth||[]),n(this.targetChannels,s.channels||[]),this.targetMinDuration.value=s.minDuration||"",this.saveCriteria(),this.currentResults&&this.validateAndDisplayResults(this.currentResults),this.batchResults&&this.batchMode&&this.revalidateBatchResults(),s.supportsFilenameValidation?this.analysisTypeSection.style.display="block":(this.analysisTypeSection.style.display="none",this.filenameValidationFields.style.display="none")}}localStorage.setItem("audio-analyzer-selected-preset",t)}}toggleFilenameValidationFields(){this.enableFilenameValidation.checked?this.filenameValidationFields.style.display="block":this.filenameValidationFields.style.display="none",this.saveFilenameValidationSettings()}validateAnalysisTypeSelection(){!this.enableAudioAnalysis.checked&&!this.enableFilenameValidation.checked&&(this.enableAudioAnalysis.checked=!0,alert("At least one analysis type must be selected")),this.saveFilenameValidationSettings()}saveFilenameValidationSettings(){const t={enableAudioAnalysis:this.enableAudioAnalysis.checked,enableFilenameValidation:this.enableFilenameValidation.checked,speakerId:this.speakerId.value,scriptsFolderUrl:this.scriptsFolderUrl.value};localStorage.setItem("audio-analyzer-filename-validation",JSON.stringify(t))}loadFilenameValidationSettings(){const t=localStorage.getItem("audio-analyzer-filename-validation");if(t)try{const e=JSON.parse(t);this.enableAudioAnalysis.checked=e.enableAudioAnalysis!==!1,this.enableFilenameValidation.checked=e.enableFilenameValidation||!1,this.speakerId.value=e.speakerId||"",this.scriptsFolderUrl.value=e.scriptsFolderUrl||"",this.enableFilenameValidation.checked&&(this.filenameValidationFields.style.display="block")}catch(e){console.error("Error loading filename validation settings:",e)}}switchTab(t){this.tabButtons.forEach(e=>e.classList.remove("active")),this.tabContents.forEach(e=>e.classList.remove("active")),document.querySelector(`[data-tab="${t}"]`).classList.add("active"),document.querySelectorAll(`.tab-content[data-tab="${t}"]`).forEach(e=>{e.classList.add("active")})}async handleFilesSelect(t){if(!(!t||t.length===0)){if(this.processingFile){console.log("Already processing files, ignoring duplicate call");return}t.length===1?(this.batchMode=!1,await this.handleFileSelect(t[0])):(this.batchMode=!0,await this.handleBatchFiles(t))}}async handleFileSelect(t){if(console.log("handleFileSelect called with:",t),!t){console.log("No file provided to handleFileSelect");return}if(this.processingFile){console.log("Already processing a file, ignoring duplicate call");return}this.processingFile=!0,console.log("Starting file processing..."),this.cleanupForNewFile(),this.currentFile=t,console.log("Showing loading screen..."),this.showLoading();try{console.log("Starting analysis with core engine...");const e=await this.engine.analyzeFile(t);console.log("Analysis results:",e),this.currentResults=e,console.log("Setting up audio player..."),this.setupAudioPlayer(t),console.log("Validating and displaying results..."),this.validateAndDisplayResults(e),this.showResults(),console.log("Results displayed successfully")}catch(e){console.error("Analysis error:",e),this.showError(`Failed to analyze file: ${e.message}`),this.cleanupForNewFile()}finally{this.processingFile=!1,console.log("File processing completed")}}async handleBatchFiles(t){this.processingFile=!0,this.batchCancelled=!1,this.cleanupForNewFile(),console.log(`Starting batch processing of ${t.length} files`),this.batchMode=!0,this.batchResults=[],this.showBatchProgress(0,t.length,"Initializing..."),this.initializeBatchResultsTable();try{const e=await this.batchProcessor.processBatch(t,()=>this.getCriteria(),a=>{this.showBatchProgress(a.current,a.total,a.currentFile)},a=>{this.batchResults.push(a),this.addBatchResultRow(a),this.updateBatchSummary()});this.batchResults=e,this.updateBatchSummary(),this.batchCancelled||(this.batchProgress.style.display="none")}catch(e){console.error("Batch processing error:",e),this.showError(`Failed to process batch: ${e.message}`),this.cleanupForNewFile()}finally{this.processingFile=!1}}async handleGoogleDriveUrl(){const t=this.driveUrl.value.trim();if(t){if(this.processingFile){console.log("Already processing a file, ignoring Google Drive request");return}this.processingFile=!0,this.cleanupForNewFile(),this.showLoading();try{const e=this.extractFileIdFromUrl(t);if(!e)throw new Error("Invalid Google Drive URL. Please ensure it's a valid Drive file or folder link.");this.updateAuthStatus(),e.isFolder?await this.handleGoogleDriveFolder(e.id):await this.handleGoogleDriveFile(e.id)}catch(e){console.error("Google Drive error:",e),this.cleanupForNewFile(),e.message.includes("sign-in")||e.message.includes("auth")?this.showError('Please sign in to Google to access Drive files. Click "Analyze" to authenticate.'):this.showError(`Failed to process Google Drive: ${e.message}`)}finally{this.processingFile=!1}}}async handleGoogleDriveFile(t){const e=await this.googleAuth.downloadFile(t);this.currentFile=e;const a=await this.engine.analyzeFile(e);this.currentResults=a,this.setupAudioPlayer(e),this.validateAndDisplayResults(a),this.showResults()}async fetchScriptFiles(t){try{const a=(await this.googleAuth.listFilesInFolder(t,".txt")).map(s=>s.name.trim().replace(/\.txt$/i,""));return console.log(`Found ${a.length} script files:`,a),a}catch(e){throw console.error("Error fetching script files:",e),new Error("Failed to fetch script files. Check the scripts folder URL.")}}validateFilename(t,e,a){const s=t.trim(),i=s.replace(/\.wav$/i,"").split(`_${a}`)[0],r=`${i}_${a}.wav`;return e.includes(i)?s===r?{status:"pass",expectedFormat:r,issue:""}:{status:"fail",expectedFormat:`${i}_${a}.wav`,issue:"Incorrect filename for existing script"}:{status:"fail",expectedFormat:"-",issue:"No matching script file found"}}async handleGoogleDriveFolder(t){const e=await this.googleAuth.listAudioFilesInFolder(t);if(e.length===0)throw new Error("No audio files found in this folder");console.log(`Found ${e.length} audio files in folder`);let a=[];if(this.enableFilenameValidation.checked){const i=this.scriptsFolderUrl.value.trim();if(!this.speakerId.value.trim())throw new Error("Speaker ID is required for filename validation");if(i){const l=this.extractFolderId(i);if(l)a=await this.fetchScriptFiles(l);else throw new Error("Invalid scripts folder URL")}else throw new Error("Scripts folder URL is required for filename validation")}this.batchMode=!0,this.batchResults=[],this.batchCancelled=!1,this.scriptBaseNames=a,this.showBatchProgress(0,e.length,"Initializing..."),this.initializeBatchResultsTable();const s=3;let n=0;for(let i=0;i<e.length;i+=s){if(this.batchCancelled){console.log("Batch processing cancelled");break}const l=e.slice(i,i+s).map(async o=>{var d,h;if(this.batchCancelled)return null;try{let u,m=!1;const f=this.enableFilenameValidation.checked&&!this.enableAudioAnalysis.checked;if(f){const g=await this.googleAuth.getFileMetadata(o);console.log("Full metadata for",g.name,":",g),u={filename:g.name,fileSize:parseInt(g.size)||0,fileType:this.getFileTypeFromName(g.name),sampleRate:"Unknown",bitDepth:"Unknown",channels:"Unknown",duration:(d=g.videoMediaMetadata)!=null&&d.durationMillis?g.videoMediaMetadata.durationMillis/1e3:"Unknown"},m=!0}else{let k=null;for(let F=0;F<3;F++)try{const v=await this.googleAuth.downloadFileHeaders(o.id),I=parseInt(o.size)||v.size,S=new File([v],o.name,{type:o.mimeType,lastModified:new Date(o.modifiedTime).getTime()});Object.defineProperty(S,"size",{value:I,writable:!1}),u=await this.batchProcessor.analyzer.analyzeHeaders(S);break}catch(v){if(k=v,(v.message.includes("500")||v.message.includes("502")||v.message.includes("503")||v.message.includes("504"))&&F<2){const S=Math.min(1e3*Math.pow(2,F),5e3);console.log(`Retry ${F+1}/3 for ${o.name} after ${S}ms...`),await new Promise(C=>setTimeout(C,S))}else throw k}}(h=o.videoMediaMetadata)!=null&&h.durationMillis&&(u.duration=o.videoMediaMetadata.durationMillis/1e3);const y=b.validateResults(u,this.getCriteria(),f);let w=null;if(this.enableFilenameValidation.checked&&this.scriptBaseNames.length>0){const g=this.speakerId.value.trim();w=this.validateFilename(o.name,this.scriptBaseNames,g)}return{filename:o.name,file:null,driveFileId:o.id,analysis:u,validation:y,filenameValidation:w,status:this.getOverallStatus(y,f,w),warning:m?"Limited analysis (Google Drive error)":null}}catch(u){return console.error(`Error processing ${o.name}:`,u),{filename:o.name,file:null,driveFileId:o.id,analysis:null,validation:null,status:"error",error:u.message}}});(await Promise.all(l)).forEach(o=>{o&&(this.batchResults.push(o),this.addBatchResultRow(o),n++,this.batchCancelled||this.showBatchProgress(n,e.length,o.filename))}),this.updateBatchSummary()}this.batchCancelled||(this.batchProgress.style.display="none")}extractFileIdFromUrl(t){const e=[/\/file\/d\/([a-zA-Z0-9-_]+)/,/\/folders\/([a-zA-Z0-9-_]+)/,/[?&]id=([a-zA-Z0-9-_]+)/,/^([a-zA-Z0-9-_]+)$/];for(const a of e){const s=t.match(a);if(s)return{id:s[1],isFolder:a===e[1]}}return null}extractFolderId(t){const e=t.match(/[-\w]{25,}/);return e?e[0]:null}setupAudioPlayer(t){const e=URL.createObjectURL(t);this.audioPlayer.src=e,this.audioPlayer.load(),this.playerSection.style.display="block"}togglePlayback(){this.audioPlayer.paused?(this.audioPlayer.play(),this.playPause.textContent="Pause"):(this.audioPlayer.pause(),this.playPause.textContent="Play")}validateAndDisplayResults(t){const e=this.getCriteria(),a=this.engine.validateCriteria(t,e),s=this.engine.formatResults(t);document.getElementById("fileName").textContent=this.currentFile.name,document.getElementById("fileType").textContent=s.fileType,document.getElementById("sampleRate").textContent=s.sampleRate,document.getElementById("bitDepth").textContent=s.bitDepth,document.getElementById("channels").textContent=s.channels,document.getElementById("duration").textContent=s.duration,document.getElementById("fileSize").textContent=s.fileSize,this.applyValidationStyling(a)}applyValidationStyling(t){const e={fileType:document.getElementById("fileTypeRow"),sampleRate:document.getElementById("sampleRateRow"),bitDepth:document.getElementById("bitDepthRow"),channels:document.getElementById("channelsRow"),duration:document.getElementById("durationRow")};Object.entries(t).forEach(([a,s])=>{const n=e[a];n&&(n.classList.remove("pass","fail","warning","unknown"),n.classList.add(s.status))})}async runAdvancedAnalysis(){if(!this.audioBuffer&&this.currentFile)try{const t=await this.currentFile.arrayBuffer(),e=new(window.AudioContext||window.webkitAudioContext);this.audioBuffer=await e.decodeAudioData(t)}catch(t){this.showError(`Failed to decode audio: ${t.message}`);return}if(!this.audioBuffer){this.showError("No audio data available for analysis");return}this.isAnalyzing=!0,this.advancedAnalysisBtn.style.display="none",this.advancedProgress.style.display="block";try{const t=await this.engine.analyzeAdvanced(this.audioBuffer,(e,a)=>{this.progressText.textContent=e,this.progressFill.style.width=`${a*100}%`});document.getElementById("peakLevel").textContent=t.peakDb===-1/0?"-∞ dB":`${t.peakDb.toFixed(1)} dB`,document.getElementById("noiseFloor").textContent=t.noiseFloorDb===-1/0?"-∞ dB":`${t.noiseFloorDb.toFixed(1)} dB`,document.getElementById("normalization").textContent=t.normalizationStatus.message,this.advancedResultsSection.style.display="block"}catch(t){t.message!=="Analysis cancelled"&&(console.error("Advanced analysis error:",t),this.showError(`Advanced analysis failed: ${t.message}`))}finally{this.isAnalyzing=!1,this.advancedProgress.style.display="none",this.advancedAnalysisBtn.style.display="block"}}cancelAdvancedAnalysis(){this.engine.cancelAdvancedAnalysis(),this.isAnalyzing=!1,this.advancedProgress.style.display="none",this.advancedAnalysisBtn.style.display="block"}cancelBatchProcessing(){this.batchCancelled=!0,this.batchProcessor.cancel(),this.batchProgress.style.display="none",this.batchProgressText.textContent="Processing cancelled"}showLoading(){this.hideAllSections(),this.loading.style.display="block"}showResults(){this.hideAllSections(),this.resultsSection.style.display="block"}showError(t){this.hideAllSections(),this.errorMessage.textContent=t,this.error.style.display="block"}showBatchProgress(t,e,a){this.batchProgress.style.display="block";const s=Math.round(t/e*100);this.batchProgressBar.style.width=`${s}%`,this.batchProgressText.textContent=`${t}/${e} (${s}%)`,this.batchCurrentFile.textContent=a||"Processing..."}initializeBatchResultsTable(){this.hideAllSections(),this.batchProgress.style.display="block",this.batchResultsSection.style.display="block",this.batchTableBody.innerHTML="";const t=this.enableFilenameValidation.checked&&!this.enableAudioAnalysis.checked,e=document.querySelector(".batch-results-table");e&&(t?e.classList.add("metadata-only"):e.classList.remove("metadata-only"));const a=document.getElementById("filenameCheckHeader");a&&(a.style.display=this.enableFilenameValidation.checked?"":"none"),["sampleRateHeader","bitDepthHeader","channelsHeader","durationHeader"].forEach(n=>{const i=document.getElementById(n);i&&(i.style.display=t?"none":"")}),this.batchPassCount.textContent="0",this.batchWarningCount.textContent="0",this.batchFailCount.textContent="0",this.batchErrorCount.textContent="0",this.batchTotalDuration.textContent="0h 0m"}addBatchResultRow(t){if(t.analysis&&!t.error){const w=this.getCriteria(),g=this.enableFilenameValidation.checked&&!this.enableAudioAnalysis.checked;t.validation=b.validateResults(t.analysis,w,g),g&&(t.validation.sampleRate&&(t.validation.sampleRate.status="unknown"),t.validation.bitDepth&&(t.validation.bitDepth.status="unknown"),t.validation.channels&&(t.validation.channels.status="unknown"),t.validation.duration&&(t.validation.duration.status="unknown")),t.status=this.getOverallStatus(t.validation,!1,t.filenameValidation)}const e=this.batchResults.length-1,a=document.createElement("tr");a.className=`batch-row ${t.status}`;const s=t.analysis?b.formatDisplayText(t.analysis):{},n=this.getValidationStatus(t.validation,"fileType"),i=this.getValidationStatus(t.validation,"sampleRate"),r=this.getValidationStatus(t.validation,"bitDepth"),l=this.getValidationStatus(t.validation,"channels"),c=this.getValidationStatus(t.validation,"duration"),o=this.enableFilenameValidation.checked&&!this.enableAudioAnalysis.checked;let d="";if(this.enableFilenameValidation.checked)if(t.filenameValidation){const w=t.filenameValidation.status==="pass"?"✅":"❌",g=t.filenameValidation.issue||t.filenameValidation.expectedFormat;d=`<td class="filename-check-${t.filenameValidation.status}" title="${g}">${w}</td>`}else d='<td style="display: none;"></td>';else d='<td style="display: none;"></td>';const h=o?"":`<td class="validation-${i}">${s.sampleRate||"-"}</td>`,u=o?"":`<td class="validation-${r}">${s.bitDepth||"-"}</td>`,m=o?"":`<td class="validation-${l}">${s.channels||"-"}</td>`,f=o?"":`<td class="validation-${c}">${s.duration||"-"}</td>`,y=t.file||t.driveFileId?`<button class="play-btn-small" data-index="${e}">▶</button>`:"-";if(a.innerHTML=`
      <td class="filename">${t.filename}</td>
      <td><span class="status-badge ${t.status}">${t.status}</span></td>
      ${d}
      <td class="validation-${n}">${s.fileType||"Unknown"}</td>
      ${h}
      ${u}
      ${m}
      ${f}
      <td>${s.fileSize||"-"}</td>
      <td>${y}</td>
    `,this.batchTableBody.appendChild(a),t.file||t.driveFileId){const w=a.querySelector(".play-btn-small");w&&w.addEventListener("click",g=>{const k=parseInt(g.target.dataset.index);this.playBatchFile(k)})}}updateBatchSummary(){const t=this.batchResults.filter(i=>i.status==="pass").length,e=this.batchResults.filter(i=>i.status==="warning").length,a=this.batchResults.filter(i=>i.status==="fail").length,s=this.batchResults.filter(i=>i.status==="error").length;this.batchPassCount.textContent=t,this.batchWarningCount.textContent=e,this.batchFailCount.textContent=a,this.batchErrorCount.textContent=s;const n=this.batchResults.filter(i=>i.status==="pass").reduce((i,r)=>{var c;const l=(c=r.analysis)==null?void 0:c.duration;return typeof l=="number"&&!isNaN(l)?i+l:i},0);this.batchTotalDuration.textContent=this.formatTotalDuration(n)}showBatchResults(t){this.hideAllSections(),this.batchResultsSection.style.display="block";const e=t.filter(r=>r.status==="pass").length,a=t.filter(r=>r.status==="warning").length,s=t.filter(r=>r.status==="fail").length,n=t.filter(r=>r.status==="error").length;this.batchPassCount.textContent=e,this.batchWarningCount.textContent=a,this.batchFailCount.textContent=s,this.batchErrorCount.textContent=n;const i=t.filter(r=>r.status==="pass").reduce((r,l)=>{var o;const c=(o=l.analysis)==null?void 0:o.duration;return typeof c=="number"&&!isNaN(c)?r+c:r},0);this.batchTotalDuration.textContent=this.formatTotalDuration(i),this.batchTableBody.innerHTML="",t.forEach((r,l)=>{const c=document.createElement("tr");c.className=`batch-row ${r.status}`;const o=r.analysis?b.formatDisplayText(r.analysis):{},d=this.getValidationStatus(r.validation,"fileType"),h=this.getValidationStatus(r.validation,"sampleRate"),u=this.getValidationStatus(r.validation,"bitDepth"),m=this.getValidationStatus(r.validation,"channels"),f=this.getValidationStatus(r.validation,"duration");c.innerHTML=`
        <td class="filename">${r.filename}</td>
        <td><span class="status-badge ${r.status}">${r.status}</span></td>
        <td class="validation-${d}">${o.fileType||"Unknown"}</td>
        <td class="validation-${h}">${o.sampleRate||"-"}</td>
        <td class="validation-${u}">${o.bitDepth||"-"}</td>
        <td class="validation-${m}">${o.channels||"-"}</td>
        <td class="validation-${f}">${o.duration||"-"}</td>
        <td>${o.fileSize||"-"}</td>
        <td><button class="play-btn-small" data-index="${l}">▶</button></td>
      `,this.batchTableBody.appendChild(c)}),this.batchResults=t,this.batchTableBody.querySelectorAll(".play-btn-small").forEach(r=>{r.addEventListener("click",l=>{const c=parseInt(l.target.dataset.index);this.playBatchFile(c)})})}formatValue(t){return t==null||t==="Unknown"?"-":t}formatDuration(t){if(!t||t==="Unknown")return"-";const e=Math.floor(t/60),a=Math.floor(t%60);return`${e}:${a.toString().padStart(2,"0")}`}formatTotalDuration(t){if(!t||t===0)return"0h 0m 0s";const e=Math.floor(t/3600),a=Math.floor(t%3600/60),s=Math.floor(t%60);return e>0?`${e}h ${a}m ${s}s`:a>0?`${a}m ${s}s`:`${s}s`}getValidationStatus(t,e){return!t||!t[e]?"":t[e].status}playBatchFile(t){if(!this.batchResults||!this.batchResults[t])return;const e=this.batchResults[t];if(e.file){const a=URL.createObjectURL(e.file);window.open(a,"_blank"),setTimeout(()=>URL.revokeObjectURL(a),1e3)}else if(e.driveFileId){const a=`https://drive.google.com/file/d/${e.driveFileId}/view`;window.open(a,"_blank")}}revalidateBatchResults(){if(!this.batchResults)return;const t=this.getCriteria();this.batchResults.forEach(e=>{e.analysis&&(e.validation=b.validateResults(e.analysis,t),e.status=this.getOverallStatus(e.validation,!1,e.filenameValidation))}),this.showBatchResults(this.batchResults)}getOverallStatus(t,e=!1,a=null){let s=Object.values(t).map(n=>n.status);if(e){const n=["sampleRate","bitDepth","channels"];s=Object.entries(t).filter(([i])=>!n.includes(i)).map(([,i])=>i.status)}return a&&a.status&&s.push(a.status),s.includes("fail")?"fail":s.includes("warning")?"warning":"pass"}getFileTypeFromName(t){const e=t.split(".").pop().toLowerCase();return{wav:"WAV",mp3:"MP3",flac:"FLAC",aac:"AAC",m4a:"M4A",ogg:"OGG"}[e]||e.toUpperCase()}cleanupForNewFile(){this.currentFile&&(this.currentFile=null),this.audioBuffer&&(this.audioBuffer=null),this.currentResults&&(this.currentResults=null),this.audioPlayer&&this.audioPlayer.src&&(this.audioPlayer.src.startsWith("blob:")&&URL.revokeObjectURL(this.audioPlayer.src),this.audioPlayer.src="")}cleanup(){this.cleanupForNewFile(),this.engine.audioAnalyzer.audioContext,window.gc&&typeof window.gc=="function"&&window.gc()}hideAllSections(){this.loading.style.display="none",this.error.style.display="none",this.resultsSection.style.display="none",this.advancedResultsSection.style.display="none",this.batchProgress.style.display="none",this.batchResultsSection.style.display="none"}}document.addEventListener("DOMContentLoaded",()=>{const p=new x;window.addEventListener("beforeunload",()=>{p.cleanup()}),document.addEventListener("visibilitychange",()=>{document.hidden&&p.cleanup()})});
