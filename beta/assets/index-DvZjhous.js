(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&a(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();class T{constructor(){this.audioContext=null,this.audioBuffer=null}async analyzeFile(e){const t=await e.arrayBuffer();if(e.name.toLowerCase().endsWith(".wav")){const a=new DataView(t),s=this.parseWavHeaders(a);let i=this.getFileType(e.name);return i==="WAV"&&(s.audioFormat===1?i="WAV (PCM)":typeof s.audioFormat=="number"?i=`WAV (Compressed - Format ${s.audioFormat})`:i="WAV (Unknown Format)"),{fileType:i,sampleRate:s.sampleRate,channels:s.channels,bitDepth:s.bitDepth,duration:s.duration,fileSize:e.size}}this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext));try{const a=t.slice(0);return this.audioBuffer=await this.audioContext.decodeAudioData(a),{fileType:this.getFileType(e.name),sampleRate:this.audioBuffer.sampleRate,channels:this.audioBuffer.numberOfChannels,duration:this.audioBuffer.duration,fileSize:e.size,bitDepth:this.estimateBitDepth(t,e.name)}}catch{return await this.analyzeFileHeaders(t,e.name,e.size)}}async analyzeFileHeaders(e,t,a){const s=new DataView(e),i={fileType:this.getFileType(t),fileSize:a};if(t.toLowerCase().endsWith(".wav")){const n=this.parseWavHeaders(s);Object.assign(i,n)}else i.sampleRate="Unknown",i.bitDepth="Unknown",i.channels="Unknown",i.duration="Unknown";return i}parseWavHeaders(e){try{if(String.fromCharCode(e.getUint8(0),e.getUint8(1),e.getUint8(2),e.getUint8(3))!=="RIFF")throw new Error("Not a valid WAV file");if(String.fromCharCode(e.getUint8(8),e.getUint8(9),e.getUint8(10),e.getUint8(11))!=="WAVE")throw new Error("Not a valid WAV file");let s=12;for(;s<e.byteLength-8;){const i=String.fromCharCode(e.getUint8(s),e.getUint8(s+1),e.getUint8(s+2),e.getUint8(s+3)),n=e.getUint32(s+4,!0);if(i==="fmt "){const l=e.getUint16(s+8,!0),r=e.getUint16(s+10,!0),c=e.getUint32(s+12,!0),o=e.getUint16(s+22,!0),d=this.calculateWavDuration(e,c,r,o);return{sampleRate:c,channels:r,bitDepth:o,duration:d,audioFormat:l}}s+=8+n}throw new Error("fmt chunk not found")}catch(t){return console.error("Error parsing WAV headers:",t),{sampleRate:"Unknown",channels:"Unknown",bitDepth:"Unknown",duration:"Unknown",audioFormat:"Unknown"}}}calculateWavDuration(e,t,a,s){try{let i=12;for(;i<e.byteLength-8;){const n=String.fromCharCode(e.getUint8(i),e.getUint8(i+1),e.getUint8(i+2),e.getUint8(i+3)),l=e.getUint32(i+4,!0);if(n==="data"){const r=s/8;return l/(a*r)/t}i+=8+l}return"Unknown"}catch{return"Unknown"}}getFileType(e){const t=e.split(".").pop().toLowerCase();return{wav:"WAV",mp3:"MP3",flac:"FLAC",aac:"AAC",m4a:"M4A",ogg:"OGG",webm:"WebM"}[t]||t.toUpperCase()}estimateBitDepth(e,t){if(t.toLowerCase().endsWith(".wav"))return"See WAV analysis";const a=t.split(".").pop().toLowerCase();return["mp3","aac","m4a"].includes(a)?"Compressed (variable)":"Unknown"}}class A{static matchesFileType(e,t){const a={matches:!1,status:"fail"};if(e===t)return a.matches=!0,a.status="pass",a;if(t==="wav"||t==="WAV")return e==="WAV (PCM)"||e==="WAV"?(a.matches=!0,a.status="pass",a):(e.startsWith("WAV")&&(a.matches=!0,a.status="warning"),a);const s=e.replace(/\s*\(.*\)/,"").trim(),i=t.toUpperCase();return s===i&&(a.matches=!0,a.status="pass"),a}static validateResults(e,t,a=!1){const s={},i=l=>l?Array.isArray(l)?l:[l]:[],n=i(t.fileType);if(n.length>0){let l={matches:!1,status:"fail"};for(const r of n){const c=this.matchesFileType(e.fileType,r);if(c.status==="pass"){l=c;break}else c.status==="warning"&&l.status==="fail"&&(l=c)}s.fileType={matches:l.matches,target:n,actual:e.fileType,status:l.status}}if(!a){const l=i(t.sampleRate).map(o=>parseInt(o)).filter(o=>!isNaN(o));if(l.length>0){const o=e.sampleRate,d=l.includes(o);s.sampleRate={matches:d,target:l,actual:o,status:d?"pass":"fail"}}const r=i(t.bitDepth).map(o=>parseInt(o)).filter(o=>!isNaN(o));if(r.length>0){const o=e.bitDepth,d=r.includes(o);s.bitDepth={matches:d,target:r,actual:o,status:d?"pass":"fail"}}const c=i(t.channels).map(o=>parseInt(o)).filter(o=>!isNaN(o));if(c.length>0){const o=e.channels,d=c.includes(o);s.channels={matches:d,target:c,actual:o,status:d?"pass":"fail"}}if(t.minDuration){const o=parseInt(t.minDuration),d=e.duration,u=typeof d=="number"&&d>=o;s.duration={matches:u,target:`${o}s minimum`,actual:d,status:u?"pass":"fail"}}}return s}static formatDuration(e){const t=Math.floor(e/3600),a=Math.floor(e%3600/60),s=Math.floor(e%60);return t>0?`${t}h:${a.toString().padStart(2,"0")}m:${s.toString().padStart(2,"0")}s`:`${a}m:${s.toString().padStart(2,"0")}s`}static formatDisplayText(e){const t={};return t.fileType=e.fileType,t.sampleRate=typeof e.sampleRate=="number"?`${(e.sampleRate/1e3).toFixed(1)} kHz`:e.sampleRate,t.bitDepth=typeof e.bitDepth=="number"?`${e.bitDepth}-bit`:e.bitDepth,t.channels=typeof e.channels=="number"?`${e.channels}${e.channels===1?" (Mono)":e.channels===2?" (Stereo)":""}`:e.channels,t.duration=typeof e.duration=="number"?this.formatDuration(e.duration):e.duration,t.fileSize=`${(e.fileSize/1024/1024).toFixed(2)} MB`,t}static formatAdvancedResults(e){const t={};return t.peakLevel=e.peakDb===-1/0?"Silent":`${e.peakDb.toFixed(1)} dB`,t.peakStatus=e.peakDb<=-6?"pass":e.peakDb<=-3?"warning":"fail",t.noiseFloor=e.noiseFloorDb===-1/0?"Silent":`${e.noiseFloorDb.toFixed(1)} dB`,t.noiseStatus=e.noiseFloorDb<=-60?"pass":"fail",t.normalization=e.normalizationStatus.message,t.normalizationStatus=e.normalizationStatus.status==="normalized"?"pass":"fail",t}}class P{constructor(){this.analysisInProgress=!1}async analyzeAudioBuffer(e,t=null){e.sampleRate;const a=e.numberOfChannels,s=e.length,i=[];for(let n=0;n<a;n++)i.push(e.getChannelData(n));this.analysisInProgress=!0;try{t&&t("Analyzing peak levels...",0);let n=0;for(let o=0;o<a;o++){const d=i[o];for(let u=0;u<s;u++){if(!this.analysisInProgress)throw new Error("Analysis cancelled");const g=Math.abs(d[u]);if(g>n&&(n=g),u%1e4===0){const h=(o*s+u)/(a*s)*.5;t&&t("Analyzing peak levels...",h),u%1e5===0&&await new Promise(p=>setTimeout(p,1))}}}const l=n>0?20*Math.log10(n):-1/0;t&&t("Analyzing noise floor...",.5);const r=await this.analyzeNoiseFloor(i,a,s,t);t&&t("Checking normalization...",.9);const c=this.checkNormalization(l);return t&&t("Analysis complete!",1),{peakDb:l,noiseFloorDb:r,normalizationStatus:c}}finally{this.analysisInProgress=!1}}async analyzeNoiseFloor(e,t,a,s){const i=Math.floor(a/100),n=[];for(let d=0;d<t;d++){const u=e[d];for(let g=0;g<a-i;g+=i){let h=0;for(let m=g;m<g+i&&m<a;m++)h+=u[m]*u[m];const p=Math.sqrt(h/i);n.push(p)}}n.sort((d,u)=>d-u);const l=Math.floor(n.length*.2),r=n.slice(0,l),c=r.reduce((d,u)=>d+u,0)/r.length;return c>0?20*Math.log10(c):-1/0}checkNormalization(e){return Math.abs(e- -6)<=.1?{status:"normalized",message:"Properly normalized to -6dB"}:e>-6?{status:"too_loud",message:`Too loud: ${e.toFixed(1)}dB (target: -6dB)`}:{status:"too_quiet",message:`Too quiet: ${e.toFixed(1)}dB (target: -6dB)`}}cancelAnalysis(){this.analysisInProgress=!1}}class V{async analyzeHeaders(e){const a=await e.slice(0,102400).arrayBuffer(),s=new DataView(a),i={filename:e.name,fileSize:e.size,fileType:this.getFileType(e.name)};if(e.name.toLowerCase().endsWith(".wav")){const n=this.parseWavHeaders(s,e.size);Object.assign(i,n),n.formatType&&(i.fileType=n.formatType)}else e.name.toLowerCase().endsWith(".mp3")?Object.assign(i,this.parseMp3Headers(s,e.size)):e.name.toLowerCase().endsWith(".flac")?Object.assign(i,this.parseFlacHeaders(s,e.size)):(i.sampleRate="Unknown",i.bitDepth="Unknown",i.channels="Unknown",i.duration="Unknown");return i}parseWavHeaders(e,t){try{if(String.fromCharCode(e.getUint8(0),e.getUint8(1),e.getUint8(2),e.getUint8(3))!=="RIFF")throw new Error("Not a valid WAV file");if(String.fromCharCode(e.getUint8(8),e.getUint8(9),e.getUint8(10),e.getUint8(11))!=="WAVE")throw new Error("Not a valid WAV file");let i=12;for(;i<e.byteLength-8;){const n=String.fromCharCode(e.getUint8(i),e.getUint8(i+1),e.getUint8(i+2),e.getUint8(i+3)),l=e.getUint32(i+4,!0);if(n==="fmt "){const r=e.getUint16(i+8,!0),c=e.getUint16(i+10,!0),o=e.getUint32(i+12,!0),d=e.getUint16(i+22,!0),u=e.getUint32(i+16,!0),g=t-44,h=u>0?g/u:"Unknown";return{sampleRate:o,channels:c,bitDepth:d,duration:typeof h=="number"?h:"Unknown",audioFormat:r,formatType:r===1?"WAV (PCM)":`WAV (Format ${r})`}}i+=8+l}throw new Error("fmt chunk not found")}catch{return{sampleRate:"Unknown",channels:"Unknown",bitDepth:"Unknown",duration:"Unknown",formatType:"WAV"}}}parseMp3Headers(e){try{let t=0;for(;t<e.byteLength-4;){if(e.getUint8(t)===255&&(e.getUint8(t+1)&224)===224){const a=e.getUint32(t,!1),s=a>>19&3,i=a>>17&3,n=a>>12&15,l=a>>10&3,r=a>>6&3,c=[44100,48e3,32e3],o=r===3?1:2;return{sampleRate:c[l]||"Unknown",channels:o,bitDepth:"Compressed (variable)",duration:"Unknown"}}t++}throw new Error("No MP3 frame found")}catch{return{sampleRate:"Unknown",channels:"Unknown",bitDepth:"Compressed (variable)",duration:"Unknown"}}}parseFlacHeaders(e){try{if(String.fromCharCode(e.getUint8(0),e.getUint8(1),e.getUint8(2),e.getUint8(3))!=="fLaC")throw new Error("Not a valid FLAC file");const a=e.getUint8(4),s=(a&128)!==0;if((a&127)===0){const n=e.getUint16(5,!1),l=e.getUint16(7,!1),r=e.getUint16(18,!1),c=e.getUint8(20),o=r<<4|c>>4,d=(c>>1&7)+1,u=((c&1)<<4|e.getUint8(21)>>4)+1;return{sampleRate:o,channels:d,bitDepth:u,duration:"Unknown"}}throw new Error("STREAMINFO block not found")}catch{return{sampleRate:"Unknown",channels:"Unknown",bitDepth:"Unknown",duration:"Unknown"}}}getFileType(e){const t=e.split(".").pop().toLowerCase();return{wav:"WAV",mp3:"MP3",flac:"FLAC",aac:"AAC",m4a:"M4A",ogg:"OGG"}[t]||t.toUpperCase()}}class z{constructor(e){this.analyzer=new V,this.validator=e,this.cancelled=!1}async processBatch(e,t,a,s){this.cancelled=!1;const i=[],n=Date.now();for(let l=0;l<e.length&&!this.cancelled;l++){const r=e[l];let c;try{const o=await this.analyzer.analyzeHeaders(r),d=typeof t=="function"?t():t,u=this.validator.validateResults(o,d);c={filename:r.name,file:r,analysis:o,validation:u,status:this.getOverallStatus(u)}}catch(o){c={filename:r.name,file:r,analysis:null,validation:null,status:"error",error:o.message}}i.push(c),s&&s(c),a&&a({current:l+1,total:e.length,currentFile:r.name,percentage:(l+1)/e.length*100,elapsedTime:Date.now()-n})}return i}getOverallStatus(e){const t=Object.values(e).map(a=>a.status);return t.includes("fail")?"fail":t.includes("warning")?"warning":"pass"}cancel(){this.cancelled=!0}}const L=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",O=window.location.pathname.startsWith("/beta"),C=L?"http://localhost:3000":O?"https://audio-analyzer.tinytech.site/beta":"https://audio-analyzer.tinytech.site",E={CLIENT_ID:"708688597317-bmmrje6hqg8vo52nctned54m32q8uhsr.apps.googleusercontent.com",REDIRECT_URI:C,SCOPE:"https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email",DISCOVERY_DOCS:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]},x={CLIENT_ID:"0y78slky3xitt421wmoa0fjdz6fi14hn",REDIRECT_URI:C,AUTHORIZATION_URL:"https://account.box.com/api/oauth2/authorize",TOKEN_URL:"https://api.box.com/oauth2/token",API_URL:"https://api.box.com/2.0",PROXY_URL:"https://box-proxy-708688597317.us-central1.run.app"};class M{constructor(){this.isInitialized=!1,this.accessToken=null,this.codeClient=null,this.userInfo=null}async init(){if(!this.isInitialized)return new Promise((e,t)=>{this.loadGoogleAPI().then(()=>{this.initializeGIS().then(e).catch(t)}).catch(t)})}async loadGoogleAPI(){return new Promise((e,t)=>{if(window.gapi){e();return}const a=document.createElement("script");a.src="https://apis.google.com/js/api.js",a.onload=()=>e(),a.onerror=()=>t(new Error("Failed to load Google API script")),document.head.appendChild(a)})}async initializeGIS(){return new Promise((e,t)=>{const a=document.createElement("script");a.src="https://accounts.google.com/gsi/client",a.onload=()=>{this.setupGIS().then(e).catch(t)},a.onerror=()=>t(new Error("Failed to load Google Identity Services")),document.head.appendChild(a)})}async setupGIS(){return new Promise((e,t)=>{const a=setTimeout(()=>{t(new Error("Google API setup timeout"))},1e4);window.gapi.load("client",async()=>{try{clearTimeout(a),await window.gapi.client.init({discoveryDocs:E.DISCOVERY_DOCS}),this.tokenClient=window.google.accounts.oauth2.initTokenClient({client_id:E.CLIENT_ID,scope:E.SCOPE,callback:s=>{if(s.error){console.error("Token response error:",s),t(new Error(`Google sign-in failed: ${s.error}`));return}this.accessToken=s.access_token;const i={access_token:s.access_token,expires_at:Date.now()+s.expires_in*1e3,scope:s.scope};localStorage.setItem("google_token",JSON.stringify(i)),e(i)}}),this.isInitialized=!0,e()}catch(s){clearTimeout(a),console.error("Google API setup error:",s);let i="Unknown setup error";s&&typeof s=="object"?i=s.message||s.error||s.details||JSON.stringify(s):s&&(i=s.toString()),t(new Error(`Failed to setup Google API: ${i}`))}})})}async signIn(){return this.isInitialized||await this.init(),new Promise((e,t)=>{try{this.tokenClient.callback=a=>{if(a.error){console.error("Token response error:",a),t(new Error(`Google sign-in failed: ${a.error}`));return}if(!(a.scope&&a.scope.includes("https://www.googleapis.com/auth/drive.readonly"))){console.warn("Drive scope not granted, retrying with consent prompt"),this.tokenClient.requestAccessToken({prompt:"consent"});return}this.accessToken=a.access_token;const i={access_token:a.access_token,expires_at:Date.now()+a.expires_in*1e3,scope:a.scope};localStorage.setItem("google_token",JSON.stringify(i)),e(i)},this.tokenClient.requestAccessToken({prompt:""})}catch(a){console.error("Google sign-in error:",a);let s="Unknown sign-in error";a&&typeof a=="object"?s=a.error||a.message||a.details||JSON.stringify(a):a&&(s=a.toString()),t(new Error(`Google sign-in failed: ${s}`))}})}async getValidToken(){const e=localStorage.getItem("google_token");if(e)try{const t=JSON.parse(e);if(t.expires_at>Date.now()+3e5)return this.accessToken=t.access_token,t}catch(t){console.warn("Invalid stored token:",t),localStorage.removeItem("google_token")}return await this.signIn()}async getUserInfo(){const e=await this.getValidToken();try{const t=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${e.access_token}`}});if(!t.ok)throw new Error(`Failed to get user info: ${t.status}`);const a=await t.json();return this.userInfo=a,a}catch(t){throw new Error(`Failed to get user info: ${t.message}`)}}async downloadFile(e){const t=await this.getValidToken();try{const a=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?fields=name,mimeType,size`,{headers:{Authorization:`Bearer ${t.access_token}`}});if(!a.ok)throw a.status===403?(this.signOut(),new Error("Insufficient permissions to access Google Drive. Please sign in again and grant Drive access.")):new Error(`Failed to get file metadata: ${a.status}`);const s=await a.json(),i=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:{Authorization:`Bearer ${t.access_token}`}});if(!i.ok)throw new Error(`Failed to download file: ${i.status}`);const n=await i.blob();return new File([n],s.name,{type:s.mimeType||"audio/mpeg"})}catch(a){throw new Error(`Google Drive download failed: ${a.message}`)}}async listAudioFilesInFolder(e){const t=await this.getValidToken();try{const s=["audio/mpeg","audio/wav","audio/x-wav","audio/wave","audio/flac","audio/x-flac","audio/aac","audio/mp4","audio/ogg","audio/x-m4a"].map(r=>`mimeType='${r}'`).join(" or "),i=`'${e}' in parents and (${s}) and trashed=false`,n=await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(i)}&fields=files(id,name,mimeType,size,modifiedTime,videoMediaMetadata)&pageSize=1000`,{headers:{Authorization:`Bearer ${t.access_token}`}});if(!n.ok)throw n.status===403?(this.signOut(),new Error("Insufficient permissions to access Google Drive folder. Please sign in again.")):new Error(`Failed to list folder contents: ${n.status}`);return(await n.json()).files||[]}catch(a){throw new Error(`Failed to list folder: ${a.message}`)}}async listFilesInFolder(e,t){const a=await this.getValidToken();try{const s=`'${e}' in parents and trashed=false`,i=await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(s)}&fields=files(id,name,mimeType)&pageSize=1000`,{headers:{Authorization:`Bearer ${a.access_token}`}});if(!i.ok)throw i.status===403?(this.signOut(),new Error("Insufficient permissions to access Google Drive folder. Please sign in again.")):new Error(`Failed to list folder contents: ${i.status}`);const l=(await i.json()).files||[];return t?l.filter(r=>r.name.toLowerCase().endsWith(t.toLowerCase())):l}catch(s){throw new Error(`Failed to list folder: ${s.message}`)}}async downloadFileHeaders(e,t=102400){const a=await this.getValidToken();try{const s=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:{Authorization:`Bearer ${a.access_token}`,Range:`bytes=0-${t-1}`}});if(!s.ok&&s.status!==206)throw new Error(`Failed to download file headers: ${s.status}`);return await s.blob()}catch(s){throw new Error(`Failed to download headers: ${s.message}`)}}async getFileMetadata(e){if(e.videoMediaMetadata)return e;const t=await this.getValidToken();try{const a=await fetch(`https://www.googleapis.com/drive/v3/files/${e.id}?fields=name,mimeType,size,modifiedTime,videoMediaMetadata`,{headers:{Authorization:`Bearer ${t.access_token}`}});if(!a.ok)throw a.status===403?(this.signOut(),new Error("Insufficient permissions to access Google Drive. Please sign in again and grant Drive access.")):new Error(`Failed to get file metadata: ${a.status}`);return await a.json()}catch(a){throw new Error(`Google Drive metadata fetch failed: ${a.message}`)}}signOut(){this.accessToken&&window.google&&window.google.accounts.oauth2.revoke(this.accessToken),this.accessToken=null,localStorage.removeItem("google_token")}isSignedIn(){const e=localStorage.getItem("google_token");if(!e)return!1;try{return JSON.parse(e).expires_at>Date.now()}catch{return!1}}}class _{constructor(){this.isInitialized=!1,this.accessToken=null,this.userInfo=null}async init(){this.isInitialized||(console.log("[Box Auth] Init started at:",new Date().toISOString()),await this.handleOAuthCallback(),console.log("[Box Auth] Init completed at:",new Date().toISOString()),this.isInitialized=!0)}async handleOAuthCallback(){const e=new URLSearchParams(window.location.search);if(e.has("code")){console.log("[Box OAuth] Callback received at:",new Date().toISOString());const t=e.get("code"),a=e.get("state"),s=localStorage.getItem("box_oauth_state");if(!s||s!==a)return console.error("OAuth state mismatch"),!1;console.log("[Box OAuth] State verified, exchanging code at:",new Date().toISOString());try{const i=await fetch(`${x.PROXY_URL}?action=token&code=${encodeURIComponent(t)}`);if(console.log("[Box OAuth] Token exchange response at:",new Date().toISOString(),"Status:",i.status),!i.ok){const r=await i.text();throw console.error("[Box OAuth] Token exchange failed:",r),new Error(`Token exchange failed: ${i.status}`)}const n=await i.json(),l={access_token:n.access_token,refresh_token:n.refresh_token,expires_at:Date.now()+n.expires_in*1e3};return localStorage.setItem("box_token",JSON.stringify(l)),this.accessToken=n.access_token,localStorage.setItem("box_just_authenticated","true"),window.history.replaceState({},document.title,window.location.pathname),!0}catch(i){return console.error("Failed to exchange authorization code:",i),!1}}return!1}async signIn(){this.isInitialized||await this.init();const e=Math.random().toString(36).substring(2,15);localStorage.setItem("box_oauth_state",e);const t=new URL(x.AUTHORIZATION_URL);t.searchParams.append("client_id",x.CLIENT_ID),t.searchParams.append("response_type","code"),t.searchParams.append("redirect_uri",x.REDIRECT_URI),t.searchParams.append("state",e),window.location.href=t.toString()}async getValidToken(){const e=localStorage.getItem("box_token");if(e)try{const t=JSON.parse(e);if(t.expires_at>Date.now()+3e5)return this.accessToken=t.access_token,t}catch(t){console.warn("Invalid stored token:",t),localStorage.removeItem("box_token")}throw new Error("Not signed in to Box")}async getUserInfo(){const e=await this.getValidToken();try{const t=await fetch(`${x.API_URL}/users/me`,{headers:{Authorization:`Bearer ${e.access_token}`}});if(!t.ok)throw new Error(`Failed to get user info: ${t.status}`);const a=await t.json();return this.userInfo=a,a}catch(t){throw new Error(`Failed to get user info: ${t.message}`)}}async downloadFile(e,t=null){try{const a=await this.getValidToken();console.log("[Box Download] Token retrieved:",a?"Yes":"No","Expires at:",new Date(a.expires_at).toISOString());const s={Authorization:`Bearer ${a.access_token}`};console.log("[Box Download] Fetching metadata for file:",e);const i=await fetch(`${x.API_URL}/files/${e}`,{headers:s});if(!i.ok){const c=await i.text();throw console.error("[Box Download] Metadata fetch failed:",i.status,c),i.status===401?(this.signOut(),new Error("Session expired. Please sign in again.")):new Error(`Failed to get file metadata: ${i.status}`)}const n=await i.json();console.log("[Box Download] Metadata retrieved:",n.name),console.log("[Box Download] Downloading file content...");const l=await fetch(`${x.API_URL}/files/${e}/content`,{headers:s});if(!l.ok){const c=await l.text();throw console.error("[Box Download] File download failed:",l.status,c),new Error(`Failed to download file: ${l.status}`)}const r=await l.blob();return new File([r],n.name,{type:n.content_type||"audio/mpeg"})}catch(a){throw new Error(`Box download failed: ${a.message}`)}}async listAudioFilesInFolder(e,t=null){try{const a=`${x.API_URL}/folders/${e}/items?fields=id,name,type,size,modified_at&limit=1000`;let s=`${x.PROXY_URL}?url=${encodeURIComponent(a)}`;if(t)s+=`&boxapi=${encodeURIComponent(t)}`;else{const o=await this.getValidToken();s+=`&token=${encodeURIComponent(o.access_token)}`}const i=await fetch(s);if(!i.ok)throw!t&&i.status===401?(this.signOut(),new Error("Session expired. Please sign in again.")):new Error(`Failed to list folder contents: ${i.status}`);const l=(await i.json()).entries||[],r=[".mp3",".wav",".flac",".aac",".m4a",".ogg"];return l.filter(o=>{if(o.type!=="file")return!1;const d=o.name.toLowerCase();return r.some(u=>d.endsWith(u))})}catch(a){throw new Error(`Failed to list folder: ${a.message}`)}}async listFilesInFolder(e,t,a=null){try{const s={};if(a)s.BoxApi=`shared_link=${a}`;else{const c=await this.getValidToken();s.Authorization=`Bearer ${c.access_token}`}const i=await fetch(`${x.API_URL}/folders/${e}/items?fields=id,name,type&limit=1000`,{headers:s});if(!i.ok)throw!a&&i.status===401?(this.signOut(),new Error("Session expired. Please sign in again.")):new Error(`Failed to list folder contents: ${i.status}`);let r=((await i.json()).entries||[]).filter(c=>c.type==="file");return t&&(r=r.filter(c=>c.name.toLowerCase().endsWith(t.toLowerCase()))),r}catch(s){throw new Error(`Failed to list folder: ${s.message}`)}}async downloadFileHeaders(e,t=102400,a=null){try{const s={Range:`bytes=0-${t-1}`};if(a)s.BoxApi=`shared_link=${a}`;else{const n=await this.getValidToken();s.Authorization=`Bearer ${n.access_token}`}const i=await fetch(`${x.API_URL}/files/${e}/content`,{headers:s});if(!i.ok&&i.status!==206)throw new Error(`Failed to download file headers: ${i.status}`);return await i.blob()}catch(s){throw new Error(`Failed to download headers: ${s.message}`)}}async getFileMetadata(e,t=null){try{const a={};if(t)a.BoxApi=`shared_link=${t}`;else{const i=await this.getValidToken();a.Authorization=`Bearer ${i.access_token}`}const s=await fetch(`${x.API_URL}/files/${e.id}?fields=id,name,size,modified_at,content_type`,{headers:a});if(!s.ok)throw!t&&s.status===401?(this.signOut(),new Error("Session expired. Please sign in again.")):new Error(`Failed to get file metadata: ${s.status}`);return await s.json()}catch(a){throw new Error(`Box metadata fetch failed: ${a.message}`)}}signOut(){this.accessToken=null,this.userInfo=null,localStorage.removeItem("box_token"),localStorage.removeItem("box_oauth_state")}isSignedIn(){const e=localStorage.getItem("box_token");if(!e)return!1;try{return JSON.parse(e).expires_at>Date.now()}catch{return!1}}}class N{constructor(){this.audioAnalyzer=new T,this.levelAnalyzer=new P}async analyzeFile(e){return await this.audioAnalyzer.analyzeFile(e)}async analyzeAdvanced(e,t){return await this.levelAnalyzer.analyzeAudioBuffer(e,t)}validateCriteria(e,t){return A.validateResults(e,t)}formatResults(e){return A.formatDisplayText(e)}formatAdvancedResults(e){return A.formatAdvancedResults(e)}cancelAdvancedAnalysis(){this.levelAnalyzer.cancelAnalysis()}}class H{constructor(){this.engine=new N,this.googleAuth=new M,this.boxAuth=new _,this.batchProcessor=new z(A),this.currentFile=null,this.audioBuffer=null,this.isAnalyzing=!1,this.currentResults=null,this.processingFile=!1,this.batchMode=!1,this.batchResults=null,this.batchCancelled=!1,this.currentBatchSource=null,this.initializeElements(),this.attachEventListeners(),this.loadSettings()}initializeElements(){this.tabButtons=document.querySelectorAll(".tab-button"),this.tabContents=document.querySelectorAll(".tab-content"),this.dropZone=document.getElementById("dropZone"),this.browseBtn=document.getElementById("browseBtn"),this.fileInput=document.getElementById("fileInput"),this.driveUrl=document.getElementById("driveUrl"),this.analyzeUrl=document.getElementById("analyzeUrl"),this.authText=document.getElementById("authText"),this.signInBtn=document.getElementById("signInBtn"),this.signOutBtn=document.getElementById("signOutBtn"),this.boxUrl=document.getElementById("boxUrl"),this.analyzeBoxUrl=document.getElementById("analyzeBoxUrl"),this.boxAuthText=document.getElementById("boxAuthText"),this.boxSignInBtn=document.getElementById("boxSignInBtn"),this.boxSignOutBtn=document.getElementById("boxSignOutBtn"),this.analysisTypeSection=document.getElementById("analysisTypeSection"),this.enableAudioAnalysis=document.getElementById("enableAudioAnalysis"),this.enableFilenameValidation=document.getElementById("enableFilenameValidation"),this.filenameValidationFields=document.getElementById("filenameValidationFields"),this.speakerId=document.getElementById("speakerId"),this.scriptsFolderUrl=document.getElementById("scriptsFolderUrl"),this.boxAnalysisTypeSection=document.getElementById("boxAnalysisTypeSection"),this.boxEnableAudioAnalysis=document.getElementById("boxEnableAudioAnalysis"),this.boxEnableFilenameValidation=document.getElementById("boxEnableFilenameValidation"),this.boxFilenameValidationFields=document.getElementById("boxFilenameValidationFields"),this.boxSpeakerId=document.getElementById("boxSpeakerId"),this.boxScriptsFolderUrl=document.getElementById("boxScriptsFolderUrl"),this.presetSelector=document.getElementById("presetSelector"),this.targetFileType=document.getElementById("targetFileType"),this.targetSampleRate=document.getElementById("targetSampleRate"),this.targetBitDepth=document.getElementById("targetBitDepth"),this.targetChannels=document.getElementById("targetChannels"),this.targetMinDuration=document.getElementById("targetMinDuration"),this.playerSection=document.getElementById("playerSection"),this.resultsSection=document.getElementById("resultsSection"),this.advancedResultsSection=document.getElementById("advancedResultsSection"),this.audioPlayer=document.getElementById("audioPlayer"),this.playPause=document.getElementById("playPause"),this.advancedAnalysisBtn=document.getElementById("advancedAnalysisBtn"),this.advancedProgress=document.getElementById("advancedProgress"),this.progressFill=document.getElementById("progressFill"),this.progressText=document.getElementById("progressText"),this.cancelAnalysis=document.getElementById("cancelAnalysis"),this.loading=document.getElementById("loading"),this.error=document.getElementById("error"),this.errorMessage=document.getElementById("errorMessage"),this.batchProgress=document.getElementById("batchProgress"),this.batchCurrentFile=document.getElementById("batchCurrentFile"),this.batchProgressText=document.getElementById("batchProgressText"),this.batchProgressBar=document.getElementById("batchProgressBar"),this.cancelBatch=document.getElementById("cancelBatch"),this.batchResultsSection=document.getElementById("batchResultsSection"),this.batchPassCount=document.getElementById("batchPassCount"),this.batchWarningCount=document.getElementById("batchWarningCount"),this.batchFailCount=document.getElementById("batchFailCount"),this.batchErrorCount=document.getElementById("batchErrorCount"),this.batchTotalDuration=document.getElementById("batchTotalDuration"),this.batchTableBody=document.getElementById("batchTableBody")}attachEventListeners(){this.tabButtons.forEach(e=>{e.addEventListener("click",()=>this.switchTab(e.dataset.tab))}),this.browseBtn.addEventListener("click",e=>{e.stopPropagation(),this.fileInput.value="",this.fileInput.click()}),this.fileInput.addEventListener("change",e=>{const t=Array.from(e.target.files||[]);t.length>0&&this.handleFilesSelect(t)}),this.dropZone.addEventListener("dragover",e=>{e.preventDefault(),this.dropZone.classList.add("drag-over")}),this.dropZone.addEventListener("dragleave",()=>{this.dropZone.classList.remove("drag-over")}),this.dropZone.addEventListener("drop",e=>{e.preventDefault(),this.dropZone.classList.remove("drag-over");const t=Array.from(e.dataTransfer.files||[]).filter(a=>a.type.startsWith("audio/"));t.length>0&&this.handleFilesSelect(t)}),this.dropZone.addEventListener("click",()=>this.fileInput.click()),this.analyzeUrl.addEventListener("click",()=>this.handleGoogleDriveUrl()),this.driveUrl.addEventListener("keypress",e=>{e.key==="Enter"&&this.handleGoogleDriveUrl()}),this.signInBtn.addEventListener("click",()=>this.handleSignIn()),this.signOutBtn.addEventListener("click",()=>this.handleSignOut()),this.analyzeBoxUrl.addEventListener("click",()=>this.handleBoxUrl()),this.boxUrl.addEventListener("keypress",e=>{e.key==="Enter"&&this.handleBoxUrl()}),this.boxSignInBtn.addEventListener("click",()=>this.handleBoxSignIn()),this.boxSignOutBtn.addEventListener("click",()=>this.handleBoxSignOut()),this.presetSelector.addEventListener("change",()=>this.handlePresetChange()),this.enableFilenameValidation.addEventListener("change",()=>this.toggleFilenameValidationFields()),this.enableAudioAnalysis.addEventListener("change",()=>this.validateAnalysisTypeSelection()),this.speakerId.addEventListener("input",()=>this.saveFilenameValidationSettings()),this.scriptsFolderUrl.addEventListener("input",()=>this.saveFilenameValidationSettings()),this.boxEnableFilenameValidation.addEventListener("change",()=>this.toggleBoxFilenameValidationFields()),this.boxEnableAudioAnalysis.addEventListener("change",()=>this.validateBoxAnalysisTypeSelection()),this.boxSpeakerId.addEventListener("input",()=>this.saveBoxFilenameValidationSettings()),this.boxScriptsFolderUrl.addEventListener("input",()=>this.saveBoxFilenameValidationSettings()),[this.targetFileType,this.targetSampleRate,this.targetBitDepth,this.targetChannels].forEach(e=>{e.addEventListener("change",()=>this.saveCriteria())}),this.targetMinDuration.addEventListener("input",()=>this.saveCriteria()),this.playPause.addEventListener("click",()=>this.togglePlayback()),this.audioPlayer.addEventListener("loadedmetadata",()=>{this.playPause.textContent="Play"}),this.advancedAnalysisBtn.addEventListener("click",()=>this.runAdvancedAnalysis()),this.cancelAnalysis.addEventListener("click",()=>this.cancelAdvancedAnalysis()),this.cancelBatch.addEventListener("click",()=>this.cancelBatchProcessing())}loadSettings(){const e=localStorage.getItem("audio-analyzer-settings");if(e)try{const a=JSON.parse(e);if(a.criteria){const s=(i,n)=>{Array.from(i.options).forEach(r=>{r.selected=!1}),(Array.isArray(n)?n:n?[n]:[]).forEach(r=>{const c=Array.from(i.options).find(o=>o.value===r);c&&(c.selected=!0)})};s(this.targetFileType,a.criteria.fileType||[]),s(this.targetSampleRate,a.criteria.sampleRate||[]),s(this.targetBitDepth,a.criteria.bitDepth||[]),s(this.targetChannels,a.criteria.channels||[]),this.targetMinDuration.value=a.criteria.minDuration||""}}catch(a){console.warn("Failed to load settings from localStorage:",a)}const t=localStorage.getItem("audio-analyzer-selected-preset");t?(this.presetSelector.value=t,this.handlePresetChange()):(this.presetSelector.value="auditions",this.handlePresetChange()),this.loadFilenameValidationSettings(),this.loadBoxFilenameValidationSettings(),this.googleAuth.init().catch(a=>console.error("Google Auth init error:",a)),this.updateAuthStatus(),this.boxAuth.init().then(()=>{this.updateBoxAuthStatus(),localStorage.getItem("box_just_authenticated")==="true"&&(localStorage.removeItem("box_just_authenticated"),this.switchTab("box"))}).catch(a=>console.error("Box Auth init error:",a))}updateAuthStatus(){const e=this.googleAuth.isSignedIn();if(console.log("updateAuthStatus called, isSignedIn:",e),console.log("signInBtn element:",this.signInBtn),e){const t=this.googleAuth.getUserInfo();t&&t.name?this.authText.textContent=`✓ Signed in as ${t.name}`:this.authText.textContent="✓ Signed in to Google Drive",this.signInBtn.style.display="none",this.signOutBtn.style.display="inline-block"}else this.authText.textContent="Not signed in to Google",this.signInBtn.style.display="inline-block",this.signOutBtn.style.display="none",console.log("Set signInBtn display to inline-block")}async handleSignIn(){try{await this.googleAuth.signIn(),this.updateAuthStatus()}catch(e){console.error("Sign-in failed:",e),this.showError(`Google sign-in failed: ${e.message}`)}}handleSignOut(){this.googleAuth.signOut(),this.updateAuthStatus()}updateBoxAuthStatus(){if(this.boxAuth.isSignedIn()){const t=this.boxAuth.userInfo;t&&t.name?this.boxAuthText.textContent=`✓ Signed in as ${t.name}`:this.boxAuthText.textContent="✓ Signed in to Box",this.boxSignInBtn.style.display="none",this.boxSignOutBtn.style.display="inline-block"}else this.boxAuthText.textContent="Not signed in to Box",this.boxSignInBtn.style.display="inline-block",this.boxSignOutBtn.style.display="none"}async handleBoxSignIn(){try{await this.boxAuth.signIn(),this.updateBoxAuthStatus()}catch(e){console.error("Box sign-in failed:",e),this.showError(`Box sign-in failed: ${e.message}`)}}handleBoxSignOut(){this.boxAuth.signOut(),this.updateBoxAuthStatus()}getCriteria(){const e=a=>Array.from(a.selectedOptions).map(s=>s.value);return{fileType:e(this.targetFileType),sampleRate:e(this.targetSampleRate),bitDepth:e(this.targetBitDepth),channels:e(this.targetChannels),minDuration:this.targetMinDuration.value||""}}saveCriteria(){const t={criteria:this.getCriteria()};localStorage.setItem("audio-analyzer-settings",JSON.stringify(t)),this.currentResults&&this.validateAndDisplayResults(this.currentResults),this.batchResults&&this.batchMode&&this.revalidateBatchResults()}getPresetConfigurations(){return{auditions:{name:"Auditions",fileType:["wav"],sampleRate:["48000"],bitDepth:["24"],channels:["1"],minDuration:"120"},"character-recordings":{name:"Character Recordings",fileType:["wav"],sampleRate:["48000"],bitDepth:["24"],channels:["1"],minDuration:""},"p2b2-pairs-mono":{name:"P2B2 Pairs (Mono)",fileType:["wav"],sampleRate:["44100","48000"],bitDepth:["16","24"],channels:["1"],minDuration:""},"p2b2-pairs-stereo":{name:"P2B2 Pairs (Stereo)",fileType:["wav"],sampleRate:["44100","48000"],bitDepth:["16","24"],channels:["2"],minDuration:""},"p2b2-pairs-mixed":{name:"P2B2 Pairs (Mixed)",fileType:["wav"],sampleRate:["44100","48000"],bitDepth:["16","24"],channels:["1","2"],minDuration:""},"three-hour":{name:"Three Hour",fileType:["wav"],sampleRate:["48000"],bitDepth:["24"],channels:["1"],minDuration:"",supportsFilenameValidation:!0,filenameValidationType:"script-match"},"bilingual-conversational":{name:"Bilingual Conversational",fileType:["wav"],sampleRate:["48000"],bitDepth:["16","24"],channels:["2"],minDuration:""},custom:{name:"Custom"}}}handlePresetChange(){const e=this.presetSelector.value,t=document.getElementById("customCriteriaSection");if(e){if(e==="custom")t.style.display="block";else{t.style.display="none";const s=this.getPresetConfigurations()[e];if(s){const i=(n,l)=>{Array.from(n.options).forEach(c=>{c.selected=!1}),(Array.isArray(l)?l:l?[l]:[]).forEach(c=>{const o=Array.from(n.options).find(d=>d.value===c);o&&(o.selected=!0)})};i(this.targetFileType,s.fileType||[]),i(this.targetSampleRate,s.sampleRate||[]),i(this.targetBitDepth,s.bitDepth||[]),i(this.targetChannels,s.channels||[]),this.targetMinDuration.value=s.minDuration||"",this.saveCriteria(),this.currentResults&&this.validateAndDisplayResults(this.currentResults),this.batchResults&&this.batchMode&&this.revalidateBatchResults(),s.supportsFilenameValidation?(this.analysisTypeSection.style.display="block",this.enableFilenameValidation.checked?this.filenameValidationFields.style.display="block":this.filenameValidationFields.style.display="none"):(this.analysisTypeSection.style.display="none",this.filenameValidationFields.style.display="none"),this.boxAnalysisTypeSection.style.display="none",this.boxFilenameValidationFields.style.display="none"}}localStorage.setItem("audio-analyzer-selected-preset",e)}}toggleFilenameValidationFields(){this.enableFilenameValidation.checked?this.filenameValidationFields.style.display="block":this.filenameValidationFields.style.display="none",this.saveFilenameValidationSettings()}validateAnalysisTypeSelection(){!this.enableAudioAnalysis.checked&&!this.enableFilenameValidation.checked&&(this.enableAudioAnalysis.checked=!0,alert("At least one analysis type must be selected")),this.saveFilenameValidationSettings()}saveFilenameValidationSettings(){const e={enableAudioAnalysis:this.enableAudioAnalysis.checked,enableFilenameValidation:this.enableFilenameValidation.checked,speakerId:this.speakerId.value,scriptsFolderUrl:this.scriptsFolderUrl.value};localStorage.setItem("audio-analyzer-filename-validation",JSON.stringify(e))}loadFilenameValidationSettings(){const e=localStorage.getItem("audio-analyzer-filename-validation");if(e)try{const t=JSON.parse(e);this.enableAudioAnalysis.checked=t.enableAudioAnalysis!==!1,this.enableFilenameValidation.checked=t.enableFilenameValidation||!1,this.speakerId.value=t.speakerId||"",this.scriptsFolderUrl.value=t.scriptsFolderUrl||"";const a=this.presetSelector.value,i=this.getPresetConfigurations()[a];this.enableFilenameValidation.checked&&i&&i.supportsFilenameValidation?this.filenameValidationFields.style.display="block":this.filenameValidationFields.style.display="none"}catch(t){console.error("Error loading filename validation settings:",t)}}toggleBoxFilenameValidationFields(){this.boxEnableFilenameValidation.checked?this.boxFilenameValidationFields.style.display="block":this.boxFilenameValidationFields.style.display="none",this.saveBoxFilenameValidationSettings()}validateBoxAnalysisTypeSelection(){!this.boxEnableAudioAnalysis.checked&&!this.boxEnableFilenameValidation.checked&&(this.boxEnableAudioAnalysis.checked=!0,alert("At least one analysis type must be selected")),this.saveBoxFilenameValidationSettings()}saveBoxFilenameValidationSettings(){const e={enableAudioAnalysis:this.boxEnableAudioAnalysis.checked,enableFilenameValidation:this.boxEnableFilenameValidation.checked,speakerId:this.boxSpeakerId.value,scriptsFolderUrl:this.boxScriptsFolderUrl.value};localStorage.setItem("audio-analyzer-box-filename-validation",JSON.stringify(e))}loadBoxFilenameValidationSettings(){const e=localStorage.getItem("audio-analyzer-box-filename-validation");if(e)try{const t=JSON.parse(e);this.boxEnableAudioAnalysis.checked=t.enableAudioAnalysis!==!1,this.boxEnableFilenameValidation.checked=t.enableFilenameValidation||!1,this.boxSpeakerId.value=t.speakerId||"",this.boxScriptsFolderUrl.value=t.scriptsFolderUrl||"",this.boxFilenameValidationFields.style.display="none",this.boxAnalysisTypeSection.style.display="none"}catch(t){console.error("Error loading Box filename validation settings:",t)}}switchTab(e){this.tabButtons.forEach(t=>t.classList.remove("active")),this.tabContents.forEach(t=>t.classList.remove("active")),document.querySelector(`[data-tab="${e}"]`).classList.add("active"),document.querySelectorAll(`.tab-content[data-tab="${e}"]`).forEach(t=>{t.classList.add("active")})}async handleFilesSelect(e){if(!(!e||e.length===0)){if(this.processingFile){console.log("Already processing files, ignoring duplicate call");return}e.length===1?(this.batchMode=!1,await this.handleFileSelect(e[0])):(this.batchMode=!0,await this.handleBatchFiles(e))}}async handleFileSelect(e){if(console.log("handleFileSelect called with:",e),!e){console.log("No file provided to handleFileSelect");return}if(this.processingFile){console.log("Already processing a file, ignoring duplicate call");return}this.processingFile=!0,console.log("Starting file processing..."),this.cleanupForNewFile(),this.currentFile=e,console.log("Showing loading screen..."),this.showLoading();try{console.log("Starting analysis with core engine...");const t=await this.engine.analyzeFile(e);console.log("Analysis results:",t),this.currentResults=t,console.log("Setting up audio player..."),this.setupAudioPlayer(e),console.log("Validating and displaying results..."),this.validateAndDisplayResults(t),this.showResults(),console.log("Results displayed successfully")}catch(t){console.error("Analysis error:",t),this.showError(`Failed to analyze file: ${t.message}`),this.cleanupForNewFile()}finally{this.processingFile=!1,console.log("File processing completed")}}async handleBatchFiles(e){this.processingFile=!0,this.batchCancelled=!1,this.cleanupForNewFile(),console.log(`Starting batch processing of ${e.length} files`),this.batchMode=!0,this.currentBatchSource="local",this.batchResults=[],this.showBatchProgress(0,e.length,"Initializing..."),this.initializeBatchResultsTable();try{const t=await this.batchProcessor.processBatch(e,()=>this.getCriteria(),a=>{this.showBatchProgress(a.current,a.total,a.currentFile)},a=>{this.batchResults.push(a),this.addBatchResultRow(a),this.updateBatchSummary()});this.batchResults=t,this.updateBatchSummary(),this.batchCancelled||(this.batchProgress.style.display="none")}catch(t){console.error("Batch processing error:",t),this.showError(`Failed to process batch: ${t.message}`),this.cleanupForNewFile()}finally{this.processingFile=!1}}async handleGoogleDriveUrl(){const e=this.driveUrl.value.trim();if(e){if(this.processingFile){console.log("Already processing a file, ignoring Google Drive request");return}this.processingFile=!0,this.cleanupForNewFile(),this.showLoading();try{const t=this.extractFileIdFromUrl(e);if(!t)throw new Error("Invalid Google Drive URL. Please ensure it's a valid Drive file or folder link.");this.updateAuthStatus(),t.isFolder?await this.handleGoogleDriveFolder(t.id):await this.handleGoogleDriveFile(t.id)}catch(t){console.error("Google Drive error:",t),this.cleanupForNewFile(),t.message.includes("sign-in")||t.message.includes("auth")?this.showError('Please sign in to Google to access Drive files. Click "Analyze" to authenticate.'):this.showError(`Failed to process Google Drive: ${t.message}`)}finally{this.processingFile=!1}}}async handleGoogleDriveFile(e){const t=await this.googleAuth.downloadFile(e);this.currentFile=t;const a=await this.engine.analyzeFile(t);this.currentResults=a,this.setupAudioPlayer(t),this.validateAndDisplayResults(a),this.showResults()}async fetchScriptFiles(e){try{const a=(await this.googleAuth.listFilesInFolder(e,".txt")).map(s=>s.name.trim().replace(/\.txt$/i,""));return console.log(`Found ${a.length} script files:`,a),a}catch(t){throw console.error("Error fetching script files:",t),new Error("Failed to fetch script files. Check the scripts folder URL.")}}validateFilename(e,t,a){const s=e.trim(),n=s.replace(/\.wav$/i,"").split(`_${a}`)[0],l=`${n}_${a}.wav`;return t.includes(n)?s===l?{status:"pass",expectedFormat:l,issue:""}:{status:"fail",expectedFormat:`${n}_${a}.wav`,issue:"Incorrect filename for existing script"}:{status:"fail",expectedFormat:"-",issue:"No matching script file found"}}async handleGoogleDriveFolder(e){const t=await this.googleAuth.listAudioFilesInFolder(e);if(t.length===0)throw new Error("No audio files found in this folder");console.log(`Found ${t.length} audio files in folder`);let a=[];if(this.enableFilenameValidation.checked){const n=this.scriptsFolderUrl.value.trim();if(!this.speakerId.value.trim())throw new Error("Speaker ID is required for filename validation");if(n){const r=this.extractFolderId(n);if(r)a=await this.fetchScriptFiles(r);else throw new Error("Invalid scripts folder URL")}else throw new Error("Scripts folder URL is required for filename validation")}this.batchMode=!0,this.currentBatchSource="drive",this.batchResults=[],this.batchCancelled=!1,this.scriptBaseNames=a,this.showBatchProgress(0,t.length,"Initializing..."),this.initializeBatchResultsTable();const s=3;let i=0;for(let n=0;n<t.length;n+=s){if(this.batchCancelled){console.log("Batch processing cancelled");break}const r=t.slice(n,n+s).map(async o=>{var d,u;if(this.batchCancelled)return null;try{let g,h=!1;const p=this.enableFilenameValidation.checked&&!this.enableAudioAnalysis.checked;if(p){const y=await this.googleAuth.getFileMetadata(o);console.log("Full metadata for",y.name,":",y),g={filename:y.name,fileSize:parseInt(y.size)||0,fileType:this.getFileTypeFromName(y.name),sampleRate:"Unknown",bitDepth:"Unknown",channels:"Unknown",duration:(d=y.videoMediaMetadata)!=null&&d.durationMillis?y.videoMediaMetadata.durationMillis/1e3:"Unknown"},h=!0}else{let k=null;for(let S=0;S<3;S++)try{const b=await this.googleAuth.downloadFileHeaders(o.id),I=parseInt(o.size)||b.size,w=new File([b],o.name,{type:o.mimeType,lastModified:new Date(o.modifiedTime).getTime()});Object.defineProperty(w,"size",{value:I,writable:!1}),g=await this.batchProcessor.analyzer.analyzeHeaders(w);break}catch(b){if(k=b,(b.message.includes("500")||b.message.includes("502")||b.message.includes("503")||b.message.includes("504"))&&S<2){const w=Math.min(1e3*Math.pow(2,S),5e3);console.log(`Retry ${S+1}/3 for ${o.name} after ${w}ms...`),await new Promise(B=>setTimeout(B,w))}else throw k}}(u=o.videoMediaMetadata)!=null&&u.durationMillis&&(g.duration=o.videoMediaMetadata.durationMillis/1e3);const m=A.validateResults(g,this.getCriteria(),p);let f=null;if(this.enableFilenameValidation.checked&&this.scriptBaseNames.length>0){const y=this.speakerId.value.trim();f=this.validateFilename(o.name,this.scriptBaseNames,y)}return{filename:o.name,file:null,driveFileId:o.id,analysis:g,validation:m,filenameValidation:f,status:this.getOverallStatus(m,p,f),warning:h?"Limited analysis (Google Drive error)":null}}catch(g){return console.error(`Error processing ${o.name}:`,g),{filename:o.name,file:null,driveFileId:o.id,analysis:null,validation:null,status:"error",error:g.message}}});(await Promise.all(r)).forEach(o=>{o&&(this.batchResults.push(o),this.addBatchResultRow(o),i++,this.batchCancelled||this.showBatchProgress(i,t.length,o.filename))}),this.updateBatchSummary()}this.batchCancelled||(this.batchProgress.style.display="none")}extractFileIdFromUrl(e){const t=[/\/file\/d\/([a-zA-Z0-9-_]+)/,/\/folders\/([a-zA-Z0-9-_]+)/,/[?&]id=([a-zA-Z0-9-_]+)/,/^([a-zA-Z0-9-_]+)$/];for(const a of t){const s=e.match(a);if(s)return{id:s[1],isFolder:a===t[1]}}return null}extractFolderId(e){const t=e.match(/[-\w]{25,}/);return t?t[0]:null}async handleBoxUrl(){const e=this.boxUrl.value.trim();if(e){if(this.processingFile){console.log("Already processing a file, ignoring Box request");return}this.processingFile=!0,this.cleanupForNewFile(),this.showLoading();try{const t=this.extractBoxIdFromUrl(e);if(!t)throw new Error("Invalid Box URL. Please ensure it's a valid Box file or folder link.");this.currentBoxSharedLink=e,this.updateBoxAuthStatus();const a=this.boxAuth.isSignedIn()?null:e;t.isFolder?await this.handleBoxFolder(t.id,a):await this.handleBoxFile(t.id,a)}catch(t){console.error("Box error:",t),this.cleanupForNewFile(),t.message.includes("sign-in")||t.message.includes("auth")||t.message.includes("Session expired")?this.currentBoxSharedLink?this.showError(`Failed to access Box file: ${t.message}. The file may not be publicly shared.`):this.showError('Please sign in to Box to access files. Click "Analyze" to authenticate.'):this.showError(`Failed to process Box: ${t.message}`)}finally{this.processingFile=!1,this.currentBoxSharedLink=null}}}async handleBoxFile(e,t=null){const a=await this.boxAuth.downloadFile(e,t);this.currentFile=a;const s=await this.engine.analyzeFile(a);this.currentResults=s,this.setupAudioPlayer(a),this.validateAndDisplayResults(s),this.showResults()}async handleBoxFolder(e,t=null){const a=await this.boxAuth.listAudioFilesInFolder(e,t);if(a.length===0)throw new Error("No audio files found in the Box folder");this.batchMode=!0,this.currentBatchSource="box",this.batchCancelled=!1,this.showBatchProgress();const s=this.boxAnalysisTypeSection.style.display!=="none",i=s&&this.boxEnableFilenameValidation.checked&&!this.boxEnableAudioAnalysis.checked;let n=null;if(s&&this.boxEnableFilenameValidation.checked){const l=this.boxSpeakerId.value,r=this.boxScriptsFolderUrl.value;if(!l||!r)throw new Error("Speaker ID and Scripts Folder URL are required for filename validation");const c=this.extractBoxFolderId(r);if(!c)throw new Error("Invalid scripts folder URL");n=await this.fetchBoxScriptFiles(c,r)}try{this.batchResults=[];let l=0,r=0,c=0,o=0,d=0;this.initializeBatchResultsTable();for(let u=0;u<a.length;u++){if(this.batchCancelled){console.log("Batch processing cancelled by user");break}const g=a[u];this.showBatchProgress(u+1,a.length,g.name);try{let h=null,p=null;if(s&&this.boxEnableFilenameValidation.checked){const S=this.boxSpeakerId.value;p=this.validateFilename(g.name,n,S)}if(!i){const S=await this.boxAuth.getFileMetadata(g,t),b=await this.boxAuth.downloadFileHeaders(g.id,102400,t),I=new File([b],g.name);h=await this.engine.analyzeFile(I),h&&h.duration&&(d+=h.duration)}const m=this.getCriteria(),f=h?this.engine.validateCriteria(h,m):{},y=this.getOverallStatus(f,i,p);y==="pass"?l++:y==="warning"?r++:y==="fail"&&c++;const k={name:g.name,filename:g.name,analysis:h,validation:f,filenameValidation:p,status:y,error:null};this.batchResults.push(k),this.addBatchResultRow(k)}catch(h){console.error(`Error processing ${g.name}:`,h),o++;const p={name:g.name,filename:g.name,analysis:null,validation:{},filenameValidation:null,status:"error",error:h.message};this.batchResults.push(p),this.addBatchResultRow(p)}}this.updateBatchSummary(l,r,c,o,d),this.batchCancelled||(this.batchProgress.style.display="none")}catch(l){console.error("Batch processing error:",l),this.showError(`Failed to process batch: ${l.message}`),this.cleanupForNewFile()}finally{this.processingFile=!1}}async fetchBoxScriptFiles(e,t=null){try{const s=(await this.boxAuth.listFilesInFolder(e,".txt",t)).map(i=>i.name.trim().replace(/\.txt$/i,""));return console.log(`Found ${s.length} Box script files:`,s),s}catch(a){throw console.error("Error fetching Box script files:",a),new Error("Failed to fetch script files. Check the scripts folder URL.")}}extractBoxIdFromUrl(e){const t=e.match(/\/s\/[^/]+\/file\/(\d+)/);if(t)return{id:t[1],isFolder:!1,sharedLink:e};const a=e.match(/\/s\/[^/]+\/folder\/(\d+)/);if(a)return{id:a[1],isFolder:!0,sharedLink:e};const s=[/\/file\/(\d+)/,/\/folder\/(\d+)/,/^(\d+)$/];for(const i of s){const n=e.match(i);if(n)return{id:n[1],isFolder:i===s[1],sharedLink:null}}return null}extractBoxFolderId(e){const t=e.match(/\/folder\/(\d+)/);return t?t[1]:null}setupAudioPlayer(e){const t=URL.createObjectURL(e);this.audioPlayer.src=t,this.audioPlayer.load(),this.playerSection.style.display="block"}togglePlayback(){this.audioPlayer.paused?(this.audioPlayer.play(),this.playPause.textContent="Pause"):(this.audioPlayer.pause(),this.playPause.textContent="Play")}validateAndDisplayResults(e){const t=this.getCriteria(),a=this.engine.validateCriteria(e,t),s=this.engine.formatResults(e);document.getElementById("fileName").textContent=this.currentFile.name,document.getElementById("fileType").textContent=s.fileType,document.getElementById("sampleRate").textContent=s.sampleRate,document.getElementById("bitDepth").textContent=s.bitDepth,document.getElementById("channels").textContent=s.channels,document.getElementById("duration").textContent=s.duration,document.getElementById("fileSize").textContent=s.fileSize,this.applyValidationStyling(a)}applyValidationStyling(e){const t={fileType:document.getElementById("fileTypeRow"),sampleRate:document.getElementById("sampleRateRow"),bitDepth:document.getElementById("bitDepthRow"),channels:document.getElementById("channelsRow"),duration:document.getElementById("durationRow")};Object.entries(e).forEach(([a,s])=>{const i=t[a];i&&(i.classList.remove("pass","fail","warning","unknown"),i.classList.add(s.status))})}async runAdvancedAnalysis(){if(!this.audioBuffer&&this.currentFile)try{const e=await this.currentFile.arrayBuffer(),t=new(window.AudioContext||window.webkitAudioContext);this.audioBuffer=await t.decodeAudioData(e)}catch(e){this.showError(`Failed to decode audio: ${e.message}`);return}if(!this.audioBuffer){this.showError("No audio data available for analysis");return}this.isAnalyzing=!0,this.advancedAnalysisBtn.style.display="none",this.advancedProgress.style.display="block";try{const e=await this.engine.analyzeAdvanced(this.audioBuffer,(t,a)=>{this.progressText.textContent=t,this.progressFill.style.width=`${a*100}%`});document.getElementById("peakLevel").textContent=e.peakDb===-1/0?"-∞ dB":`${e.peakDb.toFixed(1)} dB`,document.getElementById("noiseFloor").textContent=e.noiseFloorDb===-1/0?"-∞ dB":`${e.noiseFloorDb.toFixed(1)} dB`,document.getElementById("normalization").textContent=e.normalizationStatus.message,this.advancedResultsSection.style.display="block"}catch(e){e.message!=="Analysis cancelled"&&(console.error("Advanced analysis error:",e),this.showError(`Advanced analysis failed: ${e.message}`))}finally{this.isAnalyzing=!1,this.advancedProgress.style.display="none",this.advancedAnalysisBtn.style.display="block"}}cancelAdvancedAnalysis(){this.engine.cancelAdvancedAnalysis(),this.isAnalyzing=!1,this.advancedProgress.style.display="none",this.advancedAnalysisBtn.style.display="block"}cancelBatchProcessing(){this.batchCancelled=!0,this.batchProcessor.cancel(),this.batchProgress.style.display="none",this.batchProgressText.textContent="Processing cancelled"}showLoading(){this.hideAllSections(),this.loading.style.display="block"}showResults(){this.hideAllSections(),this.resultsSection.style.display="block"}showError(e){this.hideAllSections(),this.errorMessage.textContent=e,this.error.style.display="block"}showBatchProgress(e,t,a){this.batchProgress.style.display="block";const s=Math.round(e/t*100);this.batchProgressBar.style.width=`${s}%`,this.batchProgressText.textContent=`${e}/${t} (${s}%)`,this.batchCurrentFile.textContent=a||"Processing..."}initializeBatchResultsTable(){this.hideAllSections(),this.batchProgress.style.display="block",this.batchResultsSection.style.display="block",this.batchTableBody.innerHTML="";const e=this.getPresetConfigurations(),t=this.presetSelector.value,a=e[t],s=(a==null?void 0:a.supportsFilenameValidation)||!1,i=this.currentBatchSource==="box"?!1:this.currentBatchSource==="drive"?s&&this.enableFilenameValidation.checked:!1,n=this.currentBatchSource==="box"?this.boxEnableAudioAnalysis.checked:this.currentBatchSource==="drive"?this.enableAudioAnalysis.checked:!0,l=i&&!n,r=document.querySelector(".batch-results-table");r&&(l?r.classList.add("metadata-only"):r.classList.remove("metadata-only"));const c=document.getElementById("filenameCheckHeader");c&&(c.style.display=i?"":"none"),["sampleRateHeader","bitDepthHeader","channelsHeader","durationHeader"].forEach(d=>{const u=document.getElementById(d);u&&(u.style.display=l?"none":"")}),this.batchPassCount.textContent="0",this.batchWarningCount.textContent="0",this.batchFailCount.textContent="0",this.batchErrorCount.textContent="0",this.batchTotalDuration.textContent="0h 0m"}addBatchResultRow(e){const t=this.getPresetConfigurations(),a=this.presetSelector.value,s=t[a],i=(s==null?void 0:s.supportsFilenameValidation)||!1,n=this.currentBatchSource==="box"?!1:this.currentBatchSource==="drive"?i&&this.enableFilenameValidation.checked:!1,l=this.currentBatchSource==="box"?this.boxEnableAudioAnalysis.checked:this.currentBatchSource==="drive"?this.enableAudioAnalysis.checked:!0;if(e.analysis&&!e.error){const w=this.getCriteria(),B=n&&!l;e.validation=A.validateResults(e.analysis,w,B),B&&(e.validation.sampleRate&&(e.validation.sampleRate.status="unknown"),e.validation.bitDepth&&(e.validation.bitDepth.status="unknown"),e.validation.channels&&(e.validation.channels.status="unknown"),e.validation.duration&&(e.validation.duration.status="unknown")),e.status=this.getOverallStatus(e.validation,!1,e.filenameValidation)}const r=this.batchResults.length-1,c=document.createElement("tr");c.className=`batch-row ${e.status}`;const o=e.analysis?A.formatDisplayText(e.analysis):{},d=this.getValidationStatus(e.validation,"fileType"),u=this.getValidationStatus(e.validation,"sampleRate"),g=this.getValidationStatus(e.validation,"bitDepth"),h=this.getValidationStatus(e.validation,"channels"),p=this.getValidationStatus(e.validation,"duration"),m=n&&!l;let f="";if(n)if(e.filenameValidation){const w=e.filenameValidation.status==="pass"?"✅":"❌",B=e.filenameValidation.issue||e.filenameValidation.expectedFormat;f=`<td class="filename-check-${e.filenameValidation.status}" title="${B}">${w}</td>`}else f='<td style="display: none;"></td>';else f='<td style="display: none;"></td>';const y=m?"":`<td class="validation-${u}">${o.sampleRate||"-"}</td>`,k=m?"":`<td class="validation-${g}">${o.bitDepth||"-"}</td>`,S=m?"":`<td class="validation-${h}">${o.channels||"-"}</td>`,b=m?"":`<td class="validation-${p}">${o.duration||"-"}</td>`,I=e.file||e.driveFileId?`<button class="play-btn-small" data-index="${r}">▶</button>`:"-";if(c.innerHTML=`
      <td class="filename">${e.filename}</td>
      <td><span class="status-badge ${e.status}">${e.status}</span></td>
      ${f}
      <td class="validation-${d}">${o.fileType||"Unknown"}</td>
      ${y}
      ${k}
      ${S}
      ${b}
      <td>${o.fileSize||"-"}</td>
      <td>${I}</td>
    `,this.batchTableBody.appendChild(c),e.file||e.driveFileId){const w=c.querySelector(".play-btn-small");w&&w.addEventListener("click",B=>{const v=parseInt(B.target.dataset.index);this.playBatchFile(v)})}}updateBatchSummary(){const e=this.batchResults.filter(n=>n.status==="pass").length,t=this.batchResults.filter(n=>n.status==="warning").length,a=this.batchResults.filter(n=>n.status==="fail").length,s=this.batchResults.filter(n=>n.status==="error").length;this.batchPassCount.textContent=e,this.batchWarningCount.textContent=t,this.batchFailCount.textContent=a,this.batchErrorCount.textContent=s;const i=this.batchResults.filter(n=>n.status==="pass").reduce((n,l)=>{var c;const r=(c=l.analysis)==null?void 0:c.duration;return typeof r=="number"&&!isNaN(r)?n+r:n},0);this.batchTotalDuration.textContent=this.formatTotalDuration(i)}showBatchResults(e){this.hideAllSections(),this.batchResultsSection.style.display="block";const t=e.filter(h=>h.status==="pass").length,a=e.filter(h=>h.status==="warning").length,s=e.filter(h=>h.status==="fail").length,i=e.filter(h=>h.status==="error").length;this.batchPassCount.textContent=t,this.batchWarningCount.textContent=a,this.batchFailCount.textContent=s,this.batchErrorCount.textContent=i;const n=e.filter(h=>h.status==="pass").reduce((h,p)=>{var f;const m=(f=p.analysis)==null?void 0:f.duration;return typeof m=="number"&&!isNaN(m)?h+m:h},0);this.batchTotalDuration.textContent=this.formatTotalDuration(n);const l=this.getPresetConfigurations(),r=this.presetSelector.value,c=l[r],o=(c==null?void 0:c.supportsFilenameValidation)||!1,d=this.currentBatchSource==="box"?!1:this.currentBatchSource==="drive"?o&&this.enableFilenameValidation.checked:!1,u=this.currentBatchSource==="box"?this.boxEnableAudioAnalysis.checked:this.currentBatchSource==="drive"?this.enableAudioAnalysis.checked:!0,g=d&&!u;this.batchTableBody.innerHTML="",e.forEach((h,p)=>{const m=document.createElement("tr");m.className=`batch-row ${h.status}`;const f=h.analysis?A.formatDisplayText(h.analysis):{},y=this.getValidationStatus(h.validation,"fileType"),k=this.getValidationStatus(h.validation,"sampleRate"),S=this.getValidationStatus(h.validation,"bitDepth"),b=this.getValidationStatus(h.validation,"channels"),I=this.getValidationStatus(h.validation,"duration");let w="";if(d)if(h.filenameValidation){const D=h.filenameValidation.status==="pass"?"✅":"❌",U=h.filenameValidation.issue||h.filenameValidation.expectedFormat;w=`<td class="filename-check-${h.filenameValidation.status}" title="${U}">${D}</td>`}else w='<td style="display: none;"></td>';else w='<td style="display: none;"></td>';const B=g?"":`<td class="validation-${k}">${f.sampleRate||"-"}</td>`,v=g?"":`<td class="validation-${S}">${f.bitDepth||"-"}</td>`,R=g?"":`<td class="validation-${b}">${f.channels||"-"}</td>`,$=g?"":`<td class="validation-${I}">${f.duration||"-"}</td>`;m.innerHTML=`
        <td class="filename">${h.filename}</td>
        <td><span class="status-badge ${h.status}">${h.status}</span></td>
        ${w}
        <td class="validation-${y}">${f.fileType||"Unknown"}</td>
        ${B}
        ${v}
        ${R}
        ${$}
        <td>${f.fileSize||"-"}</td>
        <td><button class="play-btn-small" data-index="${p}">▶</button></td>
      `,this.batchTableBody.appendChild(m)}),this.batchResults=e,this.batchTableBody.querySelectorAll(".play-btn-small").forEach(h=>{h.addEventListener("click",p=>{const m=parseInt(p.target.dataset.index);this.playBatchFile(m)})})}formatValue(e){return e==null||e==="Unknown"?"-":e}formatDuration(e){if(!e||e==="Unknown")return"-";const t=Math.floor(e/60),a=Math.floor(e%60);return`${t}:${a.toString().padStart(2,"0")}`}formatTotalDuration(e){if(!e||e===0)return"0h 0m 0s";const t=Math.floor(e/3600),a=Math.floor(e%3600/60),s=Math.floor(e%60);return t>0?`${t}h ${a}m ${s}s`:a>0?`${a}m ${s}s`:`${s}s`}getValidationStatus(e,t){return!e||!e[t]?"":e[t].status}playBatchFile(e){if(!this.batchResults||!this.batchResults[e])return;const t=this.batchResults[e];if(t.file){const a=URL.createObjectURL(t.file);window.open(a,"_blank"),setTimeout(()=>URL.revokeObjectURL(a),1e3)}else if(t.driveFileId){const a=`https://drive.google.com/file/d/${t.driveFileId}/view`;window.open(a,"_blank")}}revalidateBatchResults(){if(!this.batchResults)return;const e=this.getCriteria(),t=this.getPresetConfigurations(),a=this.presetSelector.value,s=t[a],i=(s==null?void 0:s.supportsFilenameValidation)||!1,n=this.currentBatchSource==="box"?!1:this.currentBatchSource==="drive"?i&&this.enableFilenameValidation.checked:!1,l=this.currentBatchSource==="box"?this.boxEnableAudioAnalysis.checked:this.currentBatchSource==="drive"?this.enableAudioAnalysis.checked:!0,r=n&&!l,c=document.getElementById("filenameCheckHeader");c&&(c.style.display=n?"":"none"),["sampleRateHeader","bitDepthHeader","channelsHeader","durationHeader"].forEach(d=>{const u=document.getElementById(d);u&&(u.style.display=r?"none":"")}),this.batchResults.forEach(d=>{d.analysis&&(d.validation=A.validateResults(d.analysis,e),d.status=this.getOverallStatus(d.validation,!1,d.filenameValidation))}),this.showBatchResults(this.batchResults)}getOverallStatus(e,t=!1,a=null){let s=Object.values(e).map(i=>i.status);if(t){const i=["sampleRate","bitDepth","channels"];s=Object.entries(e).filter(([n])=>!i.includes(n)).map(([,n])=>n.status)}return a&&a.status&&s.push(a.status),s.includes("fail")?"fail":s.includes("warning")?"warning":"pass"}getFileTypeFromName(e){const t=e.split(".").pop().toLowerCase();return{wav:"WAV",mp3:"MP3",flac:"FLAC",aac:"AAC",m4a:"M4A",ogg:"OGG"}[t]||t.toUpperCase()}cleanupForNewFile(){this.currentFile&&(this.currentFile=null),this.audioBuffer&&(this.audioBuffer=null),this.currentResults&&(this.currentResults=null),this.audioPlayer&&this.audioPlayer.src&&(this.audioPlayer.src.startsWith("blob:")&&URL.revokeObjectURL(this.audioPlayer.src),this.audioPlayer.src="")}cleanup(){this.cleanupForNewFile(),this.engine.audioAnalyzer.audioContext,window.gc&&typeof window.gc=="function"&&window.gc()}hideAllSections(){this.loading.style.display="none",this.error.style.display="none",this.resultsSection.style.display="none",this.advancedResultsSection.style.display="none",this.batchProgress.style.display="none",this.batchResultsSection.style.display="none"}}document.addEventListener("DOMContentLoaded",()=>{const F=new H;window.addEventListener("beforeunload",()=>{F.cleanup()}),document.addEventListener("visibilitychange",()=>{document.hidden&&F.cleanup()})});
