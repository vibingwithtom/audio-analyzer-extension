import{B as M,C,A as z,L as H}from"./audio-analyzer-core-CyHy_61s.js";import{G as _}from"./google-auth-BlgHu3aB.js";import{B as W}from"./box-auth-CGWq9zhz.js";import{b as R}from"./validation-data-BoStb5ov.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const l of a)if(l.type==="childList")for(const s of l.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function t(a){const l={};return a.integrity&&(l.integrity=a.integrity),a.referrerPolicy&&(l.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?l.credentials="include":a.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(a){if(a.ep)return;a.ep=!0;const l=t(a);fetch(a.href,l)}})();class G{constructor(){this.audioAnalyzer=new z,this.levelAnalyzer=new H}async analyzeFile(e){return await this.audioAnalyzer.analyzeFile(e)}async analyzeAdvanced(e,t){return await this.levelAnalyzer.analyzeAudioBuffer(e,t)}analyzeStereoSeparation(e){return this.levelAnalyzer.analyzeStereoSeparation(e)}validateCriteria(e,t){return C.validateResults(e,t)}formatResults(e){return C.formatDisplayText(e)}formatAdvancedResults(e){return C.formatAdvancedResults(e)}cancelAdvancedAnalysis(){this.levelAnalyzer.cancelAnalysis()}}function N(T){const e=document.createElement("div");return e.textContent=T,e.innerHTML}class q{constructor(){this.engine=new G,this.googleAuth=new _,this.boxAuth=new W,this.batchProcessor=new M(C),this.currentFile=null,this.audioBuffer=null,this.isAnalyzing=!1,this.currentResults=null,this.processingFile=!1,this.batchMode=!1,this.batchResults=null,this.batchCancelled=!1,this.currentBatchSource=null,this.initializeElements(),this.attachEventListeners(),this.loadSettings(),this.initializeDarkMode(),this.updateBuildInfo()}initializeElements(){this.tabButtons=document.querySelectorAll(".tab-button"),this.tabContents=document.querySelectorAll(".tab-content"),this.darkModeToggle=document.getElementById("darkModeToggle"),this.dropZone=document.getElementById("dropZone"),this.browseBtn=document.getElementById("browseBtn"),this.fileInput=document.getElementById("fileInput"),this.driveUrl=document.getElementById("driveUrl"),this.analyzeUrl=document.getElementById("analyzeUrl"),this.authText=document.getElementById("authText"),this.signInBtn=document.getElementById("signInBtn"),this.signOutBtn=document.getElementById("signOutBtn"),this.boxUrl=document.getElementById("boxUrl"),this.analyzeBoxUrl=document.getElementById("analyzeBoxUrl"),this.boxAuthText=document.getElementById("boxAuthText"),this.boxSignInBtn=document.getElementById("boxSignInBtn"),this.boxSignOutBtn=document.getElementById("boxSignOutBtn"),this.analysisTypeSection=document.getElementById("analysisTypeSection"),this.enableAudioAnalysis=document.getElementById("enableAudioAnalysis"),this.enableFilenameValidation=document.getElementById("enableFilenameValidation"),this.filenameValidationFields=document.getElementById("filenameValidationFields"),this.speakerId=document.getElementById("speakerId"),this.scriptsFolderUrl=document.getElementById("scriptsFolderUrl"),this.boxAnalysisTypeSection=document.getElementById("boxAnalysisTypeSection"),this.boxEnableAudioAnalysis=document.getElementById("boxEnableAudioAnalysis"),this.boxEnableFilenameValidation=document.getElementById("boxEnableFilenameValidation"),this.boxFilenameValidationFields=document.getElementById("boxFilenameValidationFields"),this.localAnalysisTypeSection=document.getElementById("localAnalysisTypeSection"),this.localEnableAudioAnalysis=document.getElementById("localEnableAudioAnalysis"),this.localEnableFilenameValidation=document.getElementById("localEnableFilenameValidation"),this.localFilenameValidationFields=document.getElementById("localFilenameValidationFields"),this.presetSelector=document.getElementById("presetSelector"),this.targetFileType=document.getElementById("targetFileType"),this.targetSampleRate=document.getElementById("targetSampleRate"),this.targetBitDepth=document.getElementById("targetBitDepth"),this.targetChannels=document.getElementById("targetChannels"),this.targetMinDuration=document.getElementById("targetMinDuration"),this.playerSection=document.getElementById("playerSection"),this.resultsSection=document.getElementById("resultsSection"),this.advancedResultsSection=document.getElementById("advancedResultsSection"),this.audioPlayer=document.getElementById("audioPlayer"),this.playPause=document.getElementById("playPause"),this.advancedAnalysisBtn=document.getElementById("advancedAnalysisBtn"),this.advancedProgress=document.getElementById("advancedProgress"),this.progressFill=document.getElementById("progressFill"),this.progressText=document.getElementById("progressText"),this.cancelAnalysis=document.getElementById("cancelAnalysis"),this.loading=document.getElementById("loading"),this.error=document.getElementById("error"),this.errorMessage=document.getElementById("errorMessage"),this.batchProgress=document.getElementById("batchProgress"),this.batchCurrentFile=document.getElementById("batchCurrentFile"),this.batchProgressText=document.getElementById("batchProgressText"),this.batchProgressBar=document.getElementById("batchProgressBar"),this.cancelBatch=document.getElementById("cancelBatch"),this.batchResultsSection=document.getElementById("batchResultsSection"),this.batchPassCount=document.getElementById("batchPassCount"),this.batchWarningCount=document.getElementById("batchWarningCount"),this.batchFailCount=document.getElementById("batchFailCount"),this.batchErrorCount=document.getElementById("batchErrorCount"),this.batchTotalDuration=document.getElementById("batchTotalDuration"),this.batchTotalDurationContainer=document.querySelector(".total-duration"),this.batchTableBody=document.getElementById("batchTableBody")}attachEventListeners(){this.darkModeToggle.addEventListener("click",()=>this.toggleDarkMode()),this.tabButtons.forEach(e=>{e.addEventListener("click",()=>this.switchTab(e.dataset.tab))}),this.browseBtn.addEventListener("click",e=>{e.stopPropagation(),this.fileInput.value="",this.fileInput.click()}),this.fileInput.addEventListener("change",e=>{const t=Array.from(e.target.files||[]);t.length>0&&this.handleFilesSelect(t)}),this.dropZone.addEventListener("dragover",e=>{e.preventDefault(),this.dropZone.classList.add("drag-over")}),this.dropZone.addEventListener("dragleave",()=>{this.dropZone.classList.remove("drag-over")}),this.dropZone.addEventListener("drop",e=>{e.preventDefault(),this.dropZone.classList.remove("drag-over");const t=Array.from(e.dataTransfer.files||[]).filter(i=>i.type.startsWith("audio/"));t.length>0&&this.handleFilesSelect(t)}),this.dropZone.addEventListener("click",()=>this.fileInput.click()),this.analyzeUrl.addEventListener("click",()=>this.handleGoogleDriveUrl()),this.driveUrl.addEventListener("keypress",e=>{e.key==="Enter"&&this.handleGoogleDriveUrl()}),this.signInBtn.addEventListener("click",()=>this.handleSignIn()),this.signOutBtn.addEventListener("click",()=>this.handleSignOut()),this.analyzeBoxUrl.addEventListener("click",()=>this.handleBoxUrl()),this.boxUrl.addEventListener("keypress",e=>{e.key==="Enter"&&this.handleBoxUrl()}),this.boxSignInBtn.addEventListener("click",()=>this.handleBoxSignIn()),this.boxSignOutBtn.addEventListener("click",()=>this.handleBoxSignOut()),this.presetSelector.addEventListener("change",()=>this.handlePresetChange()),this.enableFilenameValidation.addEventListener("change",()=>this.toggleFilenameValidationFields()),this.enableAudioAnalysis.addEventListener("change",()=>this.validateAnalysisTypeSelection()),this.speakerId.addEventListener("input",()=>this.saveFilenameValidationSettings()),this.scriptsFolderUrl.addEventListener("input",()=>this.saveFilenameValidationSettings()),this.boxEnableFilenameValidation.addEventListener("change",()=>this.toggleBoxFilenameValidationFields()),this.boxEnableAudioAnalysis.addEventListener("change",()=>this.validateBoxAnalysisTypeSelection()),this.localEnableFilenameValidation.addEventListener("change",()=>this.toggleLocalFilenameValidationFields()),this.localEnableAudioAnalysis.addEventListener("change",()=>this.validateLocalAnalysisTypeSelection()),[this.targetFileType,this.targetSampleRate,this.targetBitDepth,this.targetChannels].forEach(e=>{e.addEventListener("change",()=>this.saveCriteria())}),this.targetMinDuration.addEventListener("input",()=>this.saveCriteria()),this.playPause.addEventListener("click",()=>this.togglePlayback()),this.audioPlayer.addEventListener("loadedmetadata",()=>{this.playPause.textContent="Play"}),this.advancedAnalysisBtn.addEventListener("click",()=>this.runAdvancedAnalysis()),this.cancelAnalysis.addEventListener("click",()=>this.cancelAdvancedAnalysis()),this.cancelBatch.addEventListener("click",()=>this.cancelBatchProcessing())}loadSettings(){const e=localStorage.getItem("audio-analyzer-settings");if(e)try{const i=JSON.parse(e);if(i.criteria){const a=(l,s)=>{Array.from(l.options).forEach(c=>{c.selected=!1}),(Array.isArray(s)?s:s?[s]:[]).forEach(c=>{const o=Array.from(l.options).find(d=>d.value===c);o&&(o.selected=!0)})};a(this.targetFileType,i.criteria.fileType||[]),a(this.targetSampleRate,i.criteria.sampleRate||[]),a(this.targetBitDepth,i.criteria.bitDepth||[]),a(this.targetChannels,i.criteria.channels||[]),this.targetMinDuration.value=i.criteria.minDuration||""}}catch(i){console.warn("Failed to load settings from localStorage:",i)}const t=localStorage.getItem("audio-analyzer-selected-preset");t?(this.presetSelector.value=t,this.handlePresetChange()):(this.presetSelector.value="auditions-character-recordings",this.handlePresetChange()),this.loadFilenameValidationSettings(),this.loadBoxFilenameValidationSettings(),this.loadLocalFilenameValidationSettings(),this.googleAuth.init().catch(i=>console.error("Google Auth init error:",i)),this.updateAuthStatus(),this.boxAuth.init().then(()=>{this.updateBoxAuthStatus(),localStorage.getItem("box_just_authenticated")==="true"&&(localStorage.removeItem("box_just_authenticated"),this.switchTab("box"))}).catch(i=>console.error("Box Auth init error:",i))}updateAuthStatus(){const e=this.googleAuth.isSignedIn();if(console.log("updateAuthStatus called, isSignedIn:",e),console.log("signInBtn element:",this.signInBtn),e){const t=this.googleAuth.getUserInfo();t&&t.name?this.authText.textContent=`✓ Signed in as ${t.name}`:this.authText.textContent="✓ Signed in to Google Drive",this.signInBtn.style.display="none",this.signOutBtn.style.display="inline-block"}else this.authText.textContent="Not signed in to Google",this.signInBtn.style.display="inline-block",this.signOutBtn.style.display="none",console.log("Set signInBtn display to inline-block")}async handleSignIn(){try{await this.googleAuth.signIn(),this.updateAuthStatus()}catch(e){console.error("Sign-in failed:",e),this.showError(`Google sign-in failed: ${e.message}`)}}handleSignOut(){this.googleAuth.signOut(),this.updateAuthStatus()}updateBoxAuthStatus(){if(this.boxAuth.isSignedIn()){const t=this.boxAuth.userInfo;t&&t.name?this.boxAuthText.textContent=`✓ Signed in as ${t.name}`:this.boxAuthText.textContent="✓ Signed in to Box",this.boxSignInBtn.style.display="none",this.boxSignOutBtn.style.display="inline-block"}else this.boxAuthText.textContent="Not signed in to Box",this.boxSignInBtn.style.display="inline-block",this.boxSignOutBtn.style.display="none"}async handleBoxSignIn(){try{await this.boxAuth.signIn(),this.updateBoxAuthStatus()}catch(e){console.error("Box sign-in failed:",e),this.showError(`Box sign-in failed: ${e.message}`)}}handleBoxSignOut(){this.boxAuth.signOut(),this.updateBoxAuthStatus()}getCriteria(){const e=i=>Array.from(i.selectedOptions).map(a=>a.value);return{fileType:e(this.targetFileType),sampleRate:e(this.targetSampleRate),bitDepth:e(this.targetBitDepth),channels:e(this.targetChannels),minDuration:this.targetMinDuration.value||""}}saveCriteria(){const t={criteria:this.getCriteria()};localStorage.setItem("audio-analyzer-settings",JSON.stringify(t)),this.currentResults&&this.validateAndDisplayResults(this.currentResults),this.batchResults&&this.batchMode&&this.revalidateBatchResults()}getPresetConfigurations(){return{"auditions-character-recordings":{name:"Auditions: Character Recordings",fileType:["wav"],sampleRate:["48000"],bitDepth:["24"],channels:["1"],minDuration:"120"},"auditions-emotional-voice":{name:"Auditions: Emotional Voice",fileType:["wav"],sampleRate:["48000"],bitDepth:["16","24"],channels:["1","2"],minDuration:"30"},"character-recordings":{name:"Character Recordings",fileType:["wav"],sampleRate:["48000"],bitDepth:["24"],channels:["1"],minDuration:""},"p2b2-pairs-mono":{name:"P2B2 Pairs (Mono)",fileType:["wav"],sampleRate:["44100","48000"],bitDepth:["16","24"],channels:["1"],minDuration:""},"p2b2-pairs-stereo":{name:"P2B2 Pairs (Stereo)",fileType:["wav"],sampleRate:["44100","48000"],bitDepth:["16","24"],channels:["2"],minDuration:""},"p2b2-pairs-mixed":{name:"P2B2 Pairs (Mixed)",fileType:["wav"],sampleRate:["44100","48000"],bitDepth:["16","24"],channels:["1","2"],minDuration:""},"three-hour":{name:"Three Hour",fileType:["wav"],sampleRate:["48000"],bitDepth:["24"],channels:["1"],minDuration:"",supportsFilenameValidation:!0,filenameValidationType:"script-match",gdriveOnly:!0},"bilingual-conversational":{name:"Bilingual Conversational",fileType:["wav"],sampleRate:["48000"],bitDepth:["16","24"],channels:["2"],minDuration:"",supportsFilenameValidation:!0,filenameValidationType:"bilingual-pattern"},custom:{name:"Custom"}}}handlePresetChange(){const e=this.presetSelector.value,t=document.getElementById("customCriteriaSection");if(e){if(e==="custom")t.style.display="block";else{t.style.display="none";const a=this.getPresetConfigurations()[e];if(a){const l=(s,r)=>{Array.from(s.options).forEach(o=>{o.selected=!1}),(Array.isArray(r)?r:r?[r]:[]).forEach(o=>{const d=Array.from(s.options).find(h=>h.value===o);d&&(d.selected=!0)})};l(this.targetFileType,a.fileType||[]),l(this.targetSampleRate,a.sampleRate||[]),l(this.targetBitDepth,a.bitDepth||[]),l(this.targetChannels,a.channels||[]),this.targetMinDuration.value=a.minDuration||"",this.saveCriteria(),this.currentResults&&this.validateAndDisplayResults(this.currentResults),this.batchResults&&this.batchMode&&this.revalidateBatchResults(),this.updateValidationSectionsVisibility()}}localStorage.setItem("audio-analyzer-selected-preset",e)}}toggleFilenameValidationFields(){this.enableFilenameValidation.checked?this.filenameValidationFields.style.display="block":this.filenameValidationFields.style.display="none",this.saveFilenameValidationSettings()}validateAnalysisTypeSelection(){!this.enableAudioAnalysis.checked&&!this.enableFilenameValidation.checked&&(this.enableAudioAnalysis.checked=!0,alert("At least one analysis type must be selected")),this.saveFilenameValidationSettings()}saveFilenameValidationSettings(){const e={enableAudioAnalysis:this.enableAudioAnalysis.checked,enableFilenameValidation:this.enableFilenameValidation.checked,speakerId:this.speakerId.value,scriptsFolderUrl:this.scriptsFolderUrl.value};localStorage.setItem("audio-analyzer-filename-validation",JSON.stringify(e))}loadFilenameValidationSettings(){const e=localStorage.getItem("audio-analyzer-filename-validation");if(e)try{const t=JSON.parse(e);this.enableAudioAnalysis.checked=t.enableAudioAnalysis!==!1,this.enableFilenameValidation.checked=t.enableFilenameValidation||!1,this.speakerId.value=t.speakerId||"",this.scriptsFolderUrl.value=t.scriptsFolderUrl||"";const i=this.presetSelector.value,l=this.getPresetConfigurations()[i];this.enableFilenameValidation.checked&&l&&l.supportsFilenameValidation?this.filenameValidationFields.style.display="block":this.filenameValidationFields.style.display="none"}catch(t){console.error("Error loading filename validation settings:",t)}}toggleBoxFilenameValidationFields(){this.boxEnableFilenameValidation.checked?this.boxFilenameValidationFields.style.display="block":this.boxFilenameValidationFields.style.display="none",this.saveBoxFilenameValidationSettings()}validateBoxAnalysisTypeSelection(){!this.boxEnableAudioAnalysis.checked&&!this.boxEnableFilenameValidation.checked&&(this.boxEnableAudioAnalysis.checked=!0,alert("At least one analysis type must be selected")),this.saveBoxFilenameValidationSettings()}saveBoxFilenameValidationSettings(){const e={enableAudioAnalysis:this.boxEnableAudioAnalysis.checked,enableFilenameValidation:this.boxEnableFilenameValidation.checked};localStorage.setItem("audio-analyzer-box-filename-validation",JSON.stringify(e))}loadBoxFilenameValidationSettings(){const e=localStorage.getItem("audio-analyzer-box-filename-validation");if(e)try{const t=JSON.parse(e);this.boxEnableAudioAnalysis.checked=t.enableAudioAnalysis!==!1,this.boxEnableFilenameValidation.checked=t.enableFilenameValidation||!1}catch(t){console.error("Error loading Box filename validation settings:",t)}}toggleLocalFilenameValidationFields(){if(this.localEnableFilenameValidation.checked){const e=this.getPresetConfigurations(),t=this.presetSelector.value,i=e[t];(i==null?void 0:i.filenameValidationType)==="bilingual-pattern"?this.localFilenameValidationFields.style.display="block":this.localFilenameValidationFields.style.display="none"}else this.localFilenameValidationFields.style.display="none";this.saveLocalFilenameValidationSettings()}validateLocalAnalysisTypeSelection(){!this.localEnableAudioAnalysis.checked&&!this.localEnableFilenameValidation.checked&&(this.localEnableAudioAnalysis.checked=!0,alert("At least one analysis type must be selected")),this.saveLocalFilenameValidationSettings()}saveLocalFilenameValidationSettings(){const e={enableAudioAnalysis:this.localEnableAudioAnalysis.checked,enableFilenameValidation:this.localEnableFilenameValidation.checked};localStorage.setItem("audio-analyzer-local-filename-validation",JSON.stringify(e))}loadLocalFilenameValidationSettings(){const e=localStorage.getItem("audio-analyzer-local-filename-validation");if(e)try{const t=JSON.parse(e);this.localEnableAudioAnalysis.checked=t.enableAudioAnalysis!==!1,this.localEnableFilenameValidation.checked=t.enableFilenameValidation||!1}catch(t){console.error("Error loading local filename validation settings:",t)}}switchTab(e){this.tabButtons.forEach(t=>t.classList.remove("active")),this.tabContents.forEach(t=>t.classList.remove("active")),document.querySelector(`[data-tab="${e}"]`).classList.add("active"),document.querySelectorAll(`.tab-content[data-tab="${e}"]`).forEach(t=>{t.classList.add("active")}),this.cleanupForNewFile(),this.hideAllSections(),this.updateValidationSectionsVisibility()}toggleDarkMode(){const e=document.documentElement;e.classList.contains("dark-mode")?(e.classList.remove("dark-mode"),localStorage.setItem("darkMode","false")):(e.classList.add("dark-mode"),localStorage.setItem("darkMode","true"))}initializeDarkMode(){const e=localStorage.getItem("darkMode");e!==null?e==="true"&&document.documentElement.classList.add("dark-mode"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.documentElement.classList.add("dark-mode")}updateBuildInfo(){const e=document.getElementById("buildInfo");if(e){const t=new Date,i=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0"),s=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0"),c=`${i}.${a}.${l}-${s}${r}`;e.textContent=`Audio Analyzer build-${c}`}}updateValidationSectionsVisibility(){const e=document.querySelector(".tab-button.active"),t=e?e.dataset.tab:"local",i=this.getPresetConfigurations(),a=this.presetSelector.value,l=i[a];if(!l)return;const s=l.filenameValidationType;if(t==="gdrive"&&l.supportsFilenameValidation)if(this.analysisTypeSection.style.display="block",this.enableFilenameValidation.checked){this.filenameValidationFields.style.display="block";const r=document.getElementById("driveThreeHourFields"),c=document.getElementById("driveBilingualFields");s==="script-match"?(r&&(r.style.display="block"),c&&(c.style.display="none")):s==="bilingual-pattern"?(r&&(r.style.display="none"),c&&(c.style.display="block")):(r&&(r.style.display="none"),c&&(c.style.display="none"))}else this.filenameValidationFields.style.display="none";else this.analysisTypeSection.style.display="none",this.filenameValidationFields.style.display="none";t==="box"&&l.supportsFilenameValidation&&!l.gdriveOnly?(this.boxAnalysisTypeSection.style.display="block",this.boxEnableFilenameValidation.checked?s==="bilingual-pattern"?this.boxFilenameValidationFields.style.display="block":this.boxFilenameValidationFields.style.display="none":this.boxFilenameValidationFields.style.display="none"):(this.boxAnalysisTypeSection.style.display="none",this.boxFilenameValidationFields.style.display="none"),t==="local"&&l.supportsFilenameValidation&&!l.gdriveOnly?(this.localAnalysisTypeSection.style.display="block",this.localEnableFilenameValidation.checked?s==="bilingual-pattern"?this.localFilenameValidationFields.style.display="block":this.localFilenameValidationFields.style.display="none":this.localFilenameValidationFields.style.display="none"):(this.localAnalysisTypeSection.style.display="none",this.localFilenameValidationFields.style.display="none")}async handleFilesSelect(e){if(!(!e||e.length===0)){if(this.processingFile){console.log("Already processing files, ignoring duplicate call");return}e.length===1?(this.batchMode=!1,await this.handleFileSelect(e[0])):(this.batchMode=!0,await this.handleBatchFiles(e))}}async handleFileSelect(e){if(console.log("handleFileSelect called with:",e),!e){console.log("No file provided to handleFileSelect");return}if(this.processingFile){console.log("Already processing a file, ignoring duplicate call");return}this.processingFile=!0,console.log("Starting file processing..."),this.cleanupForNewFile(),this.currentFile=e,console.log("Showing loading screen..."),this.showLoading();try{console.log("Starting analysis with core engine...");const t=await this.engine.analyzeFile(e);console.log("Analysis results:",t),this.currentResults=t,console.log("Setting up audio player..."),this.setupAudioPlayer(e),console.log("Validating and displaying results..."),this.validateAndDisplayResults(t),this.showResults(),console.log("Results displayed successfully")}catch(t){console.error("Analysis error:",t),this.showError(`Failed to analyze file: ${t.message}`),this.cleanupForNewFile()}finally{this.processingFile=!1,console.log("File processing completed")}}async handleBatchFiles(e){this.processingFile=!0,this.batchCancelled=!1,this.cleanupForNewFile(),console.log(`Starting batch processing of ${e.length} files`),this.batchMode=!0,this.currentBatchSource="local",this.batchResults=[],this.showBatchProgress(0,e.length,"Initializing..."),this.initializeBatchResultsTable();try{const t=await this.batchProcessor.processBatch(e,()=>this.getCriteria(),i=>{this.showBatchProgress(i.current,i.total,i.currentFile)},i=>{if(this.localEnableFilenameValidation&&this.localEnableFilenameValidation.checked){const a=this.getPresetConfigurations(),l=this.presetSelector.value,s=a[l],r=s==null?void 0:s.filenameValidationType;if(r==="bilingual-pattern"&&(i.filenameValidation=this.validateBilingualFilename(i.filename),i.status=this.getOverallStatus(i.validation,!1,i.filenameValidation)),r==="bilingual-pattern"&&i.analysis&&i.analysis.duration&&i.filename.replace(/\.\w+$/i,"").startsWith("SPONTANEOUS")){const o=i.analysis.duration;o>600&&(i.validation||(i.validation={}),i.validation.duration={status:"warning",issue:`SPONTANEOUS recordings must be ≤10 minutes (current: ${Math.round(o/60)} min)`},i.status=this.getOverallStatus(i.validation,!1,i.filenameValidation))}}this.batchResults.push(i),this.addBatchResultRow(i),this.updateBatchSummary()});this.batchResults=t,this.updateBatchSummary(),this.batchCancelled||(this.batchProgress.style.display="none")}catch(t){console.error("Batch processing error:",t),this.showError(`Failed to process batch: ${t.message}`),this.cleanupForNewFile()}finally{this.processingFile=!1}}async handleGoogleDriveUrl(){const e=this.driveUrl.value.trim();if(e){if(this.processingFile){console.log("Already processing a file, ignoring Google Drive request");return}this.processingFile=!0,this.cleanupForNewFile(),this.showLoading();try{const t=this.extractFileIdFromUrl(e);if(!t)throw new Error("Invalid Google Drive URL. Please ensure it's a valid Drive file or folder link.");this.updateAuthStatus(),t.isFolder?await this.handleGoogleDriveFolder(t.id):await this.handleGoogleDriveFile(t.id)}catch(t){console.error("Google Drive error:",t),this.cleanupForNewFile(),t.message.includes("sign-in")||t.message.includes("auth")?this.showError('Please sign in to Google to access Drive files. Click "Analyze" to authenticate.'):this.showError(`Failed to process Google Drive: ${t.message}`)}finally{this.processingFile=!1}}}async handleGoogleDriveFile(e){const t=await this.googleAuth.downloadFile(e);this.currentFile=t;const i=await this.engine.analyzeFile(t);this.currentResults=i,this.setupAudioPlayer(t),this.validateAndDisplayResults(i),this.showResults()}async fetchScriptFiles(e){try{const i=(await this.googleAuth.listFilesInFolder(e,".txt")).map(a=>a.name.trim().replace(/\.txt$/i,""));return console.log(`Found ${i.length} script files:`,i),i}catch(t){throw console.error("Error fetching script files:",t),new Error("Failed to fetch script files. Check the scripts folder URL.")}}validateFilename(e,t,i){const a=e.trim(),s=a.replace(/\.wav$/i,"").split(`_${i}`)[0],r=`${s}_${i}.wav`;return t.includes(s)?a===r?{status:"pass",expectedFormat:r,issue:""}:{status:"fail",expectedFormat:`${s}_${i}.wav`,issue:"Incorrect filename for existing script"}:{status:"fail",expectedFormat:"-",issue:"No matching script file found"}}validateBilingualFilename(e){const t=[];e!==e.trim()&&t.push("Filename has leading or trailing whitespace"),/\s/.test(e)&&t.push("Filename contains whitespace characters");const i=/\.wav$/i.test(e);if(i||t.push("Filename must end with .wav extension"),i){const s=e.replace(/\.wav$/i,"");/\.\w+$/.test(s)&&t.push("Filename has multiple extensions (e.g., .mp3.wav or .wav.wav)")}const a=e.replace(/\.\w+$/i,"");if(a.startsWith("SPONTANEOUS_")){a.startsWith("SPONTANEOUS_")||t.push('Unscripted recordings must start with "SPONTANEOUS_" (all caps)');const s=a.match(/^SPONTANEOUS_(\d+)-(.+)$/);if(!s)return t.push("Invalid unscripted format: expected SPONTANEOUS_[number]-[LanguageCode]-user-[UserID]-agent-[AgentID]"),{status:"fail",expectedFormat:"SPONTANEOUS_[number]-[LanguageCode]-user-[UserID]-agent-[AgentID].wav",issue:t.join(`
`),isSpontaneous:!0};const r=s[1],c=s[2];c!==c.toLowerCase()&&t.push('All text after "SPONTANEOUS_[number]-" must be lowercase');const o=c.toLowerCase().split("-");if(o.length!==5)return t.push(`Invalid format: expected 5 parts after SPONTANEOUS_[number]-, got ${o.length}`),{status:"fail",expectedFormat:"SPONTANEOUS_[number]-[LanguageCode]-user-[UserID]-agent-[AgentID].wav",issue:t.join(`
`),isSpontaneous:!0};const d=o[0],h=o[1],u=o[2],m=o[3],n=o[4];return h!=="user"&&t.push(`Expected 'user' label, got '${h}'`),m!=="agent"&&t.push(`Expected 'agent' label, got '${m}'`),R.languageCodes.includes(d)||t.push(`Invalid language code: '${d}'`),R.contributorPairs.some(g=>g[0]===u&&g[1]===n||g[0]===n&&g[1]===u)||t.push(`Invalid contributor pair: user-${u}, agent-${n}`),t.length>0?{status:"fail",expectedFormat:"SPONTANEOUS_[number]-[LanguageCode]-user-[UserID]-agent-[AgentID].wav",issue:t.join(`
`),isSpontaneous:!0}:{status:"pass",expectedFormat:`SPONTANEOUS_${r}-${d}-user-${u}-agent-${n}.wav`,issue:"",isSpontaneous:!0}}else{a!==a.toLowerCase()&&t.push("Filename must be all lowercase");const s=a.toLowerCase().split("-");if(s.length!==6)return t.push(`Invalid format: expected 6 parts separated by '-', got ${s.length}`),{status:"fail",expectedFormat:"[ConversationID]-[LanguageCode]-user-[UserID]-agent-[AgentID].wav",issue:t.join(`
`),isSpontaneous:!1};const r=s[0],c=s[1],o=s[2],d=s[3],h=s[4],u=s[5];return o!=="user"&&t.push(`Expected 'user' label, got '${o}'`),h!=="agent"&&t.push(`Expected 'agent' label, got '${h}'`),R.languageCodes.includes(c)||t.push(`Invalid language code: '${c}'`),R.languageCodes.includes(c)&&((R.conversationsByLanguage[c]||[]).includes(r)||t.push(`Invalid conversation ID: '${r}' for language '${c}'`)),R.contributorPairs.some(y=>y[0]===d&&y[1]===u||y[0]===u&&y[1]===d)||t.push(`Invalid contributor pair: user-${d}, agent-${u}`),t.length>0?{status:"fail",expectedFormat:"[ConversationID]-[LanguageCode]-user-[UserID]-agent-[AgentID].wav",issue:t.join(`
`),isSpontaneous:!1}:{status:"pass",expectedFormat:`${r}-${c}-user-${d}-agent-${u}.wav`,issue:"",isSpontaneous:!1}}}async handleGoogleDriveFolder(e){const t=await this.googleAuth.listAudioFilesInFolder(e);if(t.length===0)throw new Error("No audio files found in this folder");console.log(`Found ${t.length} audio files in folder`);const i=this.getPresetConfigurations(),a=this.presetSelector.value,l=i[a],s=l==null?void 0:l.filenameValidationType;let r=[];if(this.enableFilenameValidation.checked&&s==="script-match"){const d=this.scriptsFolderUrl.value.trim();if(!this.speakerId.value.trim())throw new Error("Speaker ID is required for filename validation");if(d){const u=this.extractFolderId(d);if(u)r=await this.fetchScriptFiles(u);else throw new Error("Invalid scripts folder URL")}else throw new Error("Scripts folder URL is required for filename validation")}this.batchMode=!0,this.currentBatchSource="drive",this.batchResults=[],this.batchCancelled=!1,this.scriptBaseNames=r,this.currentValidationType=s,this.showBatchProgress(0,t.length,"Initializing..."),this.initializeBatchResultsTable();const c=3;let o=0;for(let d=0;d<t.length;d+=c){if(this.batchCancelled){console.log("Batch processing cancelled");break}const u=t.slice(d,d+c).map(async n=>{var y,f;if(this.batchCancelled)return null;try{const g=this.currentValidationType;let F,A=!1;const S=this.enableFilenameValidation.checked&&!this.enableAudioAnalysis.checked;if(S){const p=await this.googleAuth.getFileMetadata(n);console.log("Full metadata for",p.name,":",p),F={filename:p.name,fileSize:parseInt(p.size)||0,fileType:this.getFileTypeFromName(p.name),sampleRate:"Unknown",bitDepth:"Unknown",channels:"Unknown",duration:(y=p.videoMediaMetadata)!=null&&y.durationMillis?p.videoMediaMetadata.durationMillis/1e3:"Unknown"},A=!0}else{let I=null;for(let w=0;w<3;w++)try{const v=await this.googleAuth.downloadFileHeaders(n.id),k=parseInt(n.size)||v.size,B=new File([v],n.name,{type:n.mimeType,lastModified:new Date(n.modifiedTime).getTime()});Object.defineProperty(B,"size",{value:k,writable:!1}),F=await this.batchProcessor.analyzer.analyzeHeaders(B);break}catch(v){if(I=v,(v.message.includes("500")||v.message.includes("502")||v.message.includes("503")||v.message.includes("504"))&&w<2){const B=Math.min(1e3*Math.pow(2,w),5e3);console.log(`Retry ${w+1}/3 for ${n.name} after ${B}ms...`),await new Promise($=>setTimeout($,B))}else throw I}}(f=n.videoMediaMetadata)!=null&&f.durationMillis&&(F.duration=n.videoMediaMetadata.durationMillis/1e3);const x=C.validateResults(F,this.getCriteria(),S);let b=null;if(this.enableFilenameValidation.checked){if(g==="script-match"&&this.scriptBaseNames.length>0){const p=this.speakerId.value.trim();b=this.validateFilename(n.name,this.scriptBaseNames,p)}else g==="bilingual-pattern"&&(b=this.validateBilingualFilename(n.name));g==="bilingual-pattern"&&F&&F.duration&&n.name.replace(/\.\w+$/i,"").startsWith("SPONTANEOUS")&&F.duration>600&&(x||(x={}),x.duration={status:"warning",issue:`SPONTANEOUS recordings must be ≤10 minutes (current: ${Math.round(F.duration/60)} min)`})}return{filename:n.name,file:null,driveFileId:n.id,analysis:F,validation:x,filenameValidation:b,status:this.getOverallStatus(x,S,b),warning:A?"Limited analysis (Google Drive error)":null}}catch(g){return console.error(`Error processing ${n.name}:`,g),{filename:n.name,file:null,driveFileId:n.id,analysis:null,validation:null,status:"error",error:g.message}}});(await Promise.all(u)).forEach(n=>{n&&(this.batchResults.push(n),this.addBatchResultRow(n),o++,this.batchCancelled||this.showBatchProgress(o,t.length,n.filename))}),this.updateBatchSummary()}this.batchCancelled||(this.batchProgress.style.display="none")}extractFileIdFromUrl(e){const t=[/\/file\/d\/([a-zA-Z0-9-_]+)/,/\/folders\/([a-zA-Z0-9-_]+)/,/[?&]id=([a-zA-Z0-9-_]+)/,/^([a-zA-Z0-9-_]+)$/];for(const i of t){const a=e.match(i);if(a)return{id:a[1],isFolder:i===t[1]}}return null}extractFolderId(e){const t=e.match(/[-\w]{25,}/);return t?t[0]:null}async handleBoxUrl(){const e=this.boxUrl.value.trim();if(e){if(this.processingFile){console.log("Already processing a file, ignoring Box request");return}if(!this.boxAuth.isSignedIn()){await this.handleBoxSignIn();return}this.processingFile=!0,this.cleanupForNewFile(),this.showLoading();try{const t=this.extractBoxIdFromUrl(e);if(!t)throw new Error("Invalid Box URL. Please ensure it's a valid Box file or folder link.");this.currentBoxSharedLink=e,this.updateBoxAuthStatus();const i=null;t.isFolder?await this.handleBoxFolder(t.id,i):await this.handleBoxFile(t.id,i)}catch(t){console.error("Box error:",t),this.cleanupForNewFile(),t.message.includes("sign-in")||t.message.includes("auth")||t.message.includes("Session expired")?this.currentBoxSharedLink?this.showError(`Failed to access Box file: ${t.message}. The file may not be publicly shared.`):this.showError('Please sign in to Box to access files. Click "Analyze" to authenticate.'):this.showError(`Failed to process Box: ${t.message}`)}finally{this.processingFile=!1,this.currentBoxSharedLink=null}}}async handleBoxFile(e,t=null){const a=this.boxAnalysisTypeSection.style.display!=="none"&&this.boxEnableFilenameValidation.checked,l=a&&!this.boxEnableAudioAnalysis.checked,s=await this.boxAuth.getFileMetadata({id:e},t),r=s.name;let c=null;a&&(c=this.validateBilingualFilename(r));let o;if(l){o={filename:r,fileSize:parseInt(s.size)||0,fileType:this.getFileTypeFromName(r),sampleRate:"Unknown",bitDepth:"Unknown",channels:"Unknown",duration:"Unknown"},this.currentFile=null,this.currentResults=o;const d=this.getCriteria(),h=this.engine.validateCriteria(o,d),u=r.replace(/\.\w+$/i,"").startsWith("SPONTANEOUS");if(a&&u&&o&&o.duration&&o.duration!=="Unknown"){const n=o.duration;n>600&&(h||(h={}),h.duration={status:"warning",issue:`SPONTANEOUS recordings must be ≤10 minutes (current: ${Math.round(n/60)} min)`})}this.currentResults.validation=h,this.currentResults.filenameValidation=c,this.validateAndDisplayResults(o,c),this.showResults()}else{const d=await this.boxAuth.downloadFile(e,t);this.currentFile=d,o=await this.engine.analyzeFile(d),o&&s&&s.size&&(o.fileSize=s.size),this.currentResults=o,this.currentResults.filenameValidation=c,this.setupAudioPlayer(d),this.validateAndDisplayResults(o,c),this.showResults()}}async handleBoxFolder(e,t=null){const i=await this.boxAuth.listAudioFilesInFolder(e,t);if(i.length===0)throw new Error("No audio files found in the Box folder");this.batchMode=!0,this.currentBatchSource="box",this.batchCancelled=!1,this.showBatchProgress();const a=this.boxAnalysisTypeSection.style.display!=="none",l=a&&this.boxEnableFilenameValidation.checked&&!this.boxEnableAudioAnalysis.checked;try{this.batchResults=[];let s=0,r=0,c=0,o=0,d=0;this.initializeBatchResultsTable();for(let h=0;h<i.length;h++){if(this.batchCancelled){console.log("Batch processing cancelled by user");break}const u=i[h];this.showBatchProgress(h+1,i.length,u.name);try{let m=null,n=null;a&&this.boxEnableFilenameValidation.checked&&(n=this.validateBilingualFilename(u.name));let y=null;if(l)y=await this.boxAuth.getFileMetadata(u,t),m={filename:u.name,fileSize:parseInt(y.size)||0,fileType:this.getFileTypeFromName(u.name),sampleRate:"Unknown",bitDepth:"Unknown",channels:"Unknown",duration:"Unknown"};else{y=await this.boxAuth.getFileMetadata(u,t);const b=await this.boxAuth.downloadFileHeaders(u.id,102400,t),p=new File([b],u.name),I=parseInt(y.size)||p.size;Object.defineProperty(p,"size",{value:I,writable:!1}),m=await this.batchProcessor.analyzer.analyzeHeaders(p),m&&m.duration&&m.duration!=="Unknown"&&(d+=m.duration)}const f=this.getCriteria(),g=m?this.engine.validateCriteria(m,f):{},F=u.name.replace(/\.\w+$/i,"").startsWith("SPONTANEOUS");if(a&&F&&m&&m.duration&&m.duration!=="Unknown"){const b=m.duration;b>600&&(g||(g={}),g.duration={status:"warning",issue:`SPONTANEOUS recordings must be ≤10 minutes (current: ${Math.round(b/60)} min)`})}const S=this.getOverallStatus(g,l,n);S==="pass"?s++:S==="warning"?r++:S==="fail"&&c++;const x={name:u.name,filename:u.name,analysis:m,validation:g,filenameValidation:n,status:S,error:null,boxFileId:u.id};this.batchResults.push(x),this.addBatchResultRow(x)}catch(m){console.error(`Error processing ${u.name}:`,m),o++;const n={name:u.name,filename:u.name,analysis:null,validation:{},filenameValidation:null,status:"error",error:m.message};this.batchResults.push(n),this.addBatchResultRow(n)}}this.updateBatchSummary(s,r,c,o,d),this.batchCancelled||(this.batchProgress.style.display="none")}catch(s){console.error("Batch processing error:",s),this.showError(`Failed to process batch: ${s.message}`),this.cleanupForNewFile()}finally{this.processingFile=!1}}async fetchBoxScriptFiles(e,t=null){try{const a=(await this.boxAuth.listFilesInFolder(e,".txt",t)).map(l=>l.name.trim().replace(/\.txt$/i,""));return console.log(`Found ${a.length} Box script files:`,a),a}catch(i){throw console.error("Error fetching Box script files:",i),new Error("Failed to fetch script files. Check the scripts folder URL.")}}extractBoxIdFromUrl(e){const t=e.match(/\/s\/[^/]+\/file\/(\d+)/);if(t)return{id:t[1],isFolder:!1,sharedLink:e};const i=e.match(/\/s\/[^/]+\/folder\/(\d+)/);if(i)return{id:i[1],isFolder:!0,sharedLink:e};const a=[/\/file\/(\d+)/,/\/folder\/(\d+)/,/^(\d+)$/];for(const l of a){const s=e.match(l);if(s)return{id:s[1],isFolder:l===a[1],sharedLink:null}}return null}extractBoxFolderId(e){const t=e.match(/\/folder\/(\d+)/);return t?t[1]:null}setupAudioPlayer(e){const t=URL.createObjectURL(e);this.audioPlayer.src=t,this.audioPlayer.load(),this.playerSection.style.display="block"}togglePlayback(){this.audioPlayer.paused?(this.audioPlayer.play(),this.playPause.textContent="Pause"):(this.audioPlayer.pause(),this.playPause.textContent="Play")}validateAndDisplayResults(e,t=null){const i=this.getCriteria();let a=this.engine.validateCriteria(e,i);const l=this.getPresetConfigurations(),s=this.presetSelector.value,r=l[s],c=r==null?void 0:r.filenameValidationType,d=(this.currentFile?this.currentFile.name:e.filename||"").replace(/\.\w+$/i,"").startsWith("SPONTANEOUS");if(c==="bilingual-pattern"&&d&&e&&e.duration&&e.duration!=="Unknown"){const k=e.duration;k>600&&(a||(a={}),a.duration={status:"warning",issue:`SPONTANEOUS recordings must be ≤10 minutes (current: ${Math.round(k/60)} min)`})}const h=this.engine.formatResults(e),u=this.currentFile?this.currentFile.name:e.filename||"-",m=this.getOverallStatus(a,!1,t),n=this.getValidationStatus(a,"fileType",e.fileType),y=this.getValidationStatus(a,"sampleRate",e.sampleRate),f=this.getValidationStatus(a,"bitDepth",e.bitDepth),g=this.getValidationStatus(a,"channels",e.channels),F=this.getValidationStatus(a,"duration",e.duration);this.updateSingleFileColumnVisibility(i,t);const A=document.createElement("tr");A.className=`batch-row ${m}`;let S="";if(t){const k=t.status==="pass"?"✅":"❌";let B="";t.status==="pass"?B="Filename is valid":(B=t.issue,t.expectedFormat&&(B+=`

Expected: ${t.expectedFormat}`)),S=`<td class="filename-check-${t.status}" title="${B}">${k}</td>`}else S='<td style="display: none;"></td>';const x='<button class="play-btn-small" id="singleFilePlayBtn">▶</button>',b=N(u);A.innerHTML=`
      <td class="filename" title="${b}">${b}</td>
      <td><span class="status-badge ${m}">${m}</span></td>
      ${S}
      <td class="validation-${n}">${h.fileType||"Unknown"}</td>
      <td class="validation-${y}">${h.sampleRate||"-"}</td>
      <td class="validation-${f}">${h.bitDepth||"-"}</td>
      <td class="validation-${g}">${h.channels||"-"}</td>
      <td class="validation-${F}">${h.duration||"-"}</td>
      <td>${h.fileSize||"-"}</td>
      <td>${x}</td>
    `;const p=document.getElementById("singleTableBody");p.innerHTML="",p.appendChild(A);const I=A.querySelector("#singleFilePlayBtn");I&&I.addEventListener("click",()=>{this.togglePlayPause()});const w=A.querySelector(".filename-check-pass, .filename-check-fail");w&&this.setupFilenameCheckTooltip(w);const v=A.querySelector(".filename");v&&this.setupFilenameCheckTooltip(v)}updateSingleFileColumnVisibility(e,t){const i=document.getElementById("singleFilenameCheckHeader");i&&(i.style.display=t?"":"none"),["singleFormatHeader","singleSampleRateHeader","singleBitDepthHeader","singleChannelsHeader","singleDurationHeader"].forEach(l=>{const s=document.getElementById(l);s&&(s.style.display="")})}async runAdvancedAnalysis(){if(!this.audioBuffer&&this.currentFile)try{const e=await this.currentFile.arrayBuffer(),t=new(window.AudioContext||window.webkitAudioContext);this.audioBuffer=await t.decodeAudioData(e)}catch(e){this.showError(`Failed to decode audio: ${e.message}`);return}if(!this.audioBuffer){this.showError("No audio data available for analysis");return}this.isAnalyzing=!0,this.advancedAnalysisBtn.style.display="none",this.advancedProgress.style.display="block";try{const e=await this.engine.analyzeAdvanced(this.audioBuffer,(r,c)=>{this.progressText.textContent=r,this.progressFill.style.width=`${c*100}%`});document.getElementById("peakLevel").textContent=e.peakDb===-1/0?"-∞ dB":`${e.peakDb.toFixed(1)} dB`,document.getElementById("noiseFloor").textContent=e.noiseFloorDb===-1/0?"-∞ dB":`${e.noiseFloorDb.toFixed(1)} dB`,document.getElementById("noiseFloorHistogram").textContent=e.noiseFloorDbHistogram===-1/0?"-∞ dB":`${e.noiseFloorDbHistogram.toFixed(1)} dB`;const t=document.getElementById("normalization"),i=e.normalizationStatus;t.innerHTML=`${i.message}<br><small>Peak: ${i.peakDb.toFixed(1)}dB (Target: ${i.targetDb.toFixed(1)}dB)</small>`;const a=this.engine.analyzeStereoSeparation(this.audioBuffer),l=document.getElementById("stereoSeparation");a?l.innerHTML=`${a.stereoType}<br><small>(Confidence: ${Math.round(a.stereoConfidence*100)}%)</small>`:l.textContent="Not applicable (mono file)";const s=document.getElementById("reverbEstimation");e.reverbInfo&&e.reverbInfo.time>0?(s.innerHTML=`~${e.reverbInfo.time.toFixed(2)} s<br><small>${e.reverbInfo.label}</small>`,s.title=e.reverbInfo.description):(s.textContent="-",s.title=""),document.getElementById("leadingSilence").textContent=`${e.leadingSilence.toFixed(2)} s`,document.getElementById("trailingSilence").textContent=`${e.trailingSilence.toFixed(2)} s`,document.getElementById("longestSilence").textContent=`${e.longestSilence.toFixed(2)} s`,this.advancedResultsSection.style.display="block"}catch(e){e.message!=="Analysis cancelled"&&(console.error("Advanced analysis error:",e),this.showError(`Advanced analysis failed: ${e.message}`))}finally{this.isAnalyzing=!1,this.advancedProgress.style.display="none",this.advancedAnalysisBtn.style.display="block"}}cancelAdvancedAnalysis(){this.engine.cancelAdvancedAnalysis(),this.isAnalyzing=!1,this.advancedProgress.style.display="none",this.advancedAnalysisBtn.style.display="block"}cancelBatchProcessing(){this.batchCancelled=!0,this.batchProcessor.cancel(),this.batchProgress.style.display="none",this.batchProgressText.textContent="Processing cancelled"}showLoading(){this.hideAllSections(),this.loading.style.display="block"}showResults(){this.hideAllSections(),this.resultsSection.style.display="block";const e=document.getElementById("validationLegend");e&&(e.style.display="block")}showError(e){this.hideAllSections(),this.errorMessage.textContent=e,this.error.style.display="block"}showBatchProgress(e,t,i){this.batchProgress.style.display="block";const a=Math.round(e/t*100);this.batchProgressBar.style.width=`${a}%`,this.batchProgressText.textContent=`${e}/${t} (${a}%)`,this.batchCurrentFile.textContent=i||"Processing..."}initializeBatchResultsTable(){this.hideAllSections(),this.batchProgress.style.display="block",this.batchResultsSection.style.display="block",this.batchTableBody.innerHTML="";const e=this.getPresetConfigurations(),t=this.presetSelector.value,i=e[t],a=(i==null?void 0:i.supportsFilenameValidation)||!1,l=this.currentBatchSource==="box"?a&&this.boxEnableFilenameValidation.checked:this.currentBatchSource==="drive"?a&&this.enableFilenameValidation.checked:this.currentBatchSource==="local"?a&&this.localEnableFilenameValidation.checked:!1,s=this.currentBatchSource==="box"?this.boxEnableAudioAnalysis.checked:this.currentBatchSource==="drive"?this.enableAudioAnalysis.checked:this.currentBatchSource==="local"?this.localEnableAudioAnalysis.checked:!0,r=l&&!s,c=document.querySelector(".batch-results-table");c&&(r?c.classList.add("metadata-only"):c.classList.remove("metadata-only"));const o=document.getElementById("filenameCheckHeader");o&&(o.style.display=l?"":"none"),["sampleRateHeader","bitDepthHeader","channelsHeader","durationHeader"].forEach(u=>{const m=document.getElementById(u);m&&(m.style.display=r?"none":"")}),this.batchTotalDurationContainer&&(this.batchTotalDurationContainer.style.display=r?"none":""),this.batchPassCount.textContent="0",this.batchWarningCount.textContent="0",this.batchFailCount.textContent="0",this.batchErrorCount.textContent="0",this.batchTotalDuration.textContent="0h 0m";const h=document.getElementById("batchValidationLegend");h&&(h.style.display="block")}addBatchResultRow(e){var v,k,B,$,P,D,L,O;const t=this.getPresetConfigurations(),i=this.presetSelector.value,a=t[i],l=(a==null?void 0:a.supportsFilenameValidation)||!1,s=this.currentBatchSource==="box"?l&&this.boxEnableFilenameValidation.checked:this.currentBatchSource==="drive"?l&&this.enableFilenameValidation.checked:this.currentBatchSource==="local"?l&&this.localEnableFilenameValidation.checked:!1,r=this.currentBatchSource==="box"?this.boxEnableAudioAnalysis.checked:this.currentBatchSource==="drive"?this.enableAudioAnalysis.checked:this.currentBatchSource==="local"?this.localEnableAudioAnalysis.checked:!0;if(e.analysis&&!e.error){const V=this.getCriteria(),E=s&&!r,U=(B=(k=(v=e.validation)==null?void 0:v.duration)==null?void 0:k.issue)!=null&&B.includes("SPONTANEOUS")?e.validation.duration:null;e.validation=C.validateResults(e.analysis,V,E),E&&(e.validation.sampleRate&&(e.validation.sampleRate.status="unknown"),e.validation.bitDepth&&(e.validation.bitDepth.status="unknown"),e.validation.channels&&(e.validation.channels.status="unknown"),e.validation.duration&&(e.validation.duration.status="unknown")),U&&(e.validation.duration=U),e.status=this.getOverallStatus(e.validation,!1,e.filenameValidation)}const c=this.batchResults.length-1,o=document.createElement("tr");o.className=`batch-row ${e.status}`;const d=e.analysis?C.formatDisplayText(e.analysis):{},h=this.getValidationStatus(e.validation,"fileType",($=e.analysis)==null?void 0:$.fileType),u=this.getValidationStatus(e.validation,"sampleRate",(P=e.analysis)==null?void 0:P.sampleRate),m=this.getValidationStatus(e.validation,"bitDepth",(D=e.analysis)==null?void 0:D.bitDepth),n=this.getValidationStatus(e.validation,"channels",(L=e.analysis)==null?void 0:L.channels),y=this.getValidationStatus(e.validation,"duration",(O=e.analysis)==null?void 0:O.duration),f=s&&!r;let g="";if(s)if(e.filenameValidation){const V=e.filenameValidation.status==="pass"?"✅":"❌";let E="";e.filenameValidation.status==="pass"?E="Filename is valid":(E=e.filenameValidation.issue,e.filenameValidation.expectedFormat&&(E+=`

Expected: ${e.filenameValidation.expectedFormat}`)),g=`<td class="filename-check-${e.filenameValidation.status}" title="${E}">${V}</td>`}else g='<td style="display: none;"></td>';else g='<td style="display: none;"></td>';const F=f?"":`<td class="validation-${u}">${d.sampleRate||"-"}</td>`,A=f?"":`<td class="validation-${m}">${d.bitDepth||"-"}</td>`,S=f?"":`<td class="validation-${n}">${d.channels||"-"}</td>`,x=f?"":`<td class="validation-${y}">${d.duration||"-"}</td>`;let b="-";e.file||e.driveFileId?b=`<button class="play-btn-small" data-index="${c}">▶</button>`:e.boxFileId&&(b=`<a href="https://app.box.com/file/${e.boxFileId}" target="_blank" title="Open in Box" class="play-btn-small box-link">▶</a>`);const p=N(e.filename);if(o.innerHTML=`
      <td class="filename" title="${p}">${p}</td>
      <td><span class="status-badge ${e.status}">${e.status}</span></td>
      ${g}
      <td class="validation-${h}">${d.fileType||"Unknown"}</td>
      ${F}
      ${A}
      ${S}
      ${x}
      <td>${d.fileSize||"-"}</td>
      <td>${b}</td>
    `,this.batchTableBody.appendChild(o),e.file||e.driveFileId){const V=o.querySelector(".play-btn-small");V&&V.addEventListener("click",E=>{const U=parseInt(E.target.dataset.index);this.playBatchFile(U)})}const I=o.querySelector(".filename-check-pass, .filename-check-fail");I&&this.setupFilenameCheckTooltip(I);const w=o.querySelector(".filename");w&&this.setupFilenameCheckTooltip(w)}setupFilenameCheckTooltip(e){let t=null;e.addEventListener("mouseenter",i=>{const a=e.getAttribute("title");if(!a)return;e.removeAttribute("title"),e.dataset.originalTitle=a,t=document.createElement("div"),t.className="filename-tooltip",t.textContent=a,document.body.appendChild(t);const l=e.getBoundingClientRect();t.style.left=l.left+l.width/2+"px",t.style.top=l.bottom+5+"px"}),e.addEventListener("mouseleave",()=>{t&&(t.remove(),t=null),e.dataset.originalTitle&&e.setAttribute("title",e.dataset.originalTitle)})}updateBatchSummary(){const e=this.batchResults.filter(s=>s.status==="pass").length,t=this.batchResults.filter(s=>s.status==="warning").length,i=this.batchResults.filter(s=>s.status==="fail").length,a=this.batchResults.filter(s=>s.status==="error").length;this.batchPassCount.textContent=e,this.batchWarningCount.textContent=t,this.batchFailCount.textContent=i,this.batchErrorCount.textContent=a;const l=this.batchResults.filter(s=>s.status==="pass"||s.status==="warning").reduce((s,r)=>{var o;const c=(o=r.analysis)==null?void 0:o.duration;return typeof c=="number"&&!isNaN(c)?s+c:s},0);this.batchTotalDuration.textContent=this.formatTotalDuration(l)}showBatchResults(e){this.hideAllSections(),this.batchResultsSection.style.display="block";const t=e.filter(n=>n.status==="pass").length,i=e.filter(n=>n.status==="warning").length,a=e.filter(n=>n.status==="fail").length,l=e.filter(n=>n.status==="error").length;this.batchPassCount.textContent=t,this.batchWarningCount.textContent=i,this.batchFailCount.textContent=a,this.batchErrorCount.textContent=l;const s=e.filter(n=>n.status==="pass"||n.status==="warning").reduce((n,y)=>{var g;const f=(g=y.analysis)==null?void 0:g.duration;return typeof f=="number"&&!isNaN(f)?n+f:n},0);this.batchTotalDuration.textContent=this.formatTotalDuration(s);const r=this.getPresetConfigurations(),c=this.presetSelector.value,o=r[c],d=(o==null?void 0:o.supportsFilenameValidation)||!1,h=this.currentBatchSource==="box"?!1:this.currentBatchSource==="drive"?d&&this.enableFilenameValidation.checked:this.currentBatchSource==="local"?d&&this.localEnableFilenameValidation.checked:!1,u=this.currentBatchSource==="box"?this.boxEnableAudioAnalysis.checked:this.currentBatchSource==="drive"?this.enableAudioAnalysis.checked:this.currentBatchSource==="local"?this.localEnableAudioAnalysis.checked:!0,m=h&&!u;this.batchTableBody.innerHTML="",e.forEach((n,y)=>{var $,P,D,L,O;const f=document.createElement("tr");f.className=`batch-row ${n.status}`;const g=n.analysis?C.formatDisplayText(n.analysis):{},F=this.getValidationStatus(n.validation,"fileType",($=n.analysis)==null?void 0:$.fileType),A=this.getValidationStatus(n.validation,"sampleRate",(P=n.analysis)==null?void 0:P.sampleRate),S=this.getValidationStatus(n.validation,"bitDepth",(D=n.analysis)==null?void 0:D.bitDepth),x=this.getValidationStatus(n.validation,"channels",(L=n.analysis)==null?void 0:L.channels),b=this.getValidationStatus(n.validation,"duration",(O=n.analysis)==null?void 0:O.duration);let p="";if(h)if(n.filenameValidation){const V=n.filenameValidation.status==="pass"?"✅":"❌";let E="";n.filenameValidation.status==="pass"?E="Filename is valid":(E=n.filenameValidation.issue,n.filenameValidation.expectedFormat&&(E+=`

Expected: ${n.filenameValidation.expectedFormat}`)),p=`<td class="filename-check-${n.filenameValidation.status}" title="${E}">${V}</td>`}else p='<td style="display: none;"></td>';else p='<td style="display: none;"></td>';const I=m?"":`<td class="validation-${A}">${g.sampleRate||"-"}</td>`,w=m?"":`<td class="validation-${S}">${g.bitDepth||"-"}</td>`,v=m?"":`<td class="validation-${x}">${g.channels||"-"}</td>`,k=m?"":`<td class="validation-${b}">${g.duration||"-"}</td>`,B=N(n.filename);f.innerHTML=`
        <td class="filename" title="${B}">${B}</td>
        <td><span class="status-badge ${n.status}">${n.status}</span></td>
        ${p}
        <td class="validation-${F}">${g.fileType||"Unknown"}</td>
        ${I}
        ${w}
        ${v}
        ${k}
        <td>${g.fileSize||"-"}</td>
        <td><button class="play-btn-small" data-index="${y}">▶</button></td>
      `,this.batchTableBody.appendChild(f)}),this.batchResults=e,this.batchTableBody.querySelectorAll(".play-btn-small").forEach(n=>{n.addEventListener("click",y=>{const f=parseInt(y.target.dataset.index);this.playBatchFile(f)})}),this.batchTableBody.querySelectorAll(".filename").forEach(n=>{this.setupFilenameCheckTooltip(n)}),document.getElementById("batchValidationLegend").style.display="block"}formatValue(e){return e==null||e==="Unknown"?"-":e}formatDuration(e){if(!e||e==="Unknown")return"-";const t=Math.floor(e/60),i=Math.floor(e%60);return`${t}:${i.toString().padStart(2,"0")}`}formatTotalDuration(e){if(!e||e===0)return"0h 0m 0s";const t=Math.floor(e/3600),i=Math.floor(e%3600/60),a=Math.floor(e%60);return t>0?`${t}h ${i}m ${a}s`:i>0?`${i}m ${a}s`:`${a}s`}getValidationStatus(e,t,i){return e&&e[t]?e[t].status:i==="Unknown"?"warning":"pass"}playBatchFile(e){if(!this.batchResults||!this.batchResults[e])return;const t=this.batchResults[e];if(t.file){const i=URL.createObjectURL(t.file);window.open(i,"_blank"),setTimeout(()=>URL.revokeObjectURL(i),1e3)}else if(t.driveFileId){const i=`https://drive.google.com/file/d/${t.driveFileId}/view`;window.open(i,"_blank")}}revalidateBatchResults(){if(!this.batchResults)return;const e=this.getCriteria(),t=this.getPresetConfigurations(),i=this.presetSelector.value,a=t[i],l=(a==null?void 0:a.supportsFilenameValidation)||!1,s=this.currentBatchSource==="box"?l&&this.boxEnableFilenameValidation.checked:this.currentBatchSource==="drive"?l&&this.enableFilenameValidation.checked:this.currentBatchSource==="local"?l&&this.localEnableFilenameValidation.checked:!1,r=this.currentBatchSource==="box"?this.boxEnableAudioAnalysis.checked:this.currentBatchSource==="drive"?this.enableAudioAnalysis.checked:this.currentBatchSource==="local"?this.localEnableAudioAnalysis.checked:!0,c=s&&!r,o=document.getElementById("filenameCheckHeader");o&&(o.style.display=s?"":"none"),["sampleRateHeader","bitDepthHeader","channelsHeader","durationHeader"].forEach(h=>{const u=document.getElementById(h);u&&(u.style.display=c?"none":"")}),this.batchResults.forEach(h=>{h.analysis&&(h.validation=C.validateResults(h.analysis,e),h.status=this.getOverallStatus(h.validation,!1,h.filenameValidation))}),this.showBatchResults(this.batchResults)}getOverallStatus(e,t=!1,i=null){let a=Object.values(e).map(l=>l.status);if(t){const l=["sampleRate","bitDepth","channels"];a=Object.entries(e).filter(([s])=>!l.includes(s)).map(([,s])=>s.status)}return i&&i.status&&a.push(i.status),a.includes("fail")?"fail":a.includes("warning")?"warning":"pass"}getFileTypeFromName(e){const t=e.split(".").pop().toLowerCase();return{wav:"WAV",mp3:"MP3",flac:"FLAC",aac:"AAC",m4a:"M4A",ogg:"OGG"}[t]||t.toUpperCase()}cleanupForNewFile(){this.currentFile&&(this.currentFile=null),this.audioBuffer&&(this.audioBuffer=null),this.currentResults&&(this.currentResults=null),this.audioPlayer&&this.audioPlayer.src&&(this.audioPlayer.src.startsWith("blob:")&&URL.revokeObjectURL(this.audioPlayer.src),this.audioPlayer.src="")}cleanup(){this.cleanupForNewFile(),this.engine.audioAnalyzer.audioContext,window.gc&&typeof window.gc=="function"&&window.gc()}hideAllSections(){this.loading.style.display="none",this.error.style.display="none",this.resultsSection.style.display="none",this.advancedResultsSection.style.display="none",this.batchProgress.style.display="none",this.batchResultsSection.style.display="none",document.getElementById("validationLegend").style.display="none",document.getElementById("batchValidationLegend").style.display="none"}}document.addEventListener("DOMContentLoaded",()=>{const T=new q;window.addEventListener("beforeunload",()=>{T.cleanup()}),document.addEventListener("visibilitychange",()=>{document.hidden&&T.cleanup()})});
